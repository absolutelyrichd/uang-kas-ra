<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Uang Kas RA Tarbiyatul Aulad</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/jspdf-autotable@3.5.25/dist/jspdf.plugin.autotable.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chosen Palette: Warm Neutrals (Slate, Stone, Amber, with Emerald/Red for status) -->
    <!-- Application Structure Plan: A dashboard-style layout is chosen for optimal usability. It starts with high-level Key Performance Indicators (KPIs) like current balance for a quick overview. This is followed by visual charts (cashflow trend, income vs. expense) to provide deeper context and show performance over time. Finally, a tabbed section offers detailed, granular data (transaction history and payment status) without cluttering the main view. A new section for AI-powered insights has been added, allowing users to generate spending analyses and payment reminder drafts using the Gemini API, further enhancing data utility and task automation. New sections for member management and detailed transaction input are added, along with global save/delete options, all powered by Firebase persistence with Google login. -->
    <!-- Visualization & Content Choices:
        - Report Info: Final Saldo -> Goal: Inform -> Viz: KPI Card -> Interaction: None -> Justification: Most critical metric, needs immediate visibility -> Library/Method: HTML/Tailwind.
        - Report Info: Saldo over time -> Goal: Change -> Viz: Line Chart -> Interaction: Hover for tooltip -> Justification: Clearly shows financial health trend -> Library/Method: Chart.js (Canvas).
        - Report Info: Monthly Pemasukan vs. Pengeluaran -> Goal: Compare -> Viz: Bar Chart -> Interaction: Hover for tooltip -> Justification: Easy comparison of monthly financial activity -> Library/Method: Chart.js (Canvas).
        - Report Info: Cashflow log -> Goal: Organize -> Viz: Table -> Interaction: Search, Delete Transaction -> Justification: Allows users to find and manage specific transactions easily -> Library/Method: HTML/Tailwind + JS.
        - Report Info: Member payment status -> Goal: Organize/Compare -> Viz: Table/Grid -> Interaction: Filter by month, Add/Delete Member, **Automatic Payment Status Update based on payer and income transaction** -> Justification: Quick visual check of who has paid, with color-coding for clarity, and full member management, now automated for accuracy with improved input and simplified payment logic -> Library/Method: HTML/Tailwind + JS.
        - Report Info: Spending patterns from cashflow -> Goal: Inform/Analyze -> Viz: AI-generated text summary -> Interaction: Button click with month selection -> Justification: Provides qualitative insights into spending habits beyond raw numbers -> Library/Method: Gemini API (LLM).
        - Report Info: Unpaid members -> Goal: Act/Communicate -> Viz: AI-generated text draft -> Interaction: Button click -> Justification: Automates the creation of polite payment reminders, saving time -> Library/Method: Gemini API (LLM).
        - Report Info: All data persistence -> Goal: Store/Retrieve -> Viz: None -> Interaction: Download JSON, Upload JSON, Clear In-memory Data -> Justification: Essential for long-term data management and portability, now primarily via Firebase. -> Library/Method: Firebase Firestore + File (JSON) via JS Blob/FileReader.
        - Report Info: Detailed Transaction Input -> Goal: Record -> Viz: Form -> Interaction: Input fields, radio buttons, submit button, Payer dropdown -> Justification: Allows granular entry of financial activities with standardized payer selection -> Library/Method: HTML/Tailwind + JS.
    -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* slate-50 */
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            height: 350px;
            max-height: 400px;
        }
        @media (max-width: 768px) {
            .chart-container {
                height: 300px;
            }
        }
        .tab-button.active {
            border-color: #f59e0b; /* amber-500 */
            color: #f59e0b; /* amber-500 */
            font-weight: 600;
        }
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #f59e0b;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-left: 8px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        /* Modal styles for the transaction input form */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            width: 90%; /* Responsive width */
            max-width: 600px; /* Increased max-width for better form layout */
            text-align: left;
            position: relative;
        }
        .close-button {
            color: #aaa;
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 28px;
            font-weight: bold;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
    </style>
    <!-- Firebase SDKs - V9 Compatibility (for easier integration with existing code structure) -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
</head>
<body class="text-slate-800">

    <div class="container mx-auto p-4 md:p-8">

        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-slate-900">Uang Kas RA Tarbiyatul Aulad</h1>
            <p class="text-slate-500 mt-2">Semangat!</p>
            <!-- Firebase Login/Logout UI -->
            <div class="mt-4 flex flex-col sm:flex-row justify-center items-center gap-4">
                <div id="authStatus" class="text-slate-600 font-medium">Memuat status autentikasi...</div>
                <button id="signInButton" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out hidden">
                    Login dengan Google
                </button>
                <button id="signOutButton" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out hidden">
                    Logout
                </button>
            </div>
        </header>

        <main id="appContent" class="hidden"> <!-- Hidden until user logs in -->
            <!-- Section: Key Metrics -->
            <section id="kpi" class="mb-8">
                 <div class="grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-6">
                    <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                        <h3 class="text-slate-500 font-medium mb-2">Saldo Saat Ini</h3>
                        <p id="currentBalance" class="text-3xl font-bold text-slate-900">Rp 0</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                        <h3 class="text-slate-500 font-medium mb-2">Total Pemasukan</h3>
                        <p id="totalIncome" class="text-3xl font-bold text-emerald-600">Rp 0</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                        <h3 class="text-slate-500 font-medium mb-2">Total Pengeluaran</h3>
                        <p id="totalExpense" class="text-3xl font-bold text-red-600">Rp 0</p>
                    </div>
                </div>
            </section>

            <!-- Section: Visualizations -->
            <section id="visualizations" class="mb-8 grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-white p-4 md:p-6 rounded-xl border border-slate-200 shadow-sm">
                    <h3 class="text-lg font-semibold mb-1 text-slate-900">Tren Arus Kas (Saldo)</h3>
                    <p class="text-sm text-slate-500 mb-4">Grafik ini menunjukkan perubahan saldo kas dari waktu ke waktu, memberikan gambaran tentang kesehatan finansial secara keseluruhan.</p>
                    <div class="chart-container">
                        <canvas id="cashflowChart"></canvas>
                    </div>
                </div>
                <div class="bg-white p-4 md:p-6 rounded-xl border border-slate-200 shadow-sm">
                    <h3 class="text-lg font-semibold mb-1 text-slate-900">Pemasukan vs Pengeluaran Bulanan</h3>
                     <p class="text-sm text-slate-500 mb-4">Bandingkan total pemasukan dan pengeluaran setiap bulan untuk melihat pola aktivitas keuangan.</p>
                    <div class="chart-container">
                        <canvas id="monthlyComparisonChart"></canvas>
                    </div>
                </div>
            </section>

            <!-- Section: Detailed Data -->
            <section id="details" class="mb-8">
                <div class="bg-white rounded-xl border border-slate-200 shadow-sm">
                    <div class="border-b border-slate-200">
                        <nav class="flex space-x-2 p-2" aria-label="Tabs">
                            <button id="tab-transactions" class="tab-button active px-4 py-2 text-sm font-medium text-slate-600 rounded-lg border-b-2 border-transparent hover:text-amber-600 focus:outline-none">
                                Riwayat Transaksi
                            </button>
                            <button id="tab-payments" class="tab-button px-4 py-2 text-sm font-medium text-slate-600 rounded-lg border-b-2 border-transparent hover:text-amber-600 focus:outline-none">
                                Status Pembayaran Anggota
                            </button>
                            <!-- Tab "Input Transaksi Baru" dipindahkan ke dalam modal -->
                            <button id="tab-member-management" class="tab-button px-4 py-2 text-sm font-medium text-slate-600 rounded-lg border-b-2 border-transparent hover:text-amber-600 focus:outline-none">
                                Kelola Anggota
                            </button>
                        </nav>
                    </div>

                    <div id="content-transactions" class="p-4 md:p-6">
                        <h3 class="text-lg font-semibold mb-1 text-slate-900">Detail Semua Transaksi</h3>
                        <p class="text-sm text-slate-500 mb-4">Gunakan kolom pencarian dan filter untuk menemukan transaksi spesifik.</p>
                        <!-- Filter dan Tombol Tambah Transaksi -->
                        <div class="flex flex-col sm:flex-row items-center justify-between gap-4 mb-4">
                            <div class="flex items-center space-x-2 w-full sm:w-auto">
                                <label for="transactionFilterMonth" class="text-sm text-slate-700">Bulan:</label>
                                <select id="transactionFilterMonth" class="p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-400 focus:border-amber-400">
                                    <option value="">Semua Bulan</option>
                                    <option value="1">Januari</option>
                                    <option value="2">Februari</option>
                                    <option value="3">Maret</option>
                                    <option value="4">April</option>
                                    <option value="5">Mei</option>
                                    <option value="6">Juni</option>
                                    <option value="7">Juli</option>
                                    <option value="8">Agustus</option>
                                    <option value="9">September</option>
                                    <option value="10">Oktober</option>
                                    <option value="11">November</option>
                                    <option value="12">Desember</option>
                                </select>
                                <label for="transactionFilterYear" class="text-sm text-slate-700">Tahun:</label>
                                <select id="transactionFilterYear" class="p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-400 focus:border-amber-400">
                                    <!-- Options will be populated by JavaScript -->
                                </select>
                            </div>
                            <button id="openAddTransactionModal" class="bg-amber-500 hover:bg-amber-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out flex items-center justify-center w-full sm:w-auto">
                                Tambah Transaksi Baru
                            </button>
                        </div>
                        <input type="text" id="transactionSearch" placeholder="Cari transaksi..." class="w-full max-w-xs mb-4 p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-400 focus:border-amber-400">
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-slate-200">
                                <thead class="bg-slate-50">
                                    <tr>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Tanggal</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Keterangan</th>
                                        <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-slate-500 uppercase tracking-wider">Pemasukan</th>
                                        <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-slate-500 uppercase tracking-wider">Pengeluaran</th>
                                        <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-slate-500 uppercase tracking-wider">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="transactionTableBody" class="bg-white divide-y divide-slate-200">
                                    <!-- Rows will be inserted by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div id="content-payments" class="hidden p-4 md:p-6">
                        <h3 class="text-lg font-semibold mb-1 text-slate-900">Status Pembayaran Iuran Kas</h3>
                        <p class="text-sm text-slate-500 mb-4">Berikut adalah status pembayaran iuran kas per bulan untuk setiap anggota.</p>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-slate-200">
                                <thead class="bg-slate-50">
                                    <tr id="paymentTableHeader">
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider sticky left-0 bg-slate-50 z-10">Nama Anggota</th>
                                        <!-- Month headers will be inserted by JavaScript -->
                                    </tr>
                                </thead>
                                <tbody id="paymentTableBody" class="bg-white divide-y divide-slate-200">
                                    <!-- Rows will be inserted by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div id="content-member-management" class="hidden p-4 md:p-6">
                        <h3 class="text-lg font-semibold mb-1 text-slate-900">Kelola Anggota</h3>
                        <p class="text-sm text-slate-500 mb-4">Tambahkan, edit, atau hapus anggota yang akan membayar uang kas.</p>
                        <div class="mb-4 flex flex-col sm:flex-row gap-2">
                            <input type="text" id="newMemberName" placeholder="Nama Anggota Baru" class="flex-grow p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-400 focus:border-amber-400">
                            <button id="addMemberButton" class="bg-emerald-500 hover:bg-emerald-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out flex items-center justify-center">
                                Tambah Anggota
                                <span id="addMemberSpinner" class="loading-spinner hidden"></span>
                            </button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-slate-200">
                                <thead class="bg-slate-50">
                                    <tr>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Nama Anggota</th>
                                        <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-slate-500 uppercase tracking-wider">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="memberTableBody" class="bg-white divide-y divide-slate-200">
                                    <!-- Rows will be inserted by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Section: AI Insights & Assistance -->
            <section id="ai-insights" class="mb-8">
                <div class="bg-white p-4 md:p-6 rounded-xl border border-slate-200 shadow-sm">
                    <h2 class="text-xl font-semibold mb-4 text-slate-900">Insight & Bantuan AI</h2>
                    <p class="text-sm text-slate-500 mb-4">Manfaatkan kecerdasan buatan untuk mendapatkan analisis pengeluaran dan draf pengingat pembayaran.</p>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Spending Analysis -->
                        <div>
                            <h3 class="text-lg font-semibold mb-2 text-slate-900">Analisis Pengeluaran Bulanan</h3>
                            <p class="text-sm text-slate-500 mb-3">Pilih bulan untuk mendapatkan ringkasan pola pengeluaran utama Anda.</p>
                            <div class="flex items-center space-x-2 mb-4">
                                <select id="aiMonthFilter" class="p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-400 focus:border-amber-400">
                                    <!-- Options will be inserted by JavaScript -->
                                </select>
                                <button id="generateSpendingAnalysis" class="bg-amber-500 hover:bg-amber-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out flex items-center">
                                    Dapatkan Analisis Pengeluaran ✨
                                    <span id="spendingAnalysisSpinner" class="loading-spinner hidden"></span>
                                </button>
                            </div>
                            <div id="spendingAnalysisOutput" class="bg-slate-50 p-4 rounded-lg border border-slate-200 text-slate-700 min-h-[80px] flex items-center justify-center text-center">
                                <p class="text-slate-500">Hasil analisis akan muncul di sini.</p>
                            </div>
                        </div>
                        <!-- Payment Reminder Draft -->
                        <div>
                            <h3 class="text-lg font-semibold mb-2 text-slate-900">Draf Pengingat Pembayaran</h3>
                            <p class="text-sm text-slate-500 mb-3">Buat draf pesan pengingat untuk anggota yang belum membayar iuran pada bulan yang sedang dipilih di tab "Status Pembayaran".</p>
                            <button id="generatePaymentReminder" class="bg-emerald-500 hover:bg-emerald-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out flex items-center mb-4">
                                Buat Draf Pengingat ✨
                                <span id="paymentReminderSpinner" class="loading-spinner hidden"></span>
                            </button>
                            <div id="paymentReminderOutput" class="bg-slate-50 p-4 rounded-lg border border-slate-200 text-slate-700 min-h-[80px] flex items-center justify-center text-center">
                                <p class="text-slate-500">Draf pesan akan muncul di sini.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Section: Data Management (Export/Import) -->
            <section id="data-management" class="mb-8">
                <div class="bg-white p-4 md:p-6 rounded-xl border border-slate-200 shadow-sm">
                    <h2 class="text-xl font-semibold mb-4 text-slate-900">Manajemen Data</h2>
                    <p class="text-sm text-slate-500 mb-4">Kelola data Anda dengan mengimpor, mengekspor, atau menghapus data.</p>
                    <div class="flex flex-col sm:flex-row items-center gap-4">
                        <button id="exportDataButton" class="bg-slate-600 hover:bg-slate-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out w-full sm:w-auto">
                            Ekspor Data (JSON)
                        </button>
                        <input type="file" id="importDataInput" accept=".json" class="hidden">
                        <button id="importDataButton" class="bg-slate-400 hover:bg-slate-500 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out w-full sm:w-auto">
                            Impor Data (JSON)
                        </button>
                        <button id="clearDataButton" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out w-full sm:w-auto">
                            Hapus Semua Data
                        </button>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Modal for transaction input/edit -->
    <div id="transactionModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h3 id="modalTitle" class="text-lg font-semibold mb-4 text-slate-900">Tambah Transaksi Baru</h3>
            <form id="transactionForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="transactionDate" class="block text-sm font-medium text-slate-700">Tanggal</label>
                    <input type="date" id="transactionDate" class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-amber-500 focus:border-amber-500" required>
                </div>
                <div>
                    <label for="transactionDesc" class="block text-sm font-medium text-slate-700">Keterangan</label>
                    <input type="text" id="transactionDesc" placeholder="Contoh: Pembelian buku kas" class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-amber-500 focus:border-amber-500" required>
                </div>
                <div>
                    <label for="transactionAmount" class="block text-sm font-medium text-slate-700">Nominal (Rp)</label>
                    <input type="number" id="transactionAmount" placeholder="Contoh: 50000" class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-amber-500 focus:border-amber-500" required min="0">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700">Jenis Transaksi</label>
                    <div class="mt-1 flex items-center space-x-4">
                        <label class="inline-flex items-center">
                            <input type="radio" name="transactionType" value="pemasukan" class="form-radio text-emerald-600" checked>
                            <span class="ml-2 text-slate-700">Pemasukan</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="radio" name="transactionType" value="pengeluaran" class="form-radio text-red-600">
                            <span class="ml-2 text-slate-700">Pengeluaran</span>
                        </label>
                    </div>
                </div>
                <div class="md:col-span-2">
                    <label for="transactionWho" class="block text-sm font-medium text-slate-700">Penyetor / Pengambil</label>
                    <select id="transactionWho" class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-amber-500 focus:border-amber-500">
                        <option value="">Pilih Anggota (Opsional)</option>
                        <!-- Options will be populated by JavaScript -->
                    </select>
                </div>
                <!-- New fields for multi-month payment -->
                <div class="md:col-span-2">
                    <label for="paymentPeriodStartMonth" class="block text-sm font-medium text-slate-700">Pembayaran Untuk Bulan (Mulai)</label>
                    <select id="paymentPeriodStartMonth" class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-amber-500 focus:border-amber-500">
                        <option value="">Pilih Bulan (Opsional)</option>
                        <!-- Options will be populated by JavaScript -->
                    </select>
                </div>
                <div class="md:col-span-2">
                    <label for="paymentPeriodEndMonth" class="block text-sm font-medium text-slate-700">Pembayaran Untuk Bulan (Akhir)</label>
                    <select id="paymentPeriodEndMonth" class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-amber-500 focus:border-amber-500">
                        <option value="">Pilih Bulan (Opsional)</option>
                        <!-- Options will be populated by JavaScript -->
                    </select>
                </div>
                <!-- End new fields -->
                <div class="md:col-span-2 flex justify-end gap-2">
                    <button type="submit" id="submitTransactionButton" class="bg-amber-500 hover:bg-amber-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out flex items-center">
                        Tambah Transaksi
                        <span id="addTransactionSpinner" class="loading-spinner hidden"></span>
                    </button>
                    <button type="button" id="deleteTransactionButton" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out hidden">
                        Hapus Transaksi
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal for confirmation dialogs -->
    <div id="confirmationModal" class="modal">
        <div class="modal-content text-center">
            <h3 id="confirmationMessage" class="text-lg font-semibold mb-4 text-slate-900">Apakah Anda yakin?</h3>
            <div class="flex justify-center gap-4">
                <button id="confirmButton" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg">Ya</button>
                <button id="cancelButton" class="bg-slate-400 hover:bg-slate-500 text-white font-semibold py-2 px-4 rounded-lg">Batal</button>
            </div>
        </div>
    </div>

    <!-- Firebase Configuration and Main Application Logic -->
    <script>
        // Global variables for Firebase
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Initialize Firebase
        let app, db, auth;
        let unsubscribeTransactions = null;
        let unsubscribeMembers = null;

        if (Object.keys(firebaseConfig).length) {
            try {
                app = firebase.initializeApp(firebaseConfig);
                auth = app.auth();
                db = app.firestore();
                console.log("Firebase initialized.");
            } catch (error) {
                console.error("Firebase initialization error:", error);
            }
        } else {
            console.warn("Firebase config not found. Data persistence will be disabled.");
        }

        const authStatus = document.getElementById('authStatus');
        const signInButton = document.getElementById('signInButton');
        const signOutButton = document.getElementById('signOutButton');
        const appContent = document.getElementById('appContent');
        const currentBalanceEl = document.getElementById('currentBalance');
        const totalIncomeEl = document.getElementById('totalIncome');
        const totalExpenseEl = document.getElementById('totalExpense');

        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('[id^="content-"]');

        const transactionTableBody = document.getElementById('transactionTableBody');
        const transactionSearch = document.getElementById('transactionSearch');
        const memberTableBody = document.getElementById('memberTableBody');
        const newMemberNameInput = document.getElementById('newMemberName');
        const addMemberButton = document.getElementById('addMemberButton');
        const addMemberSpinner = document.getElementById('addMemberSpinner');

        const transactionModal = document.getElementById('transactionModal');
        const modalTitle = document.getElementById('modalTitle');
        const closeButton = transactionModal.querySelector('.close-button');
        const openAddTransactionModal = document.getElementById('openAddTransactionModal');
        const transactionForm = document.getElementById('transactionForm');
        const submitTransactionButton = document.getElementById('submitTransactionButton');
        const deleteTransactionButton = document.getElementById('deleteTransactionButton');
        const addTransactionSpinner = document.getElementById('addTransactionSpinner');

        const transactionDateInput = document.getElementById('transactionDate');
        const transactionDescInput = document.getElementById('transactionDesc');
        const transactionAmountInput = document.getElementById('transactionAmount');
        const transactionWhoSelect = document.getElementById('transactionWho');
        const transactionTypeRadios = document.querySelectorAll('input[name="transactionType"]');
        const paymentPeriodStartMonthSelect = document.getElementById('paymentPeriodStartMonth');
        const paymentPeriodEndMonthSelect = document.getElementById('paymentPeriodEndMonth');
        let isEditMode = false;
        let currentEditingTransactionId = null;

        const confirmationModal = document.getElementById('confirmationModal');
        const confirmationMessage = document.getElementById('confirmationMessage');
        const confirmButton = document.getElementById('confirmButton');
        const cancelButton = document.getElementById('cancelButton');
        let confirmationAction = null;

        const transactionFilterMonth = document.getElementById('transactionFilterMonth');
        const transactionFilterYear = document.getElementById('transactionFilterYear');

        const months = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
        const monthsMap = {
            "Januari": 0, "Februari": 1, "Maret": 2, "April": 3, "Mei": 4, "Juni": 5,
            "Juli": 6, "Agustus": 7, "September": 8, "Oktober": 9, "November": 10, "Desember": 11
        };

        let cashflowChart, monthlyComparisonChart;
        let allTransactions = [];
        let allMembers = [];

        // Helper function to format currency
        const formatRupiah = (number) => {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            }).format(number);
        };

        // Helper function to show a custom modal for confirmations
        const showConfirmationModal = (message, action) => {
            confirmationMessage.textContent = message;
            confirmationAction = action;
            confirmationModal.style.display = 'flex';
        };

        // Show/Hide Modals
        const openModal = (modalId) => {
            document.getElementById(modalId).style.display = 'flex';
        };
        const closeModal = (modalId) => {
            document.getElementById(modalId).style.display = 'none';
        };

        // Populate month and year dropdowns for filters and transaction form
        const populateMonthAndYearDropdowns = () => {
            // Transaction Form: payment months
            const currentMonthIndex = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            
            paymentPeriodStartMonthSelect.innerHTML = '<option value="">Pilih Bulan (Opsional)</option>';
            paymentPeriodEndMonthSelect.innerHTML = '<option value="">Pilih Bulan (Opsional)</option>';
            
            for (let i = 0; i < 12; i++) {
                const year = (i < currentMonthIndex) ? currentYear + 1 : currentYear;
                const monthName = months[i];
                const option = `<option value="${i + 1}-${year}">${monthName} ${year}</option>`;
                paymentPeriodStartMonthSelect.innerHTML += option;
                paymentPeriodEndMonthSelect.innerHTML += option;
            }

            // Transaction Filter: years
            const years = new Set(allTransactions.map(t => new Date(t.date).getFullYear()));
            const sortedYears = Array.from(years).sort((a, b) => b - a);
            
            transactionFilterYear.innerHTML = '<option value="">Semua Tahun</option>';
            sortedYears.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                transactionFilterYear.appendChild(option);
            });
        };

        // Render functions
        const renderKPIs = () => {
            const totalIncome = allTransactions.filter(t => t.type === 'pemasukan').reduce((sum, t) => sum + t.amount, 0);
            const totalExpense = allTransactions.filter(t => t.type === 'pengeluaran').reduce((sum, t) => sum + t.amount, 0);
            const currentBalance = totalIncome - totalExpense;

            currentBalanceEl.textContent = formatRupiah(currentBalance);
            totalIncomeEl.textContent = formatRupiah(totalIncome);
            totalExpenseEl.textContent = formatRupiah(totalExpense);
        };

        const renderCharts = () => {
            // Re-use chart instances or create new ones
            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'top' },
                    tooltip: { mode: 'index', intersect: false }
                }
            };

            const sortedTransactions = [...allTransactions].sort((a, b) => new Date(a.date) - new Date(b.date));
            const dates = sortedTransactions.map(t => t.date);
            let cumulativeBalance = 0;
            const balanceData = sortedTransactions.map(t => {
                if (t.type === 'pemasukan') {
                    cumulativeBalance += t.amount;
                } else {
                    cumulativeBalance -= t.amount;
                }
                return cumulativeBalance;
            });

            if (cashflowChart) cashflowChart.destroy();
            cashflowChart = new Chart(document.getElementById('cashflowChart'), {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'Saldo Kas',
                        data: balanceData,
                        borderColor: '#f59e0b',
                        backgroundColor: 'rgba(245, 158, 11, 0.2)',
                        fill: true,
                        tension: 0.1
                    }]
                },
                options: chartOptions
            });

            const monthlyData = {};
            sortedTransactions.forEach(t => {
                const monthYear = new Date(t.date).toLocaleString('id-ID', { month: 'long', year: 'numeric' });
                if (!monthlyData[monthYear]) {
                    monthlyData[monthYear] = { income: 0, expense: 0 };
                }
                if (t.type === 'pemasukan') {
                    monthlyData[monthYear].income += t.amount;
                } else {
                    monthlyData[monthYear].expense += t.amount;
                }
            });

            const monthlyLabels = Object.keys(monthlyData);
            const monthlyIncomeData = monthlyLabels.map(label => monthlyData[label].income);
            const monthlyExpenseData = monthlyLabels.map(label => monthlyData[label].expense);

            if (monthlyComparisonChart) monthlyComparisonChart.destroy();
            monthlyComparisonChart = new Chart(document.getElementById('monthlyComparisonChart'), {
                type: 'bar',
                data: {
                    labels: monthlyLabels,
                    datasets: [
                        {
                            label: 'Pemasukan',
                            data: monthlyIncomeData,
                            backgroundColor: '#10b981'
                        },
                        {
                            label: 'Pengeluaran',
                            data: monthlyExpenseData,
                            backgroundColor: '#ef4444'
                        }
                    ]
                },
                options: chartOptions
            });
        };

        const renderTransactionTable = (transactionsToRender) => {
            transactionTableBody.innerHTML = '';
            if (transactionsToRender.length === 0) {
                const row = transactionTableBody.insertRow();
                row.innerHTML = `<td colspan="5" class="px-6 py-4 text-center text-slate-500">Tidak ada transaksi.</td>`;
                return;
            }
            transactionsToRender.forEach(transaction => {
                const row = transactionTableBody.insertRow();
                const formattedDate = new Date(transaction.date).toLocaleDateString('id-ID', { year: 'numeric', month: 'long', day: 'numeric' });
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${formattedDate}</td>
                    <td class="px-6 py-4 whitespace-normal text-sm font-medium text-slate-900">${transaction.description}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-right text-emerald-600">${transaction.type === 'pemasukan' ? formatRupiah(transaction.amount) : '-'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-right text-red-600">${transaction.type === 'pengeluaran' ? formatRupiah(transaction.amount) : '-'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button data-id="${transaction.id}" class="edit-transaction-btn text-amber-600 hover:text-amber-900">Edit</button>
                    </td>
                `;
            });
        };

        const renderPaymentStatusTable = () => {
            const paymentTableHeader = document.getElementById('paymentTableHeader');
            const paymentTableBody = document.getElementById('paymentTableBody');
            
            // Clear previous content
            paymentTableHeader.innerHTML = `<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider sticky left-0 bg-slate-50 z-10">Nama Anggota</th>`;
            paymentTableBody.innerHTML = '';

            const today = new Date();
            const currentYear = today.getFullYear();
            const currentMonth = today.getMonth();

            // Create month headers for the current year
            const paymentMonthHeaders = [];
            for (let i = 0; i < 12; i++) {
                const monthName = months[i];
                const th = document.createElement('th');
                th.scope = 'col';
                th.className = 'px-6 py-3 text-center text-xs font-medium text-slate-500 uppercase tracking-wider';
                th.textContent = monthName;
                paymentMonthHeaders.push(th);
            }
            paymentMonthHeaders.forEach(th => paymentTableHeader.appendChild(th));

            // Create table rows for each member
            allMembers.forEach(member => {
                const row = paymentTableBody.insertRow();
                // Member name column
                const nameCell = row.insertCell();
                nameCell.className = 'px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-900 sticky left-0 bg-white z-10';
                nameCell.textContent = member.name;

                // Month status cells
                for (let i = 0; i < 12; i++) {
                    const monthCell = row.insertCell();
                    monthCell.className = 'px-6 py-4 whitespace-nowrap text-sm text-center';
                    const hasPaid = allTransactions.some(t =>
                        t.payerId === member.id &&
                        new Date(t.date).getFullYear() === currentYear &&
                        new Date(t.date).getMonth() === i
                    );
                    if (hasPaid) {
                        monthCell.innerHTML = `<span class="text-emerald-500">&#10003;</span>`; // Checkmark
                    } else {
                        monthCell.innerHTML = `<span class="text-red-500">&times;</span>`; // X mark
                    }
                }
            });
        };

        const renderMemberTable = () => {
            memberTableBody.innerHTML = '';
            allMembers.forEach(member => {
                const row = memberTableBody.insertRow();
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-900">${member.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button data-id="${member.id}" class="delete-member-btn text-red-600 hover:text-red-900">Hapus</button>
                    </td>
                `;
            });
        };

        const renderTransactionMemberOptions = () => {
            transactionWhoSelect.innerHTML = '<option value="">Pilih Anggota (Opsional)</option>';
            allMembers.forEach(member => {
                const option = document.createElement('option');
                option.value = member.id;
                option.textContent = member.name;
                transactionWhoSelect.appendChild(option);
            });
        };

        const renderAllUI = () => {
            renderKPIs();
            renderCharts();
            renderTransactionTable(allTransactions);
            renderPaymentStatusTable();
            renderMemberTable();
            renderTransactionMemberOptions();
            populateMonthAndYearDropdowns();
        };
        
        // Data Handlers
        const handleTransactionFormSubmit = async (e) => {
            e.preventDefault();

            const date = transactionDateInput.value;
            const description = transactionDescInput.value;
            const amount = parseInt(transactionAmountInput.value);
            const type = document.querySelector('input[name="transactionType"]:checked').value;
            const who = transactionWhoSelect.value;
            const startMonthPeriod = paymentPeriodStartMonthSelect.value;
            const endMonthPeriod = paymentPeriodEndMonthSelect.value;

            if (isNaN(amount) || amount <= 0) {
                console.error("Nominal harus lebih besar dari 0.");
                return;
            }

            // Show spinner
            addTransactionSpinner.classList.remove('hidden');
            submitTransactionButton.disabled = true;

            try {
                const transactionData = {
                    date: date,
                    description: description,
                    amount: amount,
                    type: type,
                    payerId: who || null,
                    startMonthPeriod: startMonthPeriod || null,
                    endMonthPeriod: endMonthPeriod || null,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                const userId = auth.currentUser.uid;
                const transactionsRef = db.collection(`artifacts/${appId}/users/${userId}/transactions`);

                if (isEditMode) {
                    // Update existing transaction
                    await transactionsRef.doc(currentEditingTransactionId).update(transactionData);
                    console.log("Transaksi berhasil diubah.");
                } else {
                    // Add new transaction
                    await transactionsRef.add(transactionData);
                    console.log("Transaksi berhasil ditambahkan.");
                }

                closeModal('transactionModal');
                transactionForm.reset();
                isEditMode = false;
                currentEditingTransactionId = null;

            } catch (error) {
                console.error("Error adding/updating transaction: ", error);
            } finally {
                // Hide spinner
                addTransactionSpinner.classList.add('hidden');
                submitTransactionButton.disabled = false;
            }
        };

        const handleAddMember = async () => {
            const memberName = newMemberNameInput.value.trim();
            if (!memberName) {
                console.error("Nama anggota tidak boleh kosong.");
                return;
            }

            // Show spinner
            addMemberSpinner.classList.remove('hidden');
            addMemberButton.disabled = true;

            try {
                const userId = auth.currentUser.uid;
                const memberRef = db.collection(`artifacts/${appId}/users/${userId}/members`);
                await memberRef.add({
                    name: memberName,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                newMemberNameInput.value = '';
                console.log("Anggota berhasil ditambahkan.");
            } catch (error) {
                console.error("Error adding member: ", error);
            } finally {
                // Hide spinner
                addMemberSpinner.classList.add('hidden');
                addMemberButton.disabled = false;
            }
        };

        const handleDeleteMember = async (memberId) => {
            try {
                const userId = auth.currentUser.uid;
                const memberRef = db.collection(`artifacts/${appId}/users/${userId}/members`).doc(memberId);
                await memberRef.delete();
                console.log("Anggota berhasil dihapus.");
            } catch (error) {
                console.error("Error deleting member: ", error);
            }
        };

        const handleDeleteTransaction = async (transactionId) => {
            try {
                const userId = auth.currentUser.uid;
                const transactionRef = db.collection(`artifacts/${appId}/users/${userId}/transactions`).doc(transactionId);
                await transactionRef.delete();
                console.log("Transaksi berhasil dihapus.");
                closeModal('transactionModal');
            } catch (error) {
                console.error("Error deleting transaction: ", error);
            }
        };

        const openEditModal = (transactionId) => {
            const transaction = allTransactions.find(t => t.id === transactionId);
            if (!transaction) return;

            isEditMode = true;
            currentEditingTransactionId = transactionId;
            modalTitle.textContent = 'Edit Transaksi';
            submitTransactionButton.textContent = 'Simpan Perubahan';
            deleteTransactionButton.classList.remove('hidden');

            transactionDateInput.value = transaction.date;
            transactionDescInput.value = transaction.description;
            transactionAmountInput.value = transaction.amount;
            document.querySelector(`input[name="transactionType"][value="${transaction.type}"]`).checked = true;
            transactionWhoSelect.value = transaction.payerId || '';
            paymentPeriodStartMonthSelect.value = transaction.startMonthPeriod || '';
            paymentPeriodEndMonthSelect.value = transaction.endMonthPeriod || '';

            openModal('transactionModal');
        };

        const resetTransactionForm = () => {
            transactionForm.reset();
            isEditMode = false;
            currentEditingTransactionId = null;
            modalTitle.textContent = 'Tambah Transaksi Baru';
            submitTransactionButton.textContent = 'Tambah Transaksi';
            deleteTransactionButton.classList.add('hidden');
        };

        const filterTransactions = () => {
            const searchQuery = transactionSearch.value.toLowerCase();
            const selectedMonth = transactionFilterMonth.value;
            const selectedYear = transactionFilterYear.value;

            const filtered = allTransactions.filter(transaction => {
                const transactionDate = new Date(transaction.date);
                const transactionMonth = transactionDate.getMonth() + 1;
                const transactionYear = transactionDate.getFullYear();
                
                const matchesSearch = transaction.description.toLowerCase().includes(searchQuery);
                const matchesMonth = selectedMonth ? transactionMonth === parseInt(selectedMonth) : true;
                const matchesYear = selectedYear ? transactionYear === parseInt(selectedYear) : true;
                
                return matchesSearch && matchesMonth && matchesYear;
            });

            renderTransactionTable(filtered);
        };
        
        // Event Listeners
        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                tabButtons.forEach(btn => btn.classList.remove('active'));
                tabContents.forEach(content => content.classList.add('hidden'));

                button.classList.add('active');
                document.getElementById('content-' + button.id.split('-')[1]).classList.remove('hidden');
            });
        });

        if (signInButton) {
            signInButton.addEventListener('click', async () => {
                // In this context, we will not be using a full sign-in flow.
                // We will rely on the provided custom token.
                console.log("Sign-in button clicked, but relying on custom token.");
            });
        }
        if (signOutButton) {
            signOutButton.addEventListener('click', async () => {
                try {
                    await auth.signOut();
                    console.log("User signed out.");
                } catch (error) {
                    console.error("Error signing out:", error);
                }
            });
        }

        if (transactionForm) {
            transactionForm.addEventListener('submit', handleTransactionFormSubmit);
        }
        
        if (openAddTransactionModal) {
            openAddTransactionModal.addEventListener('click', () => {
                resetTransactionForm();
                openModal('transactionModal');
            });
        }
        
        if (closeButton) {
            closeButton.addEventListener('click', () => {
                closeModal('transactionModal');
            });
        }

        window.addEventListener('click', (event) => {
            if (event.target === transactionModal) {
                closeModal('transactionModal');
            }
            if (event.target === confirmationModal) {
                closeModal('confirmationModal');
            }
        });

        // Event listener for edit buttons
        transactionTableBody.addEventListener('click', (e) => {
            if (e.target.classList.contains('edit-transaction-btn')) {
                const transactionId = e.target.dataset.id;
                openEditModal(transactionId);
            }
        });

        if (deleteTransactionButton) {
            deleteTransactionButton.addEventListener('click', () => {
                showConfirmationModal("Apakah Anda yakin ingin menghapus transaksi ini?", () => {
                    handleDeleteTransaction(currentEditingTransactionId);
                });
            });
        }

        if (addMemberButton) {
            addMemberButton.addEventListener('click', handleAddMember);
        }
        
        if (memberTableBody) {
            memberTableBody.addEventListener('click', (e) => {
                if (e.target.classList.contains('delete-member-btn')) {
                    const memberId = e.target.dataset.id;
                    showConfirmationModal("Apakah Anda yakin ingin menghapus anggota ini? Ini tidak akan menghapus riwayat transaksinya.", () => {
                        handleDeleteMember(memberId);
                    });
                }
            });
        }

        if (confirmButton) {
            confirmButton.addEventListener('click', () => {
                if (confirmationAction) {
                    confirmationAction();
                }
                closeModal('confirmationModal');
            });
        }

        if (cancelButton) {
            cancelButton.addEventListener('click', () => {
                closeModal('confirmationModal');
            });
        }

        if (transactionSearch) {
            transactionSearch.addEventListener('keyup', filterTransactions);
        }

        if (transactionFilterMonth) {
            transactionFilterMonth.addEventListener('change', filterTransactions);
        }

        if (transactionFilterYear) {
            transactionFilterYear.addEventListener('change', filterTransactions);
        }
        
        // Main logic
        const setupFirebaseListeners = (userId) => {
            if (!db || !userId) return;

            // Unsubscribe from previous listeners if they exist
            if (unsubscribeTransactions) unsubscribeTransactions();
            if (unsubscribeMembers) unsubscribeMembers();

            const transactionsRef = db.collection(`artifacts/${appId}/users/${userId}/transactions`);
            const membersRef = db.collection(`artifacts/${appId}/users/${userId}/members`);

            // Listen for real-time updates to transactions
            unsubscribeTransactions = transactionsRef.orderBy('createdAt', 'desc').onSnapshot(snapshot => {
                allTransactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAllUI();
            }, error => {
                console.error("Error getting transactions: ", error);
            });

            // Listen for real-time updates to members
            unsubscribeMembers = membersRef.orderBy('createdAt', 'desc').onSnapshot(snapshot => {
                allMembers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAllUI();
            }, error => {
                console.error("Error getting members: ", error);
            });
        };

        if (auth && initialAuthToken) {
            auth.signInWithCustomToken(initialAuthToken)
                .then((userCredential) => {
                    console.log("Signed in with custom token:", userCredential.user.uid);
                })
                .catch((error) => {
                    console.error("Error signing in with custom token:", error);
                });
        } else if (auth) {
             auth.signInAnonymously()
                .then(() => {
                    console.log("Signed in anonymously.");
                })
                .catch((error) => {
                    console.error("Error signing in anonymously:", error);
                });
        }

        if (auth) {
            auth.onAuthStateChanged(user => {
                if (user) {
                    authStatus.textContent = `Masuk sebagai: ${user.uid}`;
                    signInButton.classList.add('hidden');
                    signOutButton.classList.remove('hidden');
                    appContent.classList.remove('hidden');
                    setupFirebaseListeners(user.uid);
                    console.log("User UID:", user.uid);
                } else {
                    authStatus.textContent = "Tidak ada pengguna yang masuk.";
                    signInButton.classList.remove('hidden');
                    signOutButton.classList.add('hidden');
                    appContent.classList.add('hidden');
                    // Clear data and unsubscribe from listeners if user logs out
                    allTransactions = [];
                    allMembers = [];
                    renderAllUI();
                    if (unsubscribeTransactions) unsubscribeTransactions();
                    if (unsubscribeMembers) unsubscribeMembers();
                    console.log("User signed out or not logged in.");
                }
            });
        }

    </script>
</body>
</html>
