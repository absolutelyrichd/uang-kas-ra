<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Uang Kas RA Tarbiyatul Aulad</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/jspdf-autotable@3.5.25/dist/jspdf.plugin.autotable.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chosen Palette: Warm Neutrals (Slate, Stone, Amber, with Emerald/Red for status) -->
    <!-- Application Structure Plan: A dashboard-style layout is chosen for optimal usability. It starts with high-level Key Performance Indicators (KPIs) like current balance for a quick overview. This is followed by visual charts (cashflow trend, income vs. expense) to provide deeper context and show performance over time. Finally, a tabbed section offers detailed, granular data (transaction history and payment status) without cluttering the main view. A new section for AI-powered insights has1 been added, allowing users to generate spending analyses and payment reminder drafts using the Gemini API, further enhancing data utility and task automation. New sections for member management and detailed transaction input are added, along with global save/delete options, all powered by Firebase persistence with Google login. -->
    <!-- Visualization & Content Choices:
        - Report Info: Final Saldo -> Goal: Inform -> Viz: KPI Card -> Interaction: None -> Justification: Most critical metric, needs immediate visibility -> Library/Method: HTML/Tailwind.
        - Report Info: Saldo over time -> Goal: Change -> Viz: Line Chart -> Interaction: Hover for tooltip -> Justification: Clearly shows financial health trend -> Library/Method: Chart.js (Canvas).
        - Report Info: Monthly Pemasukan vs. Pengeluaran -> Goal: Compare -> Viz: Bar Chart -> Interaction: Hover for tooltip -> Justification: Easy comparison of monthly financial activity -> Library/Method: Chart.js (Canvas).
        - Report Info: Cashflow log -> Goal: Organize -> Viz: Table -> Interaction: Search, Delete Transaction -> Justification: Allows users to find and manage specific transactions easily -> Library/Method: HTML/Tailwind + JS.
        - Report Info: Member payment status -> Goal: Organize/Compare -> Viz: Table/Grid -> Interaction: Filter by month, Add/Delete Member, **Automatic Payment Status Update based on payer and income transaction** -> Justification: Quick visual check of who has paid, with color-coding for clarity, and full member management, now automated for accuracy with improved input and simplified payment logic -> Library/Method: HTML/Tailwind + JS.
        - Report Info: Spending patterns from cashflow -> Goal: Inform/Analyze -> Viz: AI-generated text summary -> Interaction: Button click with month selection -> Justification: Provides qualitative insights into spending habits beyond raw numbers -> Library/Method: Gemini API (LLM).
        - Report Info: Unpaid members -> Goal: Act/Communicate -> Viz: AI-generated text draft -> Interaction: Button click -> Justification: Automates the creation of polite payment reminders, saving time -> Library/Method: Gemini API (LLM).
        - Report Info: All data persistence -> Goal: Store/Retrieve -> Viz: None -> Interaction: Download JSON, Upload JSON, Clear In-memory Data -> Justification: Essential for long-term data management and portability, now primarily via Firebase. -> Library/Method: Firebase Firestore + File (JSON) via JS Blob/FileReader.
        - Report Info: Detailed Transaction Input -> Goal: Record -> Viz: Form -> Interaction: Input fields, radio buttons, submit button, Payer dropdown -> Justification: Allows granular entry of financial activities with standardized payer selection -> Library/Method: HTML/Tailwind + JS.
    -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* slate-50 */
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            height: 350px;
            max-height: 400px;
        }
        @media (max-width: 768px) {
            .chart-container {
                height: 300px;
            }
        }
        .tab-button.active {
            border-color: #f59e0b; /* amber-500 */
            color: #f59e0b; /* amber-500 */
            font-weight: 600;
        }
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #f59e0b;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-left: 8px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            width: 90%;
            max-width: 600px;
            text-align: left;
        }
        .modal-content.centered-text {
             text-align: center;
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        .pagination-button {
            transition: background-color 0.3s ease;
        }
        .pagination-button.active {
            background-color: #f59e0b;
            color: white;
            border-color: #f59e0b;
        }
        .pagination-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
    <!-- Firebase SDKs - V9 Compatibility (for easier integration with existing code structure) -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
</head>
<body class="text-slate-800">

    <div class="container mx-auto p-4 md:p-8">

        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-slate-900">Uang Kas RA Tarbiyatul Aulad</h1>
            <p class="text-slate-500 mt-2">Semangat!</p>
            <!-- Firebase Login/Logout UI -->
            <div class="mt-4 flex flex-col sm:flex-row justify-center items-center gap-4">
                <div id="authStatus" class="text-slate-600 font-medium">Memuat status autentikasi...</div>
                <button id="signInButton" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out hidden">
                    Login dengan Google
                </button>
                <button id="signOutButton" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out hidden">
                    Logout
                </button>
            </div>
        </header>

        <main id="appContent" class="hidden"> <!-- Hidden until user logs in -->
            <!-- Section: Key Metrics -->
            <section id="kpi" class="mb-8">
                 <div class="grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-6">
                    <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                        <h3 class="text-slate-500 font-medium mb-2">Saldo Saat Ini</h3>
                        <p id="currentBalance" class="text-3xl font-bold text-slate-900">Rp 0</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                        <h3 class="text-slate-500 font-medium mb-2">Total Pemasukan</h3>
                        <p id="totalIncome" class="text-3xl font-bold text-emerald-600">Rp 0</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                        <h3 class="text-slate-500 font-medium mb-2">Total Pengeluaran</h3>
                        <p id="totalExpense" class="text-3xl font-bold text-red-600">Rp 0</p>
                    </div>
                </div>
            </section>

            <!-- Section: Visualizations -->
            <section id="visualizations" class="mb-8 grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-white p-4 md:p-6 rounded-xl border border-slate-200 shadow-sm">
                    <h3 class="text-lg font-semibold mb-1 text-slate-900">Tren Arus Kas (Saldo)</h3>
                    <p class="text-sm text-slate-500 mb-4">Grafik ini menunjukkan perubahan saldo kas dari waktu ke waktu, memberikan gambaran tentang kesehatan finansial secara keseluruhan.</p>
                    <div class="chart-container">
                        <canvas id="cashflowChart"></canvas>
                    </div>
                </div>
                <div class="bg-white p-4 md:p-6 rounded-xl border border-slate-200 shadow-sm">
                    <h3 class="text-lg font-semibold mb-1 text-slate-900">Pemasukan vs Pengeluaran Bulanan</h3>
                     <p class="text-sm text-slate-500 mb-4">Bandingkan total pemasukan dan pengeluaran setiap bulan untuk melihat pola aktivitas keuangan.</p>
                    <div class="chart-container">
                        <canvas id="monthlyComparisonChart"></canvas>
                    </div>
                </div>
            </section>

            <!-- Section: Detailed Data -->
            <section id="details" class="mb-8">
                <div class="bg-white rounded-xl border border-slate-200 shadow-sm">
                    <div class="border-b border-slate-200">
                        <nav class="flex space-x-2 p-2" aria-label="Tabs">
                            <button id="tab-transactions" class="tab-button active px-4 py-2 text-sm font-medium text-slate-600 rounded-lg border-b-2 border-transparent hover:text-amber-600 focus:outline-none">
                                Riwayat Transaksi
                            </button>
                            <button id="tab-payments" class="tab-button px-4 py-2 text-sm font-medium text-slate-600 rounded-lg border-b-2 border-transparent hover:text-amber-600 focus:outline-none">
                                Status Pembayaran Anggota
                            </button>
                            <button id="tab-member-management" class="tab-button px-4 py-2 text-sm font-medium text-slate-600 rounded-lg border-b-2 border-transparent hover:text-amber-600 focus:outline-none">
                                Kelola Anggota
                            </button>
                        </nav>
                    </div>

                    <div id="content-transactions" class="p-4 md:p-6">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-4">
                            <div>
                                <h3 class="text-lg font-semibold text-slate-900">Detail Semua Transaksi</h3>
                                <p class="text-sm text-slate-500">Gunakan kolom pencarian untuk menemukan transaksi spesifik.</p>
                            </div>
                            <div class="flex w-full sm:w-auto gap-2">
                                <input type="text" id="transactionSearch" placeholder="Cari transaksi..." class="w-full sm:w-auto p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-400 focus:border-amber-400">
                                <button id="openAddTransactionModalButton" class="bg-amber-500 hover:bg-amber-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out flex-shrink-0">
                                    + Tambah
                                </button>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-slate-200">
                                <thead class="bg-slate-50">
                                    <tr>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Tanggal</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Keterangan</th>
                                        <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-slate-500 uppercase tracking-wider">Pemasukan</th>
                                        <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-slate-500 uppercase tracking-wider">Pengeluaran</th>
                                        <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-slate-500 uppercase tracking-wider">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="transactionTableBody" class="bg-white divide-y divide-slate-200">
                                    <!-- Rows will be inserted by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                        <!-- NEW: Pagination Controls -->
                        <div id="paginationControls" class="flex justify-between items-center mt-4">
                            <!-- Pagination will be rendered here by JavaScript -->
                        </div>
                    </div>

                    <div id="content-payments" class="hidden p-4 md:p-6">
                        <h3 class="text-lg font-semibold mb-1 text-slate-900">Status Pembayaran Iuran Kas</h3>
                        <p class="text-sm text-slate-500 mb-4">Berikut adalah status pembayaran iuran kas per bulan untuk setiap anggota.</p>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-slate-200">
                                <thead class="bg-slate-50">
                                    <tr id="paymentTableHeader">
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider sticky left-0 bg-slate-50 z-10">Nama Anggota</th>
                                        <!-- Month headers will be inserted by JavaScript -->
                                    </tr>
                                </thead>
                                <tbody id="paymentTableBody" class="bg-white divide-y divide-slate-200">
                                    <!-- Rows will be inserted by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- This div is now hidden and its content moved to a modal -->
                    <div id="content-input-transaction" class="hidden"></div>

                    <div id="content-member-management" class="hidden p-4 md:p-6">
                        <h3 class="text-lg font-semibold mb-1 text-slate-900">Kelola Anggota</h3>
                        <p class="text-sm text-slate-500 mb-4">Tambahkan, edit, atau hapus anggota yang akan membayar uang kas.</p>
                        <div class="mb-4 flex flex-col sm:flex-row gap-2">
                            <input type="text" id="newMemberName" placeholder="Nama Anggota Baru" class="flex-grow p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-400 focus:border-amber-400">
                            <button id="addMemberButton" class="bg-emerald-500 hover:bg-emerald-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out flex items-center justify-center">
                                Tambah Anggota
                                <span id="addMemberSpinner" class="loading-spinner hidden"></span>
                            </button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-slate-200">
                                <thead class="bg-slate-50">
                                    <tr>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Nama Anggota</th>
                                        <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-slate-500 uppercase tracking-wider">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="memberTableBody" class="bg-white divide-y divide-slate-200">
                                    <!-- Rows will be inserted by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Section: AI Insights & Assistance -->
            <section id="ai-insights" class="mb-8">
                <div class="bg-white p-4 md:p-6 rounded-xl border border-slate-200 shadow-sm">
                    <h2 class="text-xl font-semibold mb-4 text-slate-900">Insight & Bantuan AI</h2>
                    <p class="text-sm text-slate-500 mb-4">Manfaatkan kecerdasan buatan untuk mendapatkan analisis pengeluaran dan draf pengingat pembayaran.</p>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Spending Analysis -->
                        <div>
                            <h3 class="text-lg font-semibold mb-2 text-slate-900">Analisis Pengeluaran Bulanan</h3>
                            <p class="text-sm text-slate-500 mb-3">Pilih bulan untuk mendapatkan ringkasan pola pengeluaran utama Anda.</p>
                            <div class="flex items-center space-x-2 mb-4">
                                <select id="aiMonthFilter" class="p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-400 focus:border-amber-400">
                                    <!-- Options will be inserted by JavaScript -->
                                </select>
                                <button id="generateSpendingAnalysis" class="bg-amber-500 hover:bg-amber-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out flex items-center">
                                    Dapatkan Analisis Pengeluaran ‚ú®
                                    <span id="spendingAnalysisSpinner" class="loading-spinner hidden"></span>
                                </button>
                            </div>
                            <div id="spendingAnalysisOutput" class="bg-slate-50 p-4 rounded-lg border border-slate-200 text-slate-700 min-h-[80px] flex items-center justify-center text-center">
                                <p class="text-slate-500">Hasil analisis akan muncul di sini.</p>
                            </div>
                        </div>

                        <!-- Payment Reminder Draft -->
                        <div>
                            <h3 class="text-lg font-semibold mb-2 text-slate-900">Draf Pengingat Pembayaran</h3>
                            <p class="text-sm text-slate-500 mb-3">Buat draf pesan pengingat untuk anggota yang belum membayar iuran pada bulan yang sedang dipilih di tab "Status Pembayaran".</p>
                            <button id="generatePaymentReminder" class="bg-emerald-500 hover:bg-emerald-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out flex items-center mb-4">
                                Buat Draf Pengingat Pengingat ‚ú®
                                <span id="paymentReminderSpinner" class="loading-spinner hidden"></span>
                            </button>
                            <div id="paymentReminderOutput" class="bg-slate-50 p-4 rounded-lg border border-slate-200 text-slate-700 min-h-[80px] flex items-center justify-center text-center">
                                <p class="text-slate-500">Draf pesan akan muncul di sini.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Section: PDF Report Settings -->
            <section id="pdf-settings" class="mb-8">
                <div class="bg-white p-4 md:p-6 rounded-xl border border-slate-200 shadow-sm">
                    <h2 class="text-xl font-semibold mb-4 text-slate-900">Pengaturan Laporan PDF</h2>
                    <p class="text-sm text-slate-500 mb-4">Pilih bulan-bulan yang ingin Anda sertakan dalam bagian "Rincian Perbulan" pada laporan PDF.</p>
                    <div id="pdfMonthSelection" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-2">
                        <!-- Month checkboxes will be generated here by JavaScript -->
                    </div>
                    <button id="selectAllPdfMonths" class="mt-4 bg-slate-200 hover:bg-slate-300 text-slate-800 font-semibold py-1 px-3 rounded-lg text-sm transition duration-300 ease-in-out">Pilih Semua</button>
                    <button id="clearAllPdfMonths" class="mt-4 bg-slate-200 hover:bg-slate-300 text-slate-800 font-semibold py-1 px-3 rounded-lg text-sm transition duration-300 ease-in-out ml-2">Hapus Pilihan</button>
                </div>
            </section>

            <!-- Section: Data Management -->
            <section id="data-management" class="mb-8">
                <div class="bg-white p-4 md:p-6 rounded-xl border border-slate-200 shadow-sm">
                    <h2 class="text-xl font-semibold mb-4 text-slate-900">Manajemen Data</h2>
                    <p class="text-sm text-slate-500 mb-4">Unduh data Anda sebagai file JSON (backup) atau muat data dari file yang sudah ada.</p>
                    <div class="flex flex-col sm:flex-row gap-4 mb-4">
                        <button id="downloadDataButton" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out flex items-center justify-center">
                            Unduh Data (JSON) üíæ
                        </button>
                        <button id="downloadReportButton" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out flex items-center justify-center">
                            Unduh Laporan (PDF) üìÑ
                        </button>
                        <input type="file" id="uploadFileInput" accept=".json" class="hidden">
                        <button id="uploadDataButton" class="bg-purple-500 hover:bg-purple-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out flex items-center justify-center">
                            Muat Data dari File üìÅ
                        </button>
                        <button id="clearInMemoryDataButton" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out flex items-center justify-center">
                            Hapus Semua Data (Firebase) üóëÔ∏è
                        </button>
                    </div>
                    <div class="flex items-center space-x-2 mb-4">
                        <label for="autoDownloadInterval" class="text-sm font-medium text-slate-700">Unduh Otomatis Backup Lokal Setiap:</label>
                        <select id="autoDownloadInterval" class="p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-400 focus:border-amber-400">
                            <option value="0" selected>Nonaktif</option> <!-- Default to Nonaktif -->
                            <option value="1">1 Menit</option>
                            <option value="5">5 Menit</option>
                            <option value="10">10 Menit</option>
                            <option value="30">30 Menit</option>
                        </select>
                        <span id="autoDownloadStatus" class="text-sm text-slate-500"></span>
                    </div>
                    <p id="dataManagementMessage" class="mt-4 text-sm text-slate-600"></p>
                </div>
            </section>
        </main>
    </div>

    <!-- MODALS SECTION -->
    
    <!-- Custom Modal for Confirmation -->
    <div id="confirmationModal" class="modal">
        <div class="modal-content centered-text">
            <span class="close-button">&times;</span>
            <p id="modalMessage" class="text-lg font-medium text-slate-800 mb-6">Apakah Anda yakin?</p>
            <div class="flex justify-center space-x-4">
                <button id="confirmYes" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out">Ya</button>
                <button id="confirmNo" class="bg-slate-300 hover:bg-slate-400 text-slate-800 font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out">Tidak</button>
            </div>
        </div>
    </div>

    <!-- Custom Modal for Editing Member Name -->
    <div id="editMemberModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="closeEditMemberModal">&times;</span>
            <h3 class="text-lg font-semibold mb-4 text-slate-900">Edit Nama Anggota</h3>
            <input type="text" id="editMemberNameInput" class="w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-amber-500 focus:border-amber-500 mb-4" placeholder="Nama Anggota Baru">
            <div class="flex justify-end space-x-4">
                <button id="cancelEditMemberName" class="bg-slate-300 hover:bg-slate-400 text-slate-800 font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out">Batal</button>
                <button id="saveEditedMemberName" class="bg-amber-500 hover:bg-amber-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out">Simpan</button>
            </div>
        </div>
    </div>

    <!-- NEW: Modal for Adding a New Transaction -->
    <div id="addTransactionModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="closeAddTransactionModal">&times;</span>
            <h3 class="text-lg font-semibold mb-1 text-slate-900">Input Transaksi Baru</h3>
            <p class="text-sm text-slate-500 mb-4">Masukkan detail transaksi pemasukan atau pengeluaran baru.</p>
            <form id="transactionForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="transactionDate" class="block text-sm font-medium text-slate-700">Tanggal</label>
                    <input type="date" id="transactionDate" class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-amber-500 focus:border-amber-500" required>
                </div>
                <div>
                    <label for="transactionDesc" class="block text-sm font-medium text-slate-700">Keterangan</label>
                    <input type="text" id="transactionDesc" placeholder="Contoh: Pembelian buku kas" class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-amber-500 focus:border-amber-500" required>
                </div>
                <div>
                    <label for="transactionAmount" class="block text-sm font-medium text-slate-700">Nominal (Rp)</label>
                    <input type="number" id="transactionAmount" placeholder="Contoh: 50000" class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-amber-500 focus:border-amber-500" required min="0">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700">Jenis Transaksi</label>
                    <div class="mt-1 flex items-center space-x-4">
                        <label class="inline-flex items-center">
                            <input type="radio" name="transactionType" value="pemasukan" class="form-radio text-emerald-600" checked>
                            <span class="ml-2 text-slate-700">Pemasukan</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="radio" name="transactionType" value="pengeluaran" class="form-radio text-red-600">
                            <span class="ml-2 text-slate-700">Pengeluaran</span>
                        </label>
                    </div>
                </div>
                <div class="md:col-span-2">
                    <label for="transactionWho" class="block text-sm font-medium text-slate-700">Penyetor / Pengambil</label>
                    <select id="transactionWho" class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-amber-500 focus:border-amber-500">
                        <option value="">Pilih Anggota (Opsional)</option>
                        <!-- Options will be populated by JavaScript -->
                    </select>
                </div>
                <!-- New fields for multi-month payment -->
                <div class="md:col-span-2">
                    <label for="paymentPeriodStartMonth" class="block text-sm font-medium text-slate-700">Pembayaran Untuk Bulan (Mulai)</label>
                    <select id="paymentPeriodStartMonth" class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-amber-500 focus:border-amber-500">
                        <option value="">Pilih Bulan (Opsional)</option>
                        <!-- Options will be populated by JavaScript -->
                    </select>
                </div>
                <div class="md:col-span-2">
                    <label for="paymentPeriodEndMonth" class="block text-sm font-medium text-slate-700">Pembayaran Untuk Bulan (Akhir)</label>
                    <select id="paymentPeriodEndMonth" class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-amber-500 focus:border-amber-500">
                        <option value="">Pilih Bulan (Opsional)</option>
                        <!-- Options will be populated by JavaScript -->
                    </select>
                </div>
                <!-- End new fields -->
                <div class="md:col-span-2 flex justify-end">
                    <button type="submit" class="bg-amber-500 hover:bg-amber-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out flex items-center">
                        Tambah Transaksi
                        <span id="addTransactionSpinner" class="loading-spinner hidden"></span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- NEW: Modal for Editing an Existing Transaction -->
    <div id="editTransactionModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="closeEditTransactionModal">&times;</span>
            <h3 class="text-lg font-semibold mb-1 text-slate-900">Edit Transaksi</h3>
            <p class="text-sm text-slate-500 mb-4">Ubah detail transaksi yang sudah ada.</p>
            <form id="editTransactionForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <input type="hidden" id="editTransactionId">
                <div>
                    <label for="editTransactionDate" class="block text-sm font-medium text-slate-700">Tanggal</label>
                    <input type="date" id="editTransactionDate" class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-amber-500 focus:border-amber-500" required>
                </div>
                <div>
                    <label for="editTransactionDesc" class="block text-sm font-medium text-slate-700">Keterangan</label>
                    <input type="text" id="editTransactionDesc" class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-amber-500 focus:border-amber-500" required>
                </div>
                <div>
                    <label for="editTransactionAmount" class="block text-sm font-medium text-slate-700">Nominal (Rp)</label>
                    <input type="number" id="editTransactionAmount" class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-amber-500 focus:border-amber-500" required min="0">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700">Jenis Transaksi</label>
                    <div class="mt-1 flex items-center space-x-4">
                        <label class="inline-flex items-center">
                            <input type="radio" name="editTransactionType" value="pemasukan" class="form-radio text-emerald-600">
                            <span class="ml-2 text-slate-700">Pemasukan</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="radio" name="editTransactionType" value="pengeluaran" class="form-radio text-red-600">
                            <span class="ml-2 text-slate-700">Pengeluaran</span>
                        </label>
                    </div>
                </div>
                <div class="md:col-span-2">
                    <label for="editTransactionWho" class="block text-sm font-medium text-slate-700">Penyetor / Pengambil</label>
                    <select id="editTransactionWho" class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-amber-500 focus:border-amber-500">
                        <!-- Options will be populated by JavaScript -->
                    </select>
                </div>
                <div class="md:col-span-2 flex justify-end space-x-4">
                     <button type="button" id="cancelEditTransaction" class="bg-slate-300 hover:bg-slate-400 text-slate-800 font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out">Batal</button>
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out flex items-center">
                        Simpan Perubahan
                        <span id="editTransactionSpinner" class="loading-spinner hidden"></span>
                    </button>
                </div>
            </form>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Global data arrays
            let cashflowData = [];
            let paymentData = []; // This will now store member names and their payment status objects
            
            // NEW: Pagination state
            let currentPage = 1;
            const transactionsPerPage = 10;

            // REVISED: Define the calculation period from July 2025 to July 2026
            const months = [
                'Juli 2025', 'Agustus 2025', 'September 2025', 'Oktober 2025', 'November 2025', 'Desember 2025',
                'Januari 2026', 'Februari 2026', 'Maret 2026', 'April 2026', 'Mei 2026', 'Juni 2026', 'Juli 2026'
            ];

            const formatCurrency = (value) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(value);

            // --- Firebase Configuration & Initialization ---
            // __firebase_config, __app_id, and __initial_auth_token are provided by the Canvas environment.
            // If running outside Canvas, firebaseConfig will be empty and __initial_auth_token undefined.
            const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' && Object.keys(JSON.parse(__firebase_config)).length > 0 ? __firebase_config : JSON.stringify({
                apiKey: "AIzaSyBuoxTcp7_C5LdOtU_vKlkvQNVLtdZK68Y",
                authDomain: "uang-kas-ra.firebaseapp.com",
                projectId: "uang-kas-ra",
                storageBucket: "uang-kas-ra.firebasestorage.app",
                messagingSenderId: "635210671608",
                appId: "1:635210671608:web:36dd4007f60a2ab434a20d",
                measurementId: "G-EJHTNTCHXJ"
            }));
            const appId = typeof __app_id !== 'undefined' ? __app_id : firebaseConfig.projectId; // Use projectId as default appId

            // Initialize Firebase app if config is not empty
            let app;
            let auth;
            let db;

            // Check if firebaseConfig is not empty before initializing
            if (Object.keys(firebaseConfig).length > 0) {
                app = firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                db = firebase.firestore();
            } else {
                console.error("Firebase config is empty. Please provide Firebase configuration.");
                // Provide dummy functions if Firebase is not initialized to prevent errors
                auth = { onAuthStateChanged: (cb) => cb(null), signInWithPopup: () => Promise.reject('Firebase not configured'), signOut: () => Promise.resolve() };
                db = { collection: () => ({ doc: () => ({ set: () => Promise.resolve(), delete: () => Promise.resolve(), onSnapshot: () => () => {} }) }) };
                document.getElementById('authStatus').textContent = 'Firebase tidak terkonfigurasi. Data tidak akan disimpan ke cloud.';
            }

            let currentUserUid = null; // To store the current user's UID
            let firestoreUserDataDocRef = null; // Reference to the user's data document in Firestore
            let dataUnsubscribe = null; // To store the Firestore snapshot listener unsubscribe function

            const signInButton = document.getElementById('signInButton');
            const signOutButton = document.getElementById('signOutButton');
            const authStatusDiv = document.getElementById('authStatus');
            const appContent = document.getElementById('appContent');

            // --- Firebase Authentication Functions ---

            // Handle Google Sign-In
            signInButton.addEventListener('click', async () => {
                try {
                    const provider = new firebase.auth.GoogleAuthProvider();
                    await auth.signInWithPopup(provider);
                    // onAuthStateChanged will handle UI and data loading
                } catch (error) {
                    console.error("Error during Google Sign-In:", error);
                    authStatusDiv.textContent = `Login Gagal: ${error.message}`;
                }
            });

            // Handle Sign-Out
            signOutButton.addEventListener('click', async () => {
                try {
                    await auth.signOut();
                    // onAuthStateChanged will handle UI and data clearing
                } catch (error) {
                    console.error("Error during Sign-Out:", error);
                    authStatusDiv.textContent = `Logout Gagal: ${error.message}`;
                }
            });

            // Auth State Change Listener
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    // User is signed in.
                    currentUserUid = user.uid;
                    authStatusDiv.textContent = `Selamat datang, ${user.displayName || user.email}!`;
                    signInButton.classList.add('hidden');
                    signOutButton.classList.remove('hidden');
                    appContent.classList.remove('hidden'); // Show app content

                    // Set up Firestore data reference for the current user
                    // Private data collection: /artifacts/{appId}/users/{userId}/uangKasData/{docId}
                    // We'll use a single document named 'userData' for simplicity
                    firestoreUserDataDocRef = db.collection('artifacts').doc(appId).collection('users').doc(currentUserUid).collection('uangKasData').doc('userData');

                    // Stop any existing listener before starting a new one
                    if (dataUnsubscribe) {
                        dataUnsubscribe();
                    }

                    // Set up real-time listener for user data
                    dataUnsubscribe = firestoreUserDataDocRef.onSnapshot(doc => {
                        if (doc.exists) {
                            const data = doc.data();
                            cashflowData = data.cashflow || [];
                            paymentData = data.payments || [];
                            document.getElementById('dataManagementMessage').textContent = 'Data berhasil disinkronkan dari Firebase.';
                        } else {
                            // Document does not exist, initialize with a basic Admin member and save
                            console.log("Tidak ada data pengguna yang ditemukan di Firestore. Menginisialisasi dengan data kosong.");
                            cashflowData = [];
                            paymentData = [
                                { docId: 'm0', nama: 'Admin', isSystem: true, pembayaran: {} }
                            ];
                            // Save initial data to Firestore
                            saveDataToFirestore();
                            document.getElementById('dataManagementMessage').textContent = 'Data baru diinisialisasi di Firebase.';
                        }
                        renderAllUI(); // Always re-render UI after data changes
                    }, (error) => {
                        console.error("Error listening to Firestore data:", error);
                        document.getElementById('dataManagementMessage').textContent = 'Gagal menyinkronkan data dari Firebase.';
                    });

                } else {
                    // User is signed out.
                    currentUserUid = null;
                    authStatusDiv.textContent = 'Silakan login untuk menyimpan data Anda.';
                    signInButton.classList.remove('hidden');
                    signOutButton.classList.add('hidden');
                    appContent.classList.add('hidden'); // Hide app content

                    // Clear local data when user logs out
                    cashflowData = [];
                    paymentData = [];
                    renderAllUI();
                    document.getElementById('dataManagementMessage').textContent = '';

                    // Stop listening to Firestore data if user logs out
                    if (dataUnsubscribe) {
                        dataUnsubscribe();
                        dataUnsubscribe = null;
                    }

                    // Handle Canvas initial authentication token
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token !== null && __initial_auth_token !== '') {
                         // Sign in with custom token if provided by Canvas environment
                        try {
                             auth.signInWithCustomToken(__initial_auth_token)
                                .then(() => console.log("Signed in with custom token (Canvas environment)."))
                                .catch(error => {
                                    console.error("Error signing in with custom token:", error);
                                });
                        } catch (error) {
                             console.error("Error attempting signInWithCustomToken:", error);
                        }
                    } else {
                        // Fallback to anonymous sign-in if no custom token is provided
                        try {
                            auth.signInAnonymously()
                                .then(() => console.log("Signed in anonymously (default)."))
                                .catch(error => {
                                    console.error("Error signing in anonymously:", error);
                                });
                        } catch (error) {
                             console.error("Error attempting signInAnonymously:", error);
                        }
                    }
                }
            });


            // --- Firestore Data Persistence Functions (replacing Local Storage) ---

            /**
             * Saves data (cashflow and payments) to Firestore for the current user.
             * This function is called after any data modification.
             */
            async function saveDataToFirestore() {
                if (!currentUserUid || !firestoreUserDataDocRef) {
                    console.warn("Pengguna tidak terautentikasi atau referensi data belum diatur. Tidak dapat menyimpan ke Firestore.");
                    document.getElementById('dataManagementMessage').textContent = 'Tidak dapat menyimpan: Belum login atau koneksi Firebase belum siap.';
                    return;
                }
                try {
                    await firestoreUserDataDocRef.set({
                        cashflow: cashflowData,
                        payments: paymentData,
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp() // Add timestamp for tracking
                    }, { merge: true }); // Use merge to avoid overwriting the entire document if other fields exist
                    // The onSnapshot listener will update the UI, no need for direct UI update here for message.
                } catch (e) {
                    console.error('Error saving to Firestore:', e);
                    document.getElementById('dataManagementMessage').textContent = `Gagal menyimpan data ke Firebase: ${e.message}`;
                }
            }

            // --- Data Operations (now primarily interacting with Firestore) ---

            function addTransaction(transaction) {
                // Generate client-side docId if not already present (for consistency with original logic)
                transaction.docId = transaction.docId || Date.now().toString();
                cashflowData.push(transaction);
                saveDataToFirestore(); // Trigger save to Firestore
            }
            
            // NEW: Update an existing transaction
            function updateTransaction(docId, updatedData) {
                const transactionIndex = cashflowData.findIndex(item => item.docId === docId);
                if (transactionIndex > -1) {
                    // Keep the original docId
                    cashflowData[transactionIndex] = { ...updatedData, docId: docId };
                    saveDataToFirestore();
                }
            }

            async function deleteTransaction(docId) {
                cashflowData = cashflowData.filter(item => item.docId !== docId);
                await saveDataToFirestore(); // Trigger save to Firestore
            }

            function addMember(memberName) {
                const newMember = { docId: Date.now().toString(), nama: memberName, pembayaran: {} };
                paymentData.push(newMember);
                saveDataToFirestore(); // Trigger save to Firestore
            }

            async function editMember(docId, newName) {
                const memberIndex = paymentData.findIndex(member => member.docId === docId);
                if (memberIndex > -1) {
                    const oldName = paymentData[memberIndex].nama;
                    paymentData[memberIndex].nama = newName;

                    // Update existing transactions with the old member name to the new name
                    cashflowData.forEach(transaction => {
                        if (transaction.penyetorPengambil === oldName) {
                            transaction.penyetorPengambil = newName;
                        }
                    });
                    await saveDataToFirestore(); // Trigger save to Firestore
                }
            }

            async function deleteMember(docId) {
                const memberToDelete = paymentData.find(member => member.docId === docId);
                if (memberToDelete) {
                    const memberName = memberToDelete.nama;
                    paymentData = paymentData.filter(member => member.docId !== docId); // Remove member
                    cashflowData = cashflowData.filter(transaction => transaction.penyetorPengambil !== memberName); // Remove associated transactions
                }
                await saveDataToFirestore(); // Trigger save to Firestore
            }

            async function clearInMemoryData() {
                if (!currentUserUid || !firestoreUserDataDocRef) {
                    document.getElementById('dataManagementMessage').textContent = 'Tidak dapat menghapus: Belum login atau koneksi Firebase belum siap.';
                    return;
                }
                showConfirmationModal('Apakah Anda yakin ingin menghapus SEMUA data dari Firebase? Tindakan ini tidak dapat dibatalkan.', async () => {
                    try {
                        await firestoreUserDataDocRef.delete(); // Delete document from Firestore
                        // onSnapshot listener will clear local data and re-render UI
                        // so no need to manually clear cashflowData and paymentData here.
                        // The onSnapshot will receive a 'doc.exists' false event and re-initialize with admin.
                        document.getElementById('dataManagementMessage').textContent = 'Semua data telah dihapus dari Firebase!';
                    } catch (e) {
                        console.error('Error deleting data from Firestore:', e);
                        document.getElementById('dataManagementMessage').textContent = `Gagal menghapus data dari Firebase: ${e.message}`;
                    }
                });
            }

            // --- UI Rendering Functions ---
            function renderAllUI() {
                updateAllPaymentStatuses(); // Update payment statuses before rendering
                calculateKPIs();
                renderCashflowChart();
                renderMonthlyComparisonChart();
                renderTransactionTable(document.getElementById('transactionSearch').value, currentPage);
                renderPaymentTable(); // Render payment table with all months
                renderMemberTable();
                populateTransactionWhoDropdowns(); // Populate dropdowns for both add and edit modals
                populatePaymentPeriodDropdowns(); // Populate new payment period dropdowns
                populatePdfMonthCheckboxes(); // Ensure PDF month checkboxes are populated
                populateAiMonthFilter(); // NEW: Populate AI month filter
            }

            function calculateKPIs() {
                let totalIncome = 0;
                let totalExpense = 0;
                cashflowData.forEach(item => {
                    totalIncome += item.pemasukan;
                    totalExpense += item.pengeluaran;
                });
                const currentBalance = totalIncome - totalExpense;

                document.getElementById('currentBalance').textContent = formatCurrency(currentBalance);
                document.getElementById('totalIncome').textContent = formatCurrency(totalIncome);
                document.getElementById('totalExpense').textContent = formatCurrency(totalExpense);
            }

            let cashflowChartInstance = null;
            function renderCashflowChart() {
                const ctx = document.getElementById('cashflowChart').getContext('2d');
                const labels = [];
                const balanceData = [];
                let runningBalance = 0;

                const sortedCashflowData = [...cashflowData].sort((a, b) => new Date(a.tanggal) - new Date(b.tanggal));

                sortedCashflowData.forEach(item => {
                    runningBalance += item.pemasukan - item.pengeluaran;
                    labels.push(new Date(item.tanggal).toLocaleDateString('id-ID', { day: 'numeric', month: 'short' }));
                    balanceData.push(runningBalance);
                });

                if (cashflowChartInstance) {
                    cashflowChartInstance.destroy();
                }

                cashflowChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Saldo Kas',
                            data: balanceData,
                            borderColor: '#f59e0b',
                            backgroundColor: 'rgba(245, 158, 11, 0.1)',
                            fill: true,
                            tension: 0.3,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: false,
                                ticks: {
                                    callback: function(value) {
                                        return formatCurrency(value);
                                    }
                                }
                            }
                        },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `Saldo: ${formatCurrency(context.raw)}`;
                                    }
                                }
                            }
                        }
                    }
                });
            }

            let monthlyComparisonChartInstance = null;
            function renderMonthlyComparisonChart() {
                const ctx = document.getElementById('monthlyComparisonChart').getContext('2d');
                const monthlyData = {};

                // REVISED: Initialize monthlyData with all months from the period to ensure correct order
                months.forEach(month => {
                    monthlyData[month] = { pemasukan: 0, pengeluaran: 0 };
                });

                cashflowData.forEach(item => {
                    const date = new Date(item.tanggal);
                    // Create a key like "Juli 2025"
                    const monthName = date.toLocaleString('id-ID', { month: 'long', year: 'numeric' });
                    
                    // Only include data that falls within our defined period
                    if (monthlyData.hasOwnProperty(monthName)) {
                        monthlyData[monthName].pemasukan += item.pemasukan;
                        monthlyData[monthName].pengeluaran += item.pengeluaran;
                    }
                });

                const chartLabels = Object.keys(monthlyData);
                const incomeDataset = chartLabels.map(month => monthlyData[month].pemasukan);
                const expenseDataset = chartLabels.map(month => monthlyData[month].pengeluaran);

                if (monthlyComparisonChartInstance) {
                    monthlyComparisonChartInstance.destroy();
                }

                monthlyComparisonChartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: chartLabels,
                        datasets: [
                            {
                                label: 'Pemasukan',
                                data: incomeDataset,
                                backgroundColor: '#10b981',
                                borderRadius: 4,
                            },
                            {
                                label: 'Pengeluaran',
                                data: expenseDataset,
                                backgroundColor: '#ef4444',
                                borderRadius: 4,
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return formatCurrency(value);
                                    }
                                }
                            }
                        },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `${context.dataset.label}: ${formatCurrency(context.raw)}`;
                                    }
                                }
                            }
                        }
                    }
                });
            }

            function renderTransactionTable(filter = '', page = 1) {
                const tableBody = document.getElementById('transactionTableBody');
                tableBody.innerHTML = '';
                
                currentPage = page;

                const filteredData = cashflowData.filter(item =>
                    item.keterangan.toLowerCase().includes(filter.toLowerCase()) ||
                    (item.penyetorPengambil && item.penyetorPengambil.toLowerCase().includes(filter.toLowerCase()))
                ).sort((a, b) => new Date(b.tanggal) - new Date(a.tanggal));

                const startIndex = (page - 1) * transactionsPerPage;
                const endIndex = page * transactionsPerPage;
                const paginatedData = filteredData.slice(startIndex, endIndex);

                if (paginatedData.length === 0) {
                    tableBody.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-slate-500">Tidak ada data yang cocok.</td></tr>`;
                    renderPaginationControls(0, page);
                    return;
                }

                paginatedData.forEach(item => {
                    const row = `
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600">${new Date(item.tanggal).toLocaleDateString('id-ID')}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-800">${item.keterangan} (${item.penyetorPengambil || 'Anonim'})</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-emerald-600 font-semibold text-right">${item.pemasukan > 0 ? formatCurrency(item.pemasukan) : '-'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-red-600 font-semibold text-right">${item.pengeluaran > 0 ? formatCurrency(item.pengeluaran) : '-'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                <button data-doc-id="${item.docId}" class="edit-transaction-button text-blue-600 hover:text-blue-900 mr-2">Edit</button>
                                <button data-doc-id="${item.docId}" class="delete-transaction-button text-red-600 hover:text-red-900">Hapus</button>
                            </td>
                        </tr>
                    `;
                    tableBody.innerHTML += row;
                });

                // Attach event listeners after rendering all rows
                document.querySelectorAll('.delete-transaction-button').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const docId = e.target.dataset.docId;
                        showConfirmationModal(`Apakah Anda yakin ingin menghapus transaksi ini?`, () => {
                            deleteTransaction(docId);
                        });
                    });
                });
                
                document.querySelectorAll('.edit-transaction-button').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const docId = e.target.dataset.docId;
                        const transaction = cashflowData.find(t => t.docId === docId);
                        if (transaction) {
                            showEditTransactionModal(transaction);
                        }
                    });
                });

                renderPaginationControls(filteredData.length, page);
            }

            function renderPaginationControls(totalItems, page) {
                const paginationControls = document.getElementById('paginationControls');
                paginationControls.innerHTML = '';
                const totalPages = Math.ceil(totalItems / transactionsPerPage);

                if (totalPages <= 1) return;

                let paginationHTML = `
                    <span class="text-sm text-slate-700">
                        Halaman ${page} dari ${totalPages}
                    </span>
                    <div class="flex items-center">
                        <button id="prevPage" class="pagination-button bg-white border border-slate-300 text-slate-700 font-semibold py-1 px-3 rounded-l-lg" ${page === 1 ? 'disabled' : ''}>
                            Sebelumnya
                        </button>
                `;

                // Page numbers logic (simplified for brevity)
                for (let i = 1; i <= totalPages; i++) {
                    paginationHTML += `
                        <button class="pagination-button page-number-button bg-white border-t border-b border-slate-300 text-slate-700 font-semibold py-1 px-3 ${i === page ? 'active' : ''}" data-page="${i}">
                            ${i}
                        </button>
                    `;
                }

                paginationHTML += `
                        <button id="nextPage" class="pagination-button bg-white border border-slate-300 text-slate-700 font-semibold py-1 px-3 rounded-r-lg" ${page === totalPages ? 'disabled' : ''}>
                            Berikutnya
                        </button>
                    </div>
                `;

                paginationControls.innerHTML = paginationHTML;

                document.getElementById('prevPage')?.addEventListener('click', () => {
                    if (currentPage > 1) {
                        renderTransactionTable(document.getElementById('transactionSearch').value, currentPage - 1);
                    }
                });

                document.getElementById('nextPage')?.addEventListener('click', () => {
                    if (currentPage < totalPages) {
                        renderTransactionTable(document.getElementById('transactionSearch').value, currentPage + 1);
                    }
                });

                document.querySelectorAll('.page-number-button').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const newPage = parseInt(e.target.dataset.page);
                        renderTransactionTable(document.getElementById('transactionSearch').value, newPage);
                    });
                });
            }


            // Modified: renderPaymentTable to display all months as columns
            function renderPaymentTable() {
                const tableHeader = document.getElementById('paymentTableHeader');
                const tableBody = document.getElementById('paymentTableBody');
                tableBody.innerHTML = ''; // Clear existing rows

                // Clear and re-populate table headers
                tableHeader.innerHTML = `<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider sticky left-0 bg-slate-50 z-10">Nama Anggota</th>`;
                months.forEach(month => {
                    tableHeader.innerHTML += `<th scope="col" class="px-6 py-3 text-center text-xs font-medium text-slate-500 uppercase tracking-wider">${month}</th>`;
                });

                // Filter out system users like 'Admin' from payment tracking
                const filteredPaymentData = paymentData.filter(member => !member.isSystem);

                if (filteredPaymentData.length === 0) {
                    tableBody.innerHTML = `<tr><td colspan="${months.length + 1}" class="text-center py-4 text-slate-500">Tidak ada anggota terdaftar.</td></tr>`;
                    return;
                }

                // Sort filteredPaymentData alphabetically by nama before rendering
                const sortedPaymentData = [...filteredPaymentData].sort((a, b) => a.nama.localeCompare(b.nama));

                sortedPaymentData.forEach(member => {
                    let rowHtml = `<tr><td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-800 sticky left-0 bg-white">${member.nama}</td>`;
                    months.forEach(month => {
                        const status = member.pembayaran[month] || 'Belum';
                        const statusClass = status === 'Lunas' ? 'bg-emerald-100 text-emerald-800' : 'bg-red-100 text-red-800';
                        rowHtml += `
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-center">
                                <span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">
                                    ${status}
                                </span>
                            </td>
                        `;
                    });
                    rowHtml += `</tr>`;
                    tableBody.innerHTML += rowHtml;
                });
            }

            // New function to automatically update payment status based on cashflow data
            function updateAllPaymentStatuses() {
                // Reset all payment statuses to 'Belum'
                paymentData.forEach(member => {
                    if (!member.isSystem) {
                        member.pembayaran = {}; // Clear old payments
                        months.forEach(month => {
                            member.pembayaran[month] = 'Belum';
                        });
                    }
                });

                // Iterate through cashflow data to find payments
                cashflowData.forEach(transaction => {
                    if (transaction.pemasukan > 0) {
                        const payerName = transaction.penyetorPengambil ? transaction.penyetorPengambil.toLowerCase() : '';
                        const member = paymentData.find(m => m.nama.toLowerCase() === payerName && !m.isSystem);

                        if (member) {
                            if (transaction.startMonth && transaction.endMonth) {
                                // This part should be fine as it uses indexOf on the new `months` array
                                const startIndex = months.indexOf(transaction.startMonth);
                                const endIndex = months.indexOf(transaction.endMonth);

                                if (startIndex !== -1 && endIndex !== -1 && startIndex <= endIndex) {
                                    for (let i = startIndex; i <= endIndex; i++) {
                                        member.pembayaran[months[i]] = 'Lunas';
                                    }
                                }
                            } else {
                                // REVISED: Logic for single-month payments
                                const transactionDate = new Date(transaction.tanggal);
                                // Format it to "Month YYYY" to match the `months` array
                                const transactionMonthName = transactionDate.toLocaleString('id-ID', { month: 'long', year: 'numeric' });
                                // Check if this month is part of our tracked period
                                if (months.includes(transactionMonthName)) {
                                     member.pembayaran[transactionMonthName] = 'Lunas';
                                }
                            }
                        }
                    }
                });
            }

            function renderMemberTable() {
                const memberTableBody = document.getElementById('memberTableBody');
                memberTableBody.innerHTML = '';
                if (paymentData.length === 0) {
                    memberTableBody.innerHTML = `<tr><td colspan="2" class="text-center py-4 text-slate-500">Tidak ada anggota terdaftar.</td></tr>`;
                    return;
                }
                // Filter out system users like 'Admin'
                const filteredPaymentData = paymentData.filter(member => !member.isSystem);
                // Sort filteredPaymentData alphabetically by nama before rendering
                const sortedPaymentData = [...filteredPaymentData].sort((a, b) => a.nama.localeCompare(b.nama));

                sortedPaymentData.forEach(member => {
                    const row = `
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-800">${member.nama}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                <button data-doc-id="${member.docId}" class="edit-member-button text-blue-600 hover:text-blue-900 mr-2">Edit</button>
                                <button data-doc-id="${member.docId}" class="delete-member-button text-red-600 hover:text-red-900">Hapus</button>
                            </td>
                        </tr>
                    `;
                    memberTableBody.innerHTML += row;
                });

                document.querySelectorAll('.delete-member-button').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const docId = e.target.dataset.docId;
                        const memberName = e.target.closest('tr').querySelector('td').textContent;
                        showConfirmationModal(`Apakah Anda yakin ingin menghapus anggota "${memberName}"? Ini juga akan menghapus semua transaksi terkait dengan anggota ini.`, () => {
                            deleteMember(docId);
                        });
                    });
                });

                document.querySelectorAll('.edit-member-button').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const docId = e.target.dataset.docId;
                        const member = paymentData.find(m => m.docId === docId);
                        if (member) {
                            showEditMemberModal(member.docId, member.nama);
                        }
                    });
                });
            }

            // Function to populate the "Penyetor / Pengambil" dropdowns in both modals
            function populateTransactionWhoDropdowns(transactionType = 'pemasukan') {
                const addSelect = document.getElementById('transactionWho');
                const editSelect = document.getElementById('editTransactionWho');
                
                [addSelect, editSelect].forEach(select => {
                    select.innerHTML = '<option value="">Pilih Anggota (Opsional)</option>'; // Reset and add default option
                    const sortedPaymentData = [...paymentData].sort((a, b) => a.nama.localeCompare(b.nama));
                    sortedPaymentData.forEach(member => {
                        const option = document.createElement('option');
                        option.value = member.nama;
                        option.textContent = member.nama;
                        // For 'Admin', only add if current transaction type is pengeluaran
                        if (member.isSystem && transactionType !== 'pengeluaran') {
                           // do not add admin
                        } else {
                            select.appendChild(option);
                        }
                    });
                });
            }

            // Add a new function to populate the payment period dropdowns
            function populatePaymentPeriodDropdowns() {
                const startMonthSelect = document.getElementById('paymentPeriodStartMonth');
                const endMonthSelect = document.getElementById('paymentPeriodEndMonth');

                startMonthSelect.innerHTML = '<option value="">Pilih Bulan (Opsional)</option>';
                endMonthSelect.innerHTML = '<option value="">Pilih Bulan (Opsional)</option>';

                // REVISED: The new default is the first month of the period
                const defaultMonth = months[0]; // "Juli 2025"

                months.forEach(month => {
                    const optionStart = document.createElement('option');
                    optionStart.value = month;
                    optionStart.textContent = month;
                    startMonthSelect.appendChild(optionStart);

                    const optionEnd = document.createElement('option');
                    optionEnd.value = month;
                    optionEnd.textContent = month;
                    endMonthSelect.appendChild(optionEnd);
                });

                // Set default to the first month of the period
                startMonthSelect.value = defaultMonth;
                endMonthSelect.value = defaultMonth;
            }

            // NEW: Function to populate the AI month filter dropdown
            function populateAiMonthFilter() {
                const aiMonthFilter = document.getElementById('aiMonthFilter');
                aiMonthFilter.innerHTML = ''; // Clear existing options
                months.forEach(month => {
                    const option = document.createElement('option');
                    option.value = month;
                    option.textContent = month;
                    aiMonthFilter.appendChild(option);
                });
                // Set a default value, e.g., the first month
                if (months.length > 0) {
                    aiMonthFilter.value = months[0];
                }
            }


            // --- MODAL LOGIC ---
            
            // Generic function to open a modal
            function openModal(modalId) {
                const modal = document.getElementById(modalId);
                if (modal) modal.style.display = 'flex';
            }

            // Generic function to close a modal
            function closeModal(modalId) {
                const modal = document.getElementById(modalId);
                if (modal) modal.style.display = 'none';
            }
            
            // Confirmation Modal
            const confirmationModal = document.getElementById('confirmationModal');
            const modalMessage = document.getElementById('modalMessage');
            const confirmYesButton = document.getElementById('confirmYes');
            const confirmNoButton = document.getElementById('confirmNo');
            const closeConfirmButton = document.querySelector('#confirmationModal .close-button');
            let confirmCallback = null;

            function showConfirmationModal(message, callback) {
                modalMessage.textContent = message;
                confirmCallback = callback;
                openModal('confirmationModal');
            }
            
            closeConfirmButton.addEventListener('click', () => closeModal('confirmationModal'));
            confirmNoButton.addEventListener('click', () => closeModal('confirmationModal'));
            confirmYesButton.addEventListener('click', async () => {
                if (confirmCallback) {
                    await confirmCallback();
                }
                closeModal('confirmationModal');
            });

            // Edit Member Modal
            const editMemberModal = document.getElementById('editMemberModal');
            const closeEditMemberModalButton = document.getElementById('closeEditMemberModal');
            const editMemberNameInput = document.getElementById('editMemberNameInput');
            const saveEditedMemberNameButton = document.getElementById('saveEditedMemberName');
            const cancelEditMemberNameButton = document.getElementById('cancelEditMemberName');
            let currentEditMemberId = null;

            function showEditMemberModal(docId, currentName) {
                currentEditMemberId = docId;
                editMemberNameInput.value = currentName;
                openModal('editMemberModal');
            }
            
            closeEditMemberModalButton.addEventListener('click', () => closeModal('editMemberModal'));
            cancelEditMemberNameButton.addEventListener('click', () => closeModal('editMemberModal'));
            saveEditedMemberNameButton.addEventListener('click', () => {
                const newName = editMemberNameInput.value.trim();
                if (newName && currentEditMemberId) {
                    editMember(currentEditMemberId, newName);
                    closeModal('editMemberModal');
                } else {
                    showConfirmationModal('Nama anggota tidak boleh kosong.', () => {});
                }
            });

            // NEW: Add Transaction Modal
            const addTransactionModal = document.getElementById('addTransactionModal');
            const openAddTransactionModalButton = document.getElementById('openAddTransactionModalButton');
            const closeAddTransactionModalButton = document.getElementById('closeAddTransactionModal');

            openAddTransactionModalButton.addEventListener('click', () => openModal('addTransactionModal'));
            closeAddTransactionModalButton.addEventListener('click', () => closeModal('addTransactionModal'));

            // NEW: Edit Transaction Modal
            const editTransactionModal = document.getElementById('editTransactionModal');
            const closeEditTransactionModalButton = document.getElementById('closeEditTransactionModal');
            const cancelEditTransactionButton = document.getElementById('cancelEditTransaction');

            function showEditTransactionModal(transaction) {
                document.getElementById('editTransactionId').value = transaction.docId;
                document.getElementById('editTransactionDate').value = transaction.tanggal;
                document.getElementById('editTransactionDesc').value = transaction.keterangan;
                
                const isIncome = transaction.pemasukan > 0;
                const amount = isIncome ? transaction.pemasukan : transaction.pengeluaran;
                
                document.getElementById('editTransactionAmount').value = amount;
                document.querySelector(`input[name="editTransactionType"][value="pemasukan"]`).checked = isIncome;
                document.querySelector(`input[name="editTransactionType"][value="pengeluaran"]`).checked = !isIncome;
                
                populateTransactionWhoDropdowns(isIncome ? 'pemasukan' : 'pengeluaran');
                document.getElementById('editTransactionWho').value = transaction.penyetorPengambil || '';
                
                openModal('editTransactionModal');
            }
            
            closeEditTransactionModalButton.addEventListener('click', () => closeModal('editTransactionModal'));
            cancelEditTransactionButton.addEventListener('click', () => closeModal('editTransactionModal'));

            // Close modals if clicked outside
            window.addEventListener('click', (event) => {
                if (event.target.classList.contains('modal')) {
                    event.target.style.display = 'none';
                }
            });


            // --- Event Listeners ---
            document.getElementById('transactionSearch').addEventListener('input', (e) => {
                renderTransactionTable(e.target.value, 1); // Reset to page 1 on new search
            });

            // Tab switching logic
            const tabTransactions = document.getElementById('tab-transactions');
            const tabPayments = document.getElementById('tab-payments');
            const tabMemberManagement = document.getElementById('tab-member-management');

            const contentTransactions = document.getElementById('content-transactions');
            const contentPayments = document.getElementById('content-payments');
            const contentMemberManagement = document.getElementById('content-member-management');

            const allTabs = [tabTransactions, tabPayments, tabMemberManagement];
            const allContents = [contentTransactions, contentPayments, contentMemberManagement];

            function switchTab(activeTabButton, activeContentDiv) {
                allTabs.forEach(tab => tab.classList.remove('active'));
                allContents.forEach(content => content.classList.add('hidden'));
                activeTabButton.classList.add('active');
                activeContentDiv.classList.remove('hidden');
            }

            tabTransactions.addEventListener('click', () => switchTab(tabTransactions, contentTransactions));
            tabPayments.addEventListener('click', () => switchTab(tabPayments, contentPayments));
            tabMemberManagement.addEventListener('click', () => switchTab(tabMemberManagement, contentMemberManagement));

            // Transaction Form Submission (for ADDING)
            document.getElementById('transactionForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const date = document.getElementById('transactionDate').value;
                const desc = document.getElementById('transactionDesc').value;
                let amount = parseFloat(document.getElementById('transactionAmount').value); // Nominal per bulan
                const type = document.querySelector('input[name="transactionType"]:checked').value;
                const who = document.getElementById('transactionWho').value;
                const startMonth = document.getElementById('paymentPeriodStartMonth').value;
                const endMonth = document.getElementById('paymentPeriodEndMonth').value;

                let actualAmount = amount; // Nominal yang akan dicatat di transaksi

                if (type === 'pemasukan' && startMonth && endMonth) {
                    const startIndex = months.indexOf(startMonth);
                    const endIndex = months.indexOf(endMonth);
                    if (startIndex !== -1 && endIndex !== -1 && startIndex <= endIndex) {
                        const numberOfMonths = endIndex - startIndex + 1;
                        actualAmount = amount * numberOfMonths; // Hitung total nominal
                    }
                }

                const newTransaction = {
                    tanggal: date,
                    keterangan: desc,
                    pemasukan: type === 'pemasukan' ? actualAmount : 0, // Gunakan actualAmount
                    pengeluaran: type === 'pengeluaran' ? amount : 0,
                    penyetorPengambil: who || 'Anonim'
                };

                // Tambahkan startMonth dan endMonth hanya jika ini adalah pemasukan dan keduanya dipilih
                if (type === 'pemasukan' && startMonth && endMonth) {
                    newTransaction.startMonth = startMonth;
                    newTransaction.endMonth = endMonth;
                }

                const spinner = document.getElementById('addTransactionSpinner');
                spinner.classList.remove('hidden');
                document.getElementById('transactionForm').querySelector('button[type="submit"]').disabled = true;

                addTransaction(newTransaction);

                spinner.classList.add('hidden');
                document.getElementById('transactionForm').querySelector('button[type="submit"]').disabled = false;
                document.getElementById('transactionForm').reset();
                document.getElementById('transactionDate').valueAsDate = new Date();
                populatePaymentPeriodDropdowns(); // Reset new payment period dropdowns
                closeModal('addTransactionModal');
            });

            // NEW: Transaction Form Submission (for EDITING)
            document.getElementById('editTransactionForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const docId = document.getElementById('editTransactionId').value;
                const date = document.getElementById('editTransactionDate').value;
                const desc = document.getElementById('editTransactionDesc').value;
                const amount = parseFloat(document.getElementById('editTransactionAmount').value);
                const type = document.querySelector('input[name="editTransactionType"]:checked').value;
                const who = document.getElementById('editTransactionWho').value;

                // For simplicity, editing does not support multi-month payments for now.
                // It will update a single transaction record.
                const updatedTransaction = {
                    tanggal: date,
                    keterangan: desc,
                    pemasukan: type === 'pemasukan' ? amount : 0,
                    pengeluaran: type === 'pengeluaran' ? amount : 0,
                    penyetorPengambil: who || 'Anonim'
                };
                
                const spinner = document.getElementById('editTransactionSpinner');
                spinner.classList.remove('hidden');
                document.getElementById('editTransactionForm').querySelector('button[type="submit"]').disabled = true;
                
                updateTransaction(docId, updatedTransaction);

                spinner.classList.add('hidden');
                document.getElementById('editTransactionForm').querySelector('button[type="submit"]').disabled = false;
                closeModal('editTransactionModal');
            });


            // Add Member Button
            document.getElementById('addMemberButton').addEventListener('click', async () => {
                const newMemberNameInput = document.getElementById('newMemberName');
                const memberName = newMemberNameInput.value.trim();
                if (memberName) {
                    const spinner = document.getElementById('addMemberSpinner');
                    spinner.classList.remove('hidden');
                    document.getElementById('addMemberButton').disabled = true;

                    addMember(memberName);

                    spinner.classList.add('hidden');
                    document.getElementById('addMemberButton').disabled = false;
                    newMemberNameInput.value = '';
                } else {
                    showConfirmationModal('Nama anggota tidak boleh kosong.', () => {});
                }
            });

            // Data Management Buttons
            document.getElementById('downloadDataButton').addEventListener('click', downloadDataAsJson);

            // New: Download Report Button
            document.getElementById('downloadReportButton').addEventListener('click', () => {
                generatePdfReport();
                document.getElementById('dataManagementMessage').textContent = 'Laporan berhasil diunduh sebagai laporan_uang_kas.pdf';
            });

            // Function to generate the PDF report
            function generatePdfReport() {
                // Initialize jsPDF with landscape orientation
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('landscape'); // Changed to landscape
                let yPos = 20;
                const margin = 20;
                const lineHeight = 7;

                // Define colors based on Tailwind palette
                const colorSlate900 = [15, 23, 42];
                const colorSlate500 = [100, 116, 139];
                const colorSlate800 = [30, 41, 59]; // Added for general text
                const colorSlate200 = [226, 232, 240]; // Added for table lines
                const colorEmerald600 = [5, 150, 105];
                const colorRed600 = [220, 38, 38];
                const colorAmber500 = [245, 158, 11];
                const colorSlate50 = [248, 250, 252];
                const colorWhite = [255, 255, 255];

                // Set default font size for the entire report
                const defaultFontSize = 11; // Increased by one level
                doc.setFont("helvetica", "normal");
                doc.setFontSize(defaultFontSize);
                doc.setTextColor(colorSlate800[0], colorSlate800[1], colorSlate800[2]);

                // Title
                doc.setFont("helvetica", "bold");
                doc.setFontSize(20); // Slightly larger for title (increased by one level)
                doc.setTextColor(colorSlate900[0], colorSlate900[1], colorSlate900[2]);
                doc.text("Laporan Uang Kas RA Tarbiyatul Aulad", doc.internal.pageSize.width / 2, yPos, { align: "center" });
                yPos += lineHeight * 2;

                doc.setFont("helvetica", "normal");
                doc.setFontSize(defaultFontSize); // Revert to default
                doc.setTextColor(colorSlate500[0], colorSlate500[1], colorSlate500[2]);
                doc.text(`Tanggal Laporan: ${new Date().toLocaleDateString('id-ID')}`, doc.internal.pageSize.width / 2, yPos, { align: "center" });
                yPos += lineHeight * 3; // More space after header

                // Section: Financial Summary (KPIs)
                doc.setFont("helvetica", "bold");
                doc.setFontSize(16); // Slightly larger for section titles (increased by one level)
                doc.setTextColor(colorSlate900[0], colorSlate900[1], colorSlate900[2]);
                doc.text("Ringkasan", margin, yPos);
                yPos += lineHeight;
                doc.setFont("helvetica", "bold"); // Make these bold
                doc.setFontSize(defaultFontSize); // Revert to default
                doc.setTextColor(colorSlate900[0], colorSlate900[1], colorSlate900[2]);

                const currentBalanceValue = cashflowData.reduce((acc, item) => acc + item.pemasukan - item.pengeluaran, 0);
                const totalIncomeValue = cashflowData.reduce((acc, item) => acc + item.pemasukan, 0);
                const totalExpenseValue = cashflowData.reduce((acc, item) => acc + item.pengeluaran, 0);

                doc.text(`Saldo Saat Ini    : ${formatCurrency(currentBalanceValue)}`, margin, yPos);
                yPos += lineHeight;
                
                doc.setTextColor(colorEmerald600[0], colorEmerald600[1], colorEmerald600[2]); // Green for Pemasukan
                doc.text(`Total Pemasukan   : ${formatCurrency(totalIncomeValue)}`, margin, yPos);
                yPos += lineHeight;

                doc.setTextColor(colorRed600[0], colorRed600[1], colorRed600[2]); // Red for Pengeluaran
                doc.text(`Total Pengeluaran : ${formatCurrency(totalExpenseValue)}`, margin, yPos);
                yPos += lineHeight * 2;

                // Reset color to default for next sections
                doc.setTextColor(colorSlate800[0], colorSlate800[1], colorSlate800[2]);
                doc.setFont("helvetica", "normal");

                // Section: Transaction Details (using autoTable)
                doc.setFont("helvetica", "bold");
                doc.setFontSize(16); // Slightly larger for section titles (increased by one level)
                doc.setTextColor(colorSlate900[0], colorSlate900[1], colorSlate900[2]);
                doc.text("Detail Semua Transaksi", margin, yPos);
                yPos += lineHeight;

                const transactionHeaders = [
                    { header: "Tanggal", dataKey: "tanggal" },
                    { header: "Keterangan", dataKey: "keterangan" },
                    { header: "Pemasukan", dataKey: "pemasukan" },
                    { header: "Pengeluaran", dataKey: "pengeluaran" }
                ];

                const transactionRows = cashflowData.sort((a, b) => new Date(a.tanggal) - new Date(b.tanggal)).map(item => ({
                    tanggal: new Date(item.tanggal).toLocaleDateString('id-ID'),
                    keterangan: `${item.keterangan} (${item.penyetorPengambil || 'Anonim'})`,
                    pemasukan: item.pemasukan > 0 ? formatCurrency(item.pemasukan) : '-',
                    pengeluaran: item.pengeluaran > 0 ? formatCurrency(item.pengeluaran) : '-'
                }));

                doc.autoTable({
                    startY: yPos,
                    head: [transactionHeaders.map(h => h.header)],
                    body: transactionRows.map(row => Object.values(row)),
                    theme: 'grid', // 'striped', 'grid', 'plain'
                    styles: {
                        font: 'helvetica',
                        fontSize: defaultFontSize, // Use default font size
                        cellPadding: 2,
                        textColor: colorSlate800,
                        lineColor: colorSlate200,
                        lineWidth: 0.1,
                    },
                    headStyles: {
                        fillColor: colorSlate50, // Background for header
                        textColor: colorSlate500, // Text color for header
                        fontStyle: 'bold',
                        halign: 'left',
                    },
                    bodyStyles: {
                        halign: 'left',
                    },
                    columnStyles: {
                        0: { cellWidth: 30 }, // Tanggal
                        1: { cellWidth: 80 }, // Keterangan
                        2: { halign: 'right', cellWidth: 40, textColor: colorEmerald600 }, // Pemasukan
                        3: { halign: 'right', cellWidth: 40, textColor: colorRed600 }, // Pengeluaran
                    },
                    margin: { left: margin, right: margin },
                    didDrawPage: function(data) {
                        yPos = data.cursor.y; // Update yPos after table
                    }
                });
                yPos = doc.autoTable.previous.finalY + lineHeight; // Update yPos after table

                // Section: Payment Status (Rincian Perbulan)
                doc.setFont("helvetica", "bold");
                doc.setFontSize(16); // Slightly larger for section titles (increased by one level)
                doc.setTextColor(colorSlate900[0], colorSlate900[1], colorSlate900[2]);
                doc.text("Rincian Perbulan", margin, yPos);
                yPos += lineHeight;

                // Get selected months for the PDF report
                const selectedPdfMonths = Array.from(document.querySelectorAll('#pdfMonthSelection input[name="pdfMonth"]:checked'))
                                     .map(checkbox => checkbox.value);

                // Prepare data for the monthly payment status table
                const monthlyPaymentHeaders = [{ header: "Nama Anggota", dataKey: "nama" }];
                selectedPdfMonths.forEach(month => { // Use selectedPdfMonths here
                    monthlyPaymentHeaders.push({ header: month, dataKey: month });
                });

                // Sort paymentData alphabetically by nama for the PDF report as well, and filter out system users
                const sortedMonthlyPaymentRows = [...paymentData]
                    .filter(member => !member.isSystem) // Exclude system users from this table
                    .sort((a, b) => a.nama.localeCompare(b.nama))
                    .map(member => {
                        const row = { nama: member.nama };
                        selectedPdfMonths.forEach(month => { // Use selectedPdfMonths here
                            row[month] = member.pembayaran[month] || 'Belum';
                        });
                        return row;
                    });

                doc.autoTable({
                    startY: yPos,
                    head: [monthlyPaymentHeaders.map(h => h.header)],
                    body: sortedMonthlyPaymentRows.map(row => Object.values(row)),
                    theme: 'grid',
                    styles: {
                        font: 'helvetica',
                        fontSize: 9, // Keep this font size as requested
                        cellPadding: 1, // Smaller padding for more compact table
                        textColor: colorSlate800,
                        lineColor: colorSlate200,
                        lineWidth: 0.1,
                    },
                    headStyles: {
                        fillColor: colorSlate50,
                        textColor: colorSlate500,
                        fontStyle: 'bold',
                        halign: 'center', // Center align headers
                    },
                    bodyStyles: {
                        halign: 'center', // Center align body cells
                    },
                    columnStyles: {
                        0: { halign: 'left', cellWidth: 40 }, // Nama Anggota
                        // Dynamically set column widths for months based on selectedPdfMonths
                        ...selectedPdfMonths.reduce((acc, monthName, i) => {
                            let width = 15; // Default width
                            if (['September', 'November', 'Desember'].includes(monthName)) {
                                width = 20; // Increased width for these months
                            }
                            acc[i + 1] = { cellWidth: width };
                            return acc;
                        }, {})
                    },
                    margin: { left: margin, right: margin },
                    didDrawPage: function(data) {
                        yPos = data.cursor.y; // Update yPos after table
                    },
                    didParseCell: function (data) {
                        // Apply color to status cells
                        if (data.section === 'body' && data.column.index > 0) { // Check if it's a month column
                            const status = data.cell.raw;
                            if (status === 'Lunas') {
                                data.cell.styles.textColor = colorEmerald600;
                            } else if (status === 'Belum') {
                                data.cell.styles.textColor = colorRed600;
                            }
                        }
                    }
                });
                yPos = doc.autoTable.previous.finalY + lineHeight; // Update yPos after table

                doc.save("laporan_uang_kas.pdf");
            }


            document.getElementById('uploadDataButton').addEventListener('click', () => {
                document.getElementById('uploadFileInput').click();
            });
            document.getElementById('uploadFileInput').addEventListener('change', loadDataFromFile);

            document.getElementById('clearInMemoryDataButton').addEventListener('click', clearInMemoryData); // Call clearInMemoryData (now clears Firebase)

            // Auto Download Setting (for local backup only)
            document.getElementById('autoDownloadInterval').addEventListener('change', (e) => {
                const minutes = parseInt(e.target.value);
                startAutoDownload(minutes);
            });

            // --- File Operations (Download/Upload for Backup) ---
            function downloadDataAsJson() {
                const dataToSave = {
                    cashflow: cashflowData,
                    payments: paymentData // paymentData will contain derived statuses when saved
                };
                const jsonString = JSON.stringify(dataToSave, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'data_uang_kas_backup.json'; // Changed filename to indicate backup
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                document.getElementById('dataManagementMessage').textContent = 'Data berhasil diunduh sebagai data_uang_kas_backup.json';
            }

            let autoDownloadIntervalId = null; // To store the interval ID
            let autoDownloadMinutes = 0; // Current interval in minutes

            function startAutoDownload(minutes) {
                if (autoDownloadIntervalId) {
                    clearInterval(autoDownloadIntervalId);
                }
                if (minutes > 0) {
                    autoDownloadMinutes = minutes;
                    autoDownloadIntervalId = setInterval(() => {
                        downloadDataAsJson();
                        document.getElementById('autoDownloadStatus').textContent = `Backup terakhir diunduh: ${new Date().toLocaleTimeString('id-ID')}`;
                    }, minutes * 60 * 1000); // Convert minutes to milliseconds
                    document.getElementById('autoDownloadStatus').textContent = `Backup otomatis aktif setiap ${minutes} menit.`;
                } else {
                    autoDownloadMinutes = 0;
                    document.getElementById('autoDownloadStatus').textContent = 'Backup otomatis nonaktif.';
                }
            }

            async function loadDataFromFile(event) {
                const file = event.target.files[0];
                if (!file) {
                    document.getElementById('dataManagementMessage').textContent = 'Tidak ada file yang dipilih.';
                    return;
                }

                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const loadedData = JSON.parse(e.target.result);
                        if (loadedData.cashflow && loadedData.payments) {
                            cashflowData = loadedData.cashflow;
                            paymentData = loadedData.payments;
                            await saveDataToFirestore(); // Save uploaded data to Firebase
                            document.getElementById('dataManagementMessage').textContent = `Data berhasil dimuat dari file "${file.name}" dan disimpan ke Firebase.`;
                        } else {
                            document.getElementById('dataManagementMessage').textContent = 'Format file JSON tidak valid. Pastikan berisi "cashflow" dan "payments".';
                        }
                    } catch (error) {
                        console.error('Error parsing JSON or saving to Firestore:', error);
                        document.getElementById('dataManagementMessage').textContent = `Gagal memuat file: ${error.message}. Pastikan file adalah JSON yang valid.`;
                    }
                };
                reader.onerror = () => {
                    document.getElementById('dataManagementMessage').textContent = 'Gagal membaca file.';
                };
                reader.readAsText(file);
            }

            // AI Features Logic
            document.getElementById('generateSpendingAnalysis').addEventListener('click', async () => {
                const selectedMonth = document.getElementById('aiMonthFilter').value;
                const filteredExpenses = cashflowData.filter(item => {
                    const itemMonth = new Date(item.tanggal).toLocaleString('id-ID', { month: 'long', year: 'numeric' });
                    return itemMonth === selectedMonth && item.pengeluaran > 0;
                });

                let expenseDetails = filteredExpenses.map(item =>
                    `- ${item.keterangan} (${item.penyetorPengambil || 'Anonim'}): ${formatCurrency(item.pengeluaran)}`
                ).join('\n');

                if (expenseDetails === '') {
                    expenseDetails = 'Tidak ada pengeluaran tercatat untuk bulan ini.';
                }

                const prompt = `Berdasarkan data transaksi pengeluaran berikut untuk bulan ${selectedMonth}:\n${expenseDetails}\n\nBerikan ringkasan singkat tentang pola pengeluaran utama dan kategori terbesar untuk bulan ini. Fokus pada pengeluaran. Format sebagai paragraf singkat dalam bahasa Indonesia.`;

                await callGeminiAPI(
                    prompt,
                    document.getElementById('spendingAnalysisOutput'),
                    document.getElementById('spendingAnalysisSpinner')
                );
            });

            document.getElementById('generatePaymentReminder').addEventListener('click', async () => {
                // For the AI reminder, we will now consider all months to find unpaid members
                let unpaidMembersByMonth = {};
                months.forEach(month => { // Iterate through all months
                    unpaidMembersByMonth[month] = paymentData.filter(member =>
                        !member.isSystem && member.pembayaran[month] === 'Belum'
                    ).map(member => member.nama);
                });

                let reminderTextParts = [];
                for (const month of months) { // Iterate through all months for the reminder text
                    if (unpaidMembersByMonth[month].length > 0) {
                        reminderTextParts.push(`anggota berikut yang belum membayar iuran bulan ${month}: ${unpaidMembersByMonth[month].join(', ')}`);
                    }
                }

                let prompt = '';
                if (reminderTextParts.length > 0) {
                    prompt = `Buatkan draf pesan pengingat pembayaran iuran kas yang sopan untuk ${reminderTextParts.join(' dan ')}. Pesan harus singkat, jelas, dan mendorong pembayaran tanpa terkesan menuntut. Mulai dengan sapaan umum dan sebutkan bulan iuran. Format sebagai paragraf singkat dalam bahasa Indonesia.`;
                } else {
                    prompt = 'Tidak ada anggota yang belum membayar untuk bulan yang dipilih.';
                }

                await callGeminiAPI(
                    prompt,
                    document.getElementById('paymentReminderOutput'),
                    document.getElementById('paymentReminderSpinner')
                );
            });

            async function callGeminiAPI(prompt, outputElement, spinnerElement) {
                outputElement.innerHTML = '<p class="text-slate-500">Memuat...</p>';
                spinnerElement.classList.remove('hidden');
                try {
                    let chatHistory = [];
                    chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                    const payload = { contents: chatHistory };
                    const apiKey = ""; // API key will be provided by Canvas runtime
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                    const response = await fetch(apiUrl, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(payload)
                            });
                    const result = await response.json();
                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        const text = result.candidates[0].content.parts[0].text;
                        outputElement.innerHTML = `<p>${text}</p>`;
                    } else {
                        outputElement.innerHTML = `<p class="text-red-500">Gagal mendapatkan respons dari AI. Coba lagi.</p>`;
                    }
                } catch (error) {
                    console.error('Error calling Gemini API:', error);
                    outputElement.innerHTML = `<p class="text-red-500">Terjadi kesalahan: ${error.message}.</p>`;
                } finally {
                    spinnerElement.classList.add('hidden');
                }
            }

            document.getElementById('transactionDate').valueAsDate = new Date();

            // PDF Report Month Selection Logic
            const pdfMonthSelectionDiv = document.getElementById('pdfMonthSelection');
            const selectAllPdfMonthsButton = document.getElementById('selectAllPdfMonths');
            const clearAllPdfMonthsButton = document.getElementById('clearAllPdfMonths');

            function populatePdfMonthCheckboxes() {
                pdfMonthSelectionDiv.innerHTML = '';
                months.forEach((month, index) => {
                    const div = document.createElement('div');
                    div.className = 'flex items-center';
                    div.innerHTML = `
                        <input type="checkbox" id="pdfMonth-${index}" name="pdfMonth" value="${month}" class="form-checkbox h-4 w-4 text-amber-600 rounded focus:ring-amber-500" checked>
                        <label for="pdfMonth-${index}" class="ml-2 text-sm text-slate-700">${month}</label>
                    `;
                    pdfMonthSelectionDiv.appendChild(div);
                });
            }

            selectAllPdfMonthsButton.addEventListener('click', () => {
                document.querySelectorAll('#pdfMonthSelection input[type="checkbox"]').forEach(checkbox => {
                    checkbox.checked = true;
                });
            });

            clearAllPdfMonthsButton.addEventListener('click', () => {
                document.querySelectorAll('#pdfMonthSelection input[type="checkbox"]').forEach(checkbox => {
                    checkbox.checked = false;
                });
            });

            // Call this on initial load
            populatePdfMonthCheckboxes();

            // Initial render of UI. Data will be loaded via Firebase onAuthStateChanged.
            renderAllUI();
            // Set auto download to nonaktif by default
            startAutoDownload(0);
        });
    </script>
</body>
</html>
