<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Uang Kas RA Tarbiyatul Aulad</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/jspdf-autotable@3.5.25/dist/jspdf.plugin.autotable.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chosen Palette: Warm Neutrals (Slate, Stone, Amber, with Emerald/Red for status) -->
    <!-- Application Structure Plan: A dashboard-style layout is chosen for optimal usability. It starts with high-level Key Performance Indicators (KPIs) like current balance for a quick overview. This is followed by visual charts (cashflow trend, income vs. expense) to provide deeper context and show performance over time. Finally, a tabbed section offers detailed, granular data (transaction history and payment status) without cluttering the main view. A new section for AI-powered insights has1 been added, allowing users to generate spending analyses and payment reminder drafts using the Gemini API, further enhancing data utility and task automation. New sections for member management and detailed transaction input are added, along with global save/delete options, all powered by Firebase persistence with Google login. -->
    <!-- Visualization & Content Choices:
        - Report Info: Final Saldo -> Goal: Inform -> Viz: KPI Card -> Interaction: None -> Justification: Most critical metric, needs immediate visibility -> Library/Method: HTML/Tailwind.
        - Report Info: Saldo over time -> Goal: Change -> Viz: Line Chart -> Interaction: Hover for tooltip -> Justification: Clearly shows financial health trend -> Library/Method: Chart.js (Canvas).
        - Report Info: Monthly Pemasukan vs. Pengeluaran -> Goal: Compare -> Viz: Bar Chart -> Interaction: Hover for tooltip -> Justification: Easy comparison of monthly financial activity -> Library/Method: Chart.js (Canvas).
        - Report Info: Cashflow log -> Goal: Organize -> Viz: Table -> Interaction: Search, Delete Transaction -> Justification: Allows users to find and manage specific transactions easily -> Library/Method: HTML/Tailwind + JS.
        - Report Info: Member payment status -> Goal: Organize/Compare -> Viz: Table/Grid -> Interaction: Filter by month, Add/Delete Member, **Automatic Payment Status Update based on payer and income transaction** -> Justification: Quick visual check of who has paid, with color-coding for clarity, and full member management, now automated for accuracy with improved input and simplified payment logic -> Library/Method: HTML/Tailwind + JS.
        - Report Info: Detailed Transaction Input -> Goal: Record -> Viz: Form -> Interaction: Input fields, radio buttons, submit button, Payer dropdown -> Justification: Allows granular entry of financial activities with standardized payer selection -> Library/Method: HTML/Tailwind + JS.
        - Report Info: All data persistence -> Goal: Store/Retrieve -> Viz: None -> Interaction: Download JSON, Upload JSON, Clear In-memory Data -> Justification: Essential for long-term data management and portability, now primarily via Firebase. -> Library/Method: Firebase Firestore + File (JSON) via JS Blob/FileReader.
    -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* slate-50 */
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            height: 350px;
            max-height: 400px;
        }
        @media (max-width: 768px) {
            .chart-container {
                height: 300px;
            }
        }
        .tab-button.active {
            border-color: #f59e0b; /* amber-500 */
            color: #f59e0b; /* amber-500 */
            font-weight: 600;
        }
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #f59e0b;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-left: 8px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            width: 80%;
            max-width: 500px;
            text-align: left; /* Changed from center to left */
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
    </style>
    <!-- Firebase SDKs - V9 Compatibility (for easier integration with existing code structure) -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
</head>
<body class="text-slate-800">

    <div class="container mx-auto p-4 md:p-8">

        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-slate-900">Uang Kas RA Tarbiyatul Aulad</h1>
            <p class="text-slate-500 mt-2">Semangat!</p>
            <!-- Firebase Login/Logout UI -->
            <div class="mt-4 flex flex-col sm:flex-row justify-center items-center gap-4">
                <div id="authStatus" class="text-slate-600 font-medium">Memuat status autentikasi...</div>
                <button id="signInButton" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out hidden">
                    Login dengan Google
                </button>
                <button id="signOutButton" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out hidden">
                    Logout
                </button>
            </div>
        </header>

        <main id="appContent" class="hidden"> <!-- Hidden until user logs in -->
            <!-- Section: Key Metrics -->
            <section id="kpi" class="mb-8">
                 <div class="grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-6">
                    <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                        <h3 class="text-slate-500 font-medium mb-2">Saldo Saat Ini</h3>
                        <p id="currentBalance" class="text-3xl font-bold text-slate-900">Rp 0</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                        <h3 class="text-slate-500 font-medium mb-2">Total Pemasukan</h3>
                        <p id="totalIncome" class="text-3xl font-bold text-emerald-600">Rp 0</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                        <h3 class="text-slate-500 font-medium mb-2">Total Pengeluaran</h3>
                        <p id="totalExpense" class="text-3xl font-bold text-red-600">Rp 0</p>
                    </div>
                </div>
            </section>

            <!-- Section: Visualizations -->
            <section id="visualizations" class="mb-8 grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-white p-4 md:p-6 rounded-xl border border-slate-200 shadow-sm">
                    <h3 class="text-lg font-semibold mb-1 text-slate-900">Tren Arus Kas (Saldo)</h3>
                    <p class="text-sm text-slate-500 mb-4">Grafik ini menunjukkan perubahan saldo kas dari waktu ke waktu, memberikan gambaran tentang kesehatan finansial secara keseluruhan.</p>
                    <div class="chart-container">
                        <canvas id="cashflowChart"></canvas>
                    </div>
                </div>
                <div class="bg-white p-4 md:p-6 rounded-xl border border-slate-200 shadow-sm">
                    <h3 class="text-lg font-semibold mb-1 text-slate-900">Pemasukan vs Pengeluaran Bulanan</h3>
                     <p class="text-sm text-slate-500 mb-4">Bandingkan total pemasukan dan pengeluaran setiap bulan untuk melihat pola aktivitas keuangan.</p>
                    <div class="chart-container">
                        <canvas id="monthlyComparisonChart"></canvas>
                    </div>
                </div>
            </section>

            <!-- Section: Detailed Data -->
            <section id="details" class="mb-8">
                <div class="bg-white rounded-xl border border-slate-200 shadow-sm">
                    <div class="border-b border-slate-200">
                        <nav class="flex space-x-2 p-2" aria-label="Tabs">
                            <button id="tab-transactions" class="tab-button active px-4 py-2 text-sm font-medium text-slate-600 rounded-lg border-b-2 border-transparent hover:text-amber-600 focus:outline-none">
                                Riwayat Transaksi
                            </button>
                            <button id="tab-payments" class="tab-button px-4 py-2 text-sm font-medium text-slate-600 rounded-lg border-b-2 border-transparent hover:text-amber-600 focus:outline-none">
                                Status Pembayaran Anggota
                            </button>
                            <!-- The input tab is now a button inside the transactions tab -->
                            <button id="tab-member-management" class="tab-button px-4 py-2 text-sm font-medium text-slate-600 rounded-lg border-b-2 border-transparent hover:text-amber-600 focus:outline-none">
                                Kelola Anggota
                            </button>
                        </nav>
                    </div>

                    <div id="content-transactions" class="p-4 md:p-6">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4">
                            <h3 class="text-lg font-semibold text-slate-900">Detail Semua Transaksi</h3>
                            <button id="showNewTransactionModal" class="mt-2 sm:mt-0 bg-amber-500 hover:bg-amber-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out flex items-center">
                                Tambah Transaksi Baru
                            </button>
                        </div>
                        <p class="text-sm text-slate-500 mb-4">Gunakan kolom pencarian dan filter untuk menemukan transaksi spesifik.</p>
                        <div class="flex flex-wrap items-center gap-4 mb-4">
                            <input type="text" id="transactionSearch" placeholder="Cari transaksi..." class="flex-grow p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-400 focus:border-amber-400">
                            <div class="flex items-center space-x-2">
                                <label for="transactionFilterType" class="text-sm font-medium text-slate-700">Filter:</label>
                                <select id="transactionFilterType" class="p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-400 focus:border-amber-400">
                                    <option value="all">Semua</option>
                                    <option value="pemasukan">Pemasukan</option>
                                    <option value="pengeluaran">Pengeluaran</option>
                                </select>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-slate-200">
                                <thead class="bg-slate-50">
                                    <tr>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Tanggal</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Keterangan</th>
                                        <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-slate-500 uppercase tracking-wider">Pemasukan</th>
                                        <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-slate-500 uppercase tracking-wider">Pengeluaran</th>
                                        <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-slate-500 uppercase tracking-wider">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="transactionTableBody" class="bg-white divide-y divide-slate-200">
                                    <!-- Rows will be inserted by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div id="content-payments" class="hidden p-4 md:p-6">
                        <h3 class="text-lg font-semibold mb-1 text-slate-900">Status Pembayaran Iuran Kas</h3>
                        <p class="text-sm text-slate-500 mb-4">Berikut adalah status pembayaran iuran kas per bulan untuk setiap anggota.</p>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-slate-200">
                                <thead class="bg-slate-50">
                                    <tr id="paymentTableHeader">
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider sticky left-0 bg-slate-50 z-10">Nama Anggota</th>
                                        <!-- Month headers will be inserted by JavaScript -->
                                    </tr>
                                </thead>
                                <tbody id="paymentTableBody" class="bg-white divide-y divide-slate-200">
                                    <!-- Rows will be inserted by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- The input transaction form is now a modal -->
                    <div id="newTransactionModal" class="modal">
                        <div class="modal-content">
                            <div class="flex justify-between items-center border-b pb-2 mb-4">
                                <h3 class="text-xl font-semibold text-slate-900">Input Transaksi Baru</h3>
                                <span class="close-button" id="closeNewTransactionModal">&times;</span>
                            </div>
                            <form id="transactionForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <!-- Existing form fields -->
                                <div>
                                    <label for="transactionDate" class="block text-sm font-medium text-slate-700">Tanggal</label>
                                    <input type="date" id="transactionDate" class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-amber-500 focus:border-amber-500" required>
                                </div>
                                <div>
                                    <label for="transactionDesc" class="block text-sm font-medium text-slate-700">Keterangan</label>
                                    <input type="text" id="transactionDesc" placeholder="Contoh: Pembelian buku kas" class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-amber-500 focus:border-amber-500" required>
                                </div>
                                <div>
                                    <label for="transactionAmount" class="block text-sm font-medium text-slate-700">Nominal (Rp)</label>
                                    <input type="number" id="transactionAmount" placeholder="Contoh: 50000" class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-amber-500 focus:border-amber-500" required min="0">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700">Jenis Transaksi</label>
                                    <div class="mt-1 flex flex-row items-center space-x-4">
                                        <label class="inline-flex items-center">
                                            <input type="radio" name="transactionType" value="pemasukan" class="form-radio text-emerald-600" checked>
                                            <span class="ml-2 text-slate-700">Pemasukan</span>
                                        </label>
                                        <label class="inline-flex items-center">
                                            <input type="radio" name="transactionType" value="pengeluaran" class="form-radio text-red-600">
                                            <span class="ml-2 text-slate-700">Pengeluaran</span>
                                        </label>
                                    </div>
                                </div>
                                <div class="md:col-span-2">
                                    <label for="transactionWho" class="block text-sm font-medium text-slate-700">Penyetor / Pengambil</label>
                                    <select id="transactionWho" class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-amber-500 focus:border-amber-500">
                                        <option value="">Pilih Anggota (Opsional)</option>
                                        <!-- Options will be populated by JavaScript -->
                                    </select>
                                </div>
                                <!-- New fields for multi-month payment -->
                                <div class="md:col-span-2">
                                    <label for="paymentPeriodStartMonth" class="block text-sm font-medium text-slate-700">Pembayaran Untuk Bulan (Mulai)</label>
                                    <select id="paymentPeriodStartMonth" class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-amber-500 focus:border-amber-500">
                                        <option value="">Pilih Bulan (Opsional)</option>
                                        <!-- Options will be populated by JavaScript -->
                                    </select>
                                </div>
                                <div class="md:col-span-2">
                                    <label for="paymentPeriodEndMonth" class="block text-sm font-medium text-slate-700">Pembayaran Untuk Bulan (Akhir)</label>
                                    <select id="paymentPeriodEndMonth" class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-amber-500 focus:border-amber-500">
                                        <option value="">Pilih Bulan (Opsional)</option>
                                        <!-- Options will be populated by JavaScript -->
                                    </select>
                                </div>
                                <!-- End new fields -->
                                <input type="hidden" id="transactionId" value="">
                                <div class="md:col-span-2 flex justify-end">
                                    <button type="submit" class="bg-amber-500 hover:bg-amber-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out flex items-center">
                                        Tambah Transaksi
                                        <span id="addTransactionSpinner" class="loading-spinner hidden"></span>
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <div id="content-member-management" class="hidden p-4 md:p-6">
                        <h3 class="text-lg font-semibold mb-1 text-slate-900">Kelola Anggota</h3>
                        <p class="text-sm text-slate-500 mb-4">Tambahkan, edit, atau hapus anggota yang akan membayar uang kas.</p>
                        <div class="mb-4 flex flex-col sm:flex-row gap-2">
                            <input type="text" id="newMemberName" placeholder="Nama Anggota Baru" class="flex-grow p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-400 focus:border-amber-400">
                            <button id="addMemberButton" class="bg-emerald-500 hover:bg-emerald-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out flex items-center justify-center">
                                Tambah Anggota
                                <span id="addMemberSpinner" class="loading-spinner hidden"></span>
                            </button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-slate-200">
                                <thead class="bg-slate-50">
                                    <tr>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Nama Anggota</th>
                                        <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-slate-500 uppercase tracking-wider">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="memberTableBody" class="bg-white divide-y divide-slate-200">
                                    <!-- Rows will be inserted by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Section: Other tools/info -->
            <section id="other-tools" class="mb-8">
                <div class="bg-white p-4 md:p-6 rounded-xl border border-slate-200 shadow-sm">
                    <h2 class="text-xl font-semibold mb-4 text-slate-900">Alat dan Laporan Lainnya</h2>
                    <p class="text-sm text-slate-500 mb-4">...
                        <div class="mt-4 flex flex-col md:flex-row md:items-center space-y-4 md:space-y-0 md:space-x-4">
                            <div class="flex-grow">
                                <h3 class="text-md font-semibold text-slate-800 mb-2">Simpan/Muat data</h3>
                                <p class="text-sm text-slate-600 mb-2">Simpan data Anda ke file JSON atau muat data yang sudah ada.</p>
                                <div class="flex space-x-2">
                                    <button id="saveDataButton" class="bg-blue-500 hover:bg-blue-600 text-white text-sm font-semibold py-2 px-3 rounded-lg shadow-md transition duration-300">Simpan sebagai JSON</button>
                                    <input type="file" id="loadDataInput" class="hidden" accept=".json">
                                    <button id="loadDataButton" class="bg-slate-500 hover:bg-slate-600 text-white text-sm font-semibold py-2 px-3 rounded-lg shadow-md transition duration-300">Muat dari JSON</button>
                                </div>
                            </div>
                            <div class="md:border-l md:pl-4 border-slate-200">
                                <h3 class="text-md font-semibold text-slate-800 mb-2">Hapus Semua Data</h3>
                                <p class="text-sm text-slate-600 mb-2"><strong>PERINGATAN:</strong> Ini akan menghapus semua data transaksi dan anggota di database Anda.</p>
                                <button id="clearAllDataButton" class="bg-red-500 hover:bg-red-600 text-white text-sm font-semibold py-2 px-3 rounded-lg shadow-md transition duration-300">Hapus Semua Data</button>
                            </div>
                        </div>
                </div>
            </section>

            <!-- Section: PDF Reports -->
            <section id="pdf-reports" class="mb-8">
                <div class="bg-white p-4 md:p-6 rounded-xl border border-slate-200 shadow-sm">
                    <h2 class="text-xl font-semibold mb-4 text-slate-900">Laporan PDF</h2>
                    <p class="text-sm text-slate-500 mb-4">Buat laporan PDF bulanan untuk riwayat transaksi atau status pembayaran. Opsi untuk mengunduh otomatis laporan setiap akhir bulan.</p>

                    <div class="flex flex-col md:flex-row gap-6">
                        <!-- Transaction Report Generation -->
                        <div class="flex-1">
                            <h3 class="text-lg font-semibold mb-2 text-slate-900">Laporan Transaksi</h3>
                            <div class="flex flex-wrap items-center gap-2 mb-4">
                                <select id="pdfMonthFilter" class="p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-400 focus:border-amber-400">
                                    <!-- Month options will be populated by JS -->
                                </select>
                                <select id="pdfYearFilter" class="p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-400 focus:border-amber-400">
                                    <!-- Year options will be populated by JS -->
                                </select>
                                <button id="generatePdfButton" class="bg-amber-500 hover:bg-amber-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out">
                                    Buat Laporan PDF
                                </button>
                            </div>
                            <p class="text-xs text-slate-500">Pilih bulan dan tahun untuk laporan transaksi.</p>
                        </div>
                        <!-- Payment Status Report Generation -->
                        <div class="flex-1">
                            <h3 class="text-lg font-semibold mb-2 text-slate-900">Laporan Pembayaran</h3>
                            <div class="flex flex-col gap-2">
                                <div id="pdfMonthSelection" class="grid grid-cols-2 sm:grid-cols-3 gap-2">
                                    <!-- Checkboxes populated by JS -->
                                </div>
                                <div class="flex gap-2 mt-2">
                                    <button id="selectAllPdfMonthsButton" class="bg-slate-300 hover:bg-slate-400 text-slate-800 text-sm font-semibold py-1 px-2 rounded-md">Pilih Semua</button>
                                    <button id="clearAllPdfMonthsButton" class="bg-slate-300 hover:bg-slate-400 text-slate-800 text-sm font-semibold py-1 px-2 rounded-md">Kosongkan</button>
                                    <button id="generatePaymentPdfButton" class="bg-amber-500 hover:bg-amber-600 text-white font-semibold py-1 px-2 rounded-lg shadow-md transition duration-300 ease-in-out">
                                        Buat Laporan Pembayaran
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-8 pt-4 border-t border-slate-200">
                         <h3 class="text-lg font-semibold mb-2 text-slate-900">Opsi Otomatisasi</h3>
                         <div class="flex flex-col md:flex-row justify-between items-start md:items-center">
                            <div class="flex-1 mb-4 md:mb-0">
                                <p class="text-sm text-slate-500">Atur pengunduhan laporan PDF otomatis untuk transaksi di akhir setiap bulan.</p>
                                <p class="text-sm font-medium text-slate-700 mt-1">Status: <span id="autoDownloadStatus" class="font-bold text-red-600">Nonaktif</span></p>
                            </div>
                            <div class="flex-shrink-0 flex items-center space-x-2">
                                <button id="autoDownloadOn" class="bg-emerald-500 hover:bg-emerald-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out">
                                    Aktifkan
                                </button>
                                <button id="autoDownloadOff" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out">
                                    Nonaktifkan
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
        <!-- Confirmation Modal -->
        <div id="confirmationModal" class="modal">
            <div class="modal-content">
                <p class="text-lg font-medium text-slate-800 mb-4" id="confirmationMessage">Apakah Anda yakin?</p>
                <div class="flex justify-end space-x-4">
                    <button id="cancelButton" class="bg-slate-300 hover:bg-slate-400 text-slate-800 font-semibold py-2 px-4 rounded-lg transition duration-300">Batal</button>
                    <button id="confirmButton" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-300">Konfirmasi</button>
                </div>
            </div>
        </div>

        <!-- Message Modal -->
        <div id="messageModal" class="modal">
            <div class="modal-content">
                <div class="flex justify-between items-center border-b pb-2 mb-4">
                    <h3 class="text-xl font-semibold text-slate-900">Pesan</h3>
                    <span class="close-button" id="closeMessageModal">&times;</span>
                </div>
                <p class="text-lg font-medium text-slate-800 mb-4" id="messageText">...</p>
                <div class="flex justify-end">
                    <button id="closeMessageButton" class="bg-amber-500 hover:bg-amber-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-300">Tutup</button>
                </div>
            </div>
        </div>
    </div>

    <!-- The Javascript is now a separate script block to organize it better -->
    <script>
        // Global variables for Firebase and App data
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        let app;
        let db;
        let auth;
        let userId;

        // Data arrays for transactions and members
        let transactions = [];
        let members = [];
        let paymentStatuses = {}; // { memberId: { month: isPaid, ... } }

        // Chart instances
        let cashflowChart, monthlyComparisonChart;

        // DOM Elements
        const authStatus = document.getElementById('authStatus');
        const signInButton = document.getElementById('signInButton');
        const signOutButton = document.getElementById('signOutButton');
        const appContent = document.getElementById('appContent');

        // Tab and Content Elements
        const tabs = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('#content-transactions, #content-payments, #content-member-management');
        const tabTransactions = document.getElementById('tab-transactions');
        const tabPayments = document.getElementById('tab-payments');
        const tabMemberManagement = document.getElementById('tab-member-management');

        // Transactions Tab Elements
        const transactionTableBody = document.getElementById('transactionTableBody');
        const transactionSearch = document.getElementById('transactionSearch');
        const transactionFilterType = document.getElementById('transactionFilterType');
        const showNewTransactionModal = document.getElementById('showNewTransactionModal');

        // Transaction Form Modal Elements
        const newTransactionModal = document.getElementById('newTransactionModal');
        const closeNewTransactionModal = document.getElementById('closeNewTransactionModal');
        const transactionForm = document.getElementById('transactionForm');
        const transactionDateInput = document.getElementById('transactionDate');
        const transactionDescInput = document.getElementById('transactionDesc');
        const transactionAmountInput = document.getElementById('transactionAmount');
        const transactionWhoSelect = document.getElementById('transactionWho');
        const transactionIdInput = document.getElementById('transactionId');
        const transactionFormButton = document.querySelector('#transactionForm button[type="submit"]');

        // Payment Tab Elements
        const paymentTableHeader = document.getElementById('paymentTableHeader');
        const paymentTableBody = document.getElementById('paymentTableBody');

        // Member Management Elements
        const newMemberNameInput = document.getElementById('newMemberName');
        const addMemberButton = document.getElementById('addMemberButton');
        const memberTableBody = document.getElementById('memberTableBody');

        // UI for PDF Reports
        const pdfMonthFilter = document.getElementById('pdfMonthFilter');
        const pdfYearFilter = document.getElementById('pdfYearFilter');
        const generatePdfButton = document.getElementById('generatePdfButton');
        const generatePaymentPdfButton = document.getElementById('generatePaymentPdfButton');
        const pdfMonthSelectionDiv = document.getElementById('pdfMonthSelection');
        const selectAllPdfMonthsButton = document.getElementById('selectAllPdfMonthsButton');
        const clearAllPdfMonthsButton = document.getElementById('clearAllPdfMonthsButton');
        const autoDownloadStatus = document.getElementById('autoDownloadStatus');
        const autoDownloadOnButton = document.getElementById('autoDownloadOn');
        const autoDownloadOffButton = document.getElementById('autoDownloadOff');

        // UI for Other Tools
        const saveDataButton = document.getElementById('saveDataButton');
        const loadDataButton = document.getElementById('loadDataButton');
        const loadDataInput = document.getElementById('loadDataInput');
        const clearAllDataButton = document.getElementById('clearAllDataButton');

        // Confirmation and Message Modals
        const confirmationModal = document.getElementById('confirmationModal');
        const confirmationMessage = document.getElementById('confirmationMessage');
        const confirmButton = document.getElementById('confirmButton');
        const cancelButton = document.getElementById('cancelButton');
        const messageModal = document.getElementById('messageModal');
        const messageText = document.getElementById('messageText');
        const closeMessageModal = document.getElementById('closeMessageModal');
        const closeMessageButton = document.getElementById('closeMessageButton');

        //----------------------------------------------------------------------
        // Initialization
        //----------------------------------------------------------------------

        // Firebase Initialization
        function initializeFirebase() {
            try {
                if (firebase.apps.length === 0) {
                    firebase.initializeApp(firebaseConfig);
                    app = firebase.app();
                    auth = firebase.auth();
                    db = firebase.firestore();
                } else {
                    app = firebase.app();
                    auth = firebase.auth();
                    db = firebase.firestore();
                }
                console.log("Firebase initialized successfully.");

                auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        userId = user.uid;
                        authStatus.textContent = 'Terautentikasi: ' + (user.displayName || user.email);
                        signInButton.classList.add('hidden');
                        signOutButton.classList.remove('hidden');
                        appContent.classList.remove('hidden');
                        console.log("User signed in with UID:", userId);
                        await setupFirestoreListeners();
                        renderAllUI();
                    } else {
                        userId = null;
                        authStatus.textContent = 'Belum terautentikasi';
                        signInButton.classList.remove('hidden');
                        signOutButton.classList.add('hidden');
                        appContent.classList.add('hidden');
                        console.log("User signed out.");
                        // Clear data on logout
                        transactions = [];
                        members = [];
                        paymentStatuses = {};
                        renderAllUI();
                        // Sign in anonymously
                        if (typeof __initial_auth_token !== 'undefined') {
                            await auth.signInWithCustomToken(__initial_auth_token);
                        } else {
                            await auth.signInAnonymously();
                        }
                    }
                });

            } catch (error) {
                console.error("Error initializing Firebase:", error);
            }
        }

        // Setup Real-time Firestore Listeners
        function setupFirestoreListeners() {
            if (!userId) return;

            const transactionsPath = `artifacts/${appId}/users/${userId}/transactions`;
            const membersPath = `artifacts/${appId}/users/${userId}/members`;

            // Transaction listener
            db.collection(transactionsPath).onSnapshot(snapshot => {
                transactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                transactions.sort((a, b) => new Date(a.date) - new Date(b.date));
                console.log("Transactions updated:", transactions);
                renderTransactionsTable();
                renderCharts();
                renderPaymentStatus();
                populateFilters();
            }, error => {
                console.error("Error fetching transactions:", error);
            });

            // Member listener
            db.collection(membersPath).onSnapshot(snapshot => {
                members = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                members.sort((a, b) => a.name.localeCompare(b.name));
                console.log("Members updated:", members);
                renderMemberTable();
                populateMemberSelect();
                renderPaymentStatus();
            }, error => {
                console.error("Error fetching members:", error);
            });
        }

        //----------------------------------------------------------------------
        // UI Rendering Functions
        //----------------------------------------------------------------------

        function renderAllUI() {
            renderKPIs();
            renderCharts();
            renderTransactionsTable();
            renderPaymentStatus();
            renderMemberTable();
            populateMemberSelect();
            populateFilters();
        }

        function renderKPIs() {
            const totalIncome = transactions.filter(t => t.type === 'pemasukan').reduce((sum, t) => sum + t.amount, 0);
            const totalExpense = transactions.filter(t => t.type === 'pengeluaran').reduce((sum, t) => sum + t.amount, 0);
            const currentBalance = totalIncome - totalExpense;

            document.getElementById('currentBalance').textContent = `Rp ${formatCurrency(currentBalance)}`;
            document.getElementById('totalIncome').textContent = `Rp ${formatCurrency(totalIncome)}`;
            document.getElementById('totalExpense').textContent = `Rp ${formatCurrency(totalExpense)}`;
        }

        function renderTransactionsTable() {
            transactionTableBody.innerHTML = '';
            let filteredTransactions = transactions;

            // Apply text search filter
            const searchTerm = transactionSearch.value.toLowerCase();
            if (searchTerm) {
                filteredTransactions = filteredTransactions.filter(t => t.description.toLowerCase().includes(searchTerm));
            }

            // Apply type filter
            const filterType = transactionFilterType.value;
            if (filterType !== 'all') {
                filteredTransactions = filteredTransactions.filter(t => t.type === filterType);
            }

            if (filteredTransactions.length === 0) {
                transactionTableBody.innerHTML = `
                    <tr>
                        <td colspan="5" class="px-6 py-4 text-center text-sm text-slate-500">Tidak ada transaksi yang ditemukan.</td>
                    </tr>
                `;
                return;
            }

            filteredTransactions.forEach(t => {
                const row = document.createElement('tr');
                const isIncome = t.type === 'pemasukan';
                const amountText = formatCurrency(t.amount);
                const whoText = t.who ? members.find(m => m.id === t.who)?.name || 'Anggota dihapus' : 'Tidak Diketahui';

                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-slate-900">${formatDate(t.date)}</div>
                        <div class="text-xs text-slate-500">${whoText}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-slate-900">${t.description}</div>
                        ${t.paymentForMonth ? `<div class="text-xs text-slate-500">Pembayaran untuk: ${t.paymentForMonth}</div>` : ''}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium text-emerald-600">${isIncome ? `Rp ${amountText}` : ''}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium text-red-600">${!isIncome ? `Rp ${amountText}` : ''}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button class="edit-transaction-button text-amber-600 hover:text-amber-900 mr-2" data-id="${t.id}">Edit</button>
                        <button class="delete-transaction-button text-red-600 hover:text-red-900" data-id="${t.id}">Hapus</button>
                    </td>
                `;
                transactionTableBody.appendChild(row);
            });
        }

        function renderPaymentStatus() {
            paymentTableHeader.innerHTML = `<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider sticky left-0 bg-slate-50 z-10">Nama Anggota</th>`;
            paymentTableBody.innerHTML = '';
            paymentStatuses = {}; // Reset payment status

            const allMonths = [...new Set(transactions.map(t => formatDateToMonthYear(t.date)))].sort((a, b) => new Date(`01 ${a}`) - new Date(`01 ${b}`));
            allMonths.forEach(month => {
                const th = document.createElement('th');
                th.scope = 'col';
                th.className = 'px-6 py-3 text-center text-xs font-medium text-slate-500 uppercase tracking-wider';
                th.textContent = month;
                paymentTableHeader.appendChild(th);
            });

            members.forEach(member => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap font-medium text-sm text-slate-900 sticky left-0 bg-white">${member.name}</td>
                `;

                const memberPaymentStatus = {};
                allMonths.forEach(month => {
                    const isPaid = transactions.some(t => t.who === member.id && t.type === 'pemasukan' && t.paymentForMonth && t.paymentForMonth.includes(month));
                    memberPaymentStatus[month] = isPaid;

                    const cell = document.createElement('td');
                    cell.className = 'px-6 py-4 whitespace-nowrap text-center text-sm';
                    cell.innerHTML = isPaid
                        ? `<span class="inline-flex px-2 text-xs font-semibold leading-5 text-emerald-800 bg-emerald-100 rounded-full">Lunas</span>`
                        : `<span class="inline-flex px-2 text-xs font-semibold leading-5 text-red-800 bg-red-100 rounded-full">Belum</span>`;
                    row.appendChild(cell);
                });
                paymentStatuses[member.id] = memberPaymentStatus;
                paymentTableBody.appendChild(row);
            });
        }

        function renderMemberTable() {
            memberTableBody.innerHTML = '';
            members.forEach(m => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-900">${m.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button class="edit-member-button text-amber-600 hover:text-amber-900 mr-2" data-id="${m.id}">Edit</button>
                        <button class="delete-member-button text-red-600 hover:text-red-900" data-id="${m.id}">Hapus</button>
                    </td>
                `;
                memberTableBody.appendChild(row);
            });
        }

        function populateMemberSelect() {
            transactionWhoSelect.innerHTML = '<option value="">Pilih Anggota (Opsional)</option>';
            members.forEach(m => {
                const option = document.createElement('option');
                option.value = m.id;
                option.textContent = m.name;
                transactionWhoSelect.appendChild(option);
            });
        }

        function populateFilters() {
            // Populate month/year filters for PDF reports
            const months = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
            const currentYear = new Date().getFullYear();
            const years = Array.from({length: 5}, (_, i) => currentYear - i); // Last 5 years

            // PDF Transaction Month/Year Filter
            pdfMonthFilter.innerHTML = months.map(m => `<option value="${m}">${m}</option>`).join('');
            const currentMonthName = months[new Date().getMonth()];
            pdfMonthFilter.value = currentMonthName;
            pdfYearFilter.innerHTML = years.map(y => `<option value="${y}">${y}</option>`).join('');
            pdfYearFilter.value = currentYear;

            // PDF Payment Month Checkboxes
            pdfMonthSelectionDiv.innerHTML = '';
            months.forEach((month, index) => {
                const div = document.createElement('div');
                div.className = 'flex items-center';
                div.innerHTML = `
                    <input type="checkbox" id="pdfMonth-${index}" name="pdfMonth" value="${month}" class="form-checkbox h-4 w-4 text-amber-600 rounded focus:ring-amber-500" checked>
                    <label for="pdfMonth-${index}" class="ml-2 text-sm text-slate-700">${month}</label>
                `;
                pdfMonthSelectionDiv.appendChild(div);
            });

            // Transaction Form multi-month select
            const paymentPeriodStartMonth = document.getElementById('paymentPeriodStartMonth');
            const paymentPeriodEndMonth = document.getElementById('paymentPeriodEndMonth');
            paymentPeriodStartMonth.innerHTML = `<option value="">Pilih Bulan (Opsional)</option>` + months.map(m => `<option value="${m}">${m}</option>`).join('');
            paymentPeriodEndMonth.innerHTML = `<option value="">Pilih Bulan (Opsional)</option>` + months.map(m => `<option value="${m}">${m}</option>`).join('');
            
            // Set default values for the payment period selects
            paymentPeriodStartMonth.value = currentMonthName;
            paymentPeriodEndMonth.value = currentMonthName;
        }

        //----------------------------------------------------------------------
        // Chart Functions
        //----------------------------------------------------------------------

        function renderCharts() {
            const monthlyData = calculateMonthlyData(transactions);
            const months = Object.keys(monthlyData).sort((a, b) => new Date(a) - new Date(b));
            const balances = months.map(m => monthlyData[m].balance);
            const incomes = months.map(m => monthlyData[m].income);
            const expenses = months.map(m => monthlyData[m].expense);

            // Cashflow Chart
            const cashflowCtx = document.getElementById('cashflowChart').getContext('2d');
            if (cashflowChart) cashflowChart.destroy();
            cashflowChart = new Chart(cashflowCtx, {
                type: 'line',
                data: {
                    labels: months.map(m => formatDateToMonthYear(new Date(m))),
                    datasets: [{
                        label: 'Saldo',
                        data: balances,
                        borderColor: '#f59e0b',
                        backgroundColor: 'rgba(245, 158, 11, 0.2)',
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) { return `Rp ${formatCurrency(value)}`; }
                            }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: Rp ${formatCurrency(context.raw)}`;
                                }
                            }
                        }
                    }
                }
            });

            // Monthly Comparison Chart
            const monthlyComparisonCtx = document.getElementById('monthlyComparisonChart').getContext('2d');
            if (monthlyComparisonChart) monthlyComparisonChart.destroy();
            monthlyComparisonChart = new Chart(monthlyComparisonCtx, {
                type: 'bar',
                data: {
                    labels: months.map(m => formatDateToMonthYear(new Date(m))),
                    datasets: [{
                        label: 'Pemasukan',
                        data: incomes,
                        backgroundColor: '#10b981', // emerald-500
                    }, {
                        label: 'Pengeluaran',
                        data: expenses,
                        backgroundColor: '#ef4444', // red-500
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { stacked: false },
                        y: {
                            stacked: false,
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) { return `Rp ${formatCurrency(value)}`; }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: Rp ${formatCurrency(context.raw)}`;
                                }
                            }
                        }
                    }
                }
            });
        }

        //----------------------------------------------------------------------
        // Data & Form Handling Functions
        //----------------------------------------------------------------------

        function calculateMonthlyData(transactions) {
            const monthlyData = {};
            let currentBalance = 0;

            const sortedTransactions = [...transactions].sort((a, b) => new Date(a.date) - new Date(b.date));

            sortedTransactions.forEach(t => {
                const date = new Date(t.date);
                const yearMonth = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-01`;

                if (!monthlyData[yearMonth]) {
                    monthlyData[yearMonth] = {
                        income: 0,
                        expense: 0,
                        balance: 0,
                    };
                }

                if (t.type === 'pemasukan') {
                    monthlyData[yearMonth].income += t.amount;
                    currentBalance += t.amount;
                } else {
                    monthlyData[yearMonth].expense += t.amount;
                    currentBalance -= t.amount;
                }
                monthlyData[yearMonth].balance = currentBalance;
            });

            // Recalculate cumulative balance
            let cumulativeBalance = 0;
            const sortedMonths = Object.keys(monthlyData).sort();
            sortedMonths.forEach(month => {
                const monthData = monthlyData[month];
                cumulativeBalance += monthData.income - monthData.expense;
                monthData.balance = cumulativeBalance;
            });

            return monthlyData;
        }

        async function handleAddOrUpdateTransaction(e) {
            e.preventDefault();
            const isUpdate = transactionIdInput.value !== '';
            const buttonText = isUpdate ? 'Simpan Perubahan' : 'Tambah Transaksi';

            setButtonLoadingState(transactionFormButton, true, buttonText);

            const transactionDate = transactionDateInput.value;
            const transactionDesc = transactionDescInput.value;
            const transactionAmount = parseFloat(transactionAmountInput.value);
            const transactionType = document.querySelector('input[name="transactionType"]:checked').value;
            const transactionWho = transactionWhoSelect.value || null;
            const startMonth = document.getElementById('paymentPeriodStartMonth').value;
            const endMonth = document.getElementById('paymentPeriodEndMonth').value;

            let paymentForMonth = [];
            if (transactionType === 'pemasukan' && transactionWho && startMonth && endMonth) {
                 paymentForMonth = getMonthsBetween(startMonth, endMonth).join(', ');
            }

            const newTransaction = {
                date: transactionDate,
                description: transactionDesc,
                amount: transactionAmount,
                type: transactionType,
                who: transactionWho,
                paymentForMonth: paymentForMonth
            };

            const transactionsPath = `artifacts/${appId}/users/${userId}/transactions`;
            try {
                if (isUpdate) {
                    await db.collection(transactionsPath).doc(transactionIdInput.value).update(newTransaction);
                    console.log("Transaction updated successfully!");
                } else {
                    await db.collection(transactionsPath).add(newTransaction);
                    console.log("Transaction added successfully!");
                }
                transactionForm.reset();
                showCustomMessage('Sukses', isUpdate ? 'Transaksi berhasil diperbarui.' : 'Transaksi berhasil ditambahkan.', () => {
                    newTransactionModal.style.display = 'none';
                });
            } catch (error) {
                console.error("Error adding/updating transaction:", error);
                showCustomMessage('Error', 'Gagal menyimpan transaksi. Coba lagi.');
            } finally {
                setButtonLoadingState(transactionFormButton, false, buttonText);
            }
        }

        async function handleEditTransaction(transactionId) {
            const transaction = transactions.find(t => t.id === transactionId);
            if (transaction) {
                // Populate the form fields with existing data
                transactionIdInput.value = transaction.id;
                transactionDateInput.value = transaction.date;
                transactionDescInput.value = transaction.description;
                transactionAmountInput.value = transaction.amount;
                document.querySelector(`input[name="transactionType"][value="${transaction.type}"]`).checked = true;
                if (transaction.who) {
                    transactionWhoSelect.value = transaction.who;
                }
                if (transaction.paymentForMonth) {
                    const months = transaction.paymentForMonth.split(', ').map(m => m.trim());
                    document.getElementById('paymentPeriodStartMonth').value = months[0];
                    document.getElementById('paymentPeriodEndMonth').value = months[months.length - 1];
                } else {
                    document.getElementById('paymentPeriodStartMonth').value = '';
                    document.getElementById('paymentPeriodEndMonth').value = '';
                }

                // Update button text and show modal
                const transactionFormButton = document.querySelector('#transactionForm button[type="submit"]');
                transactionFormButton.textContent = 'Simpan Perubahan';
                newTransactionModal.style.display = 'flex';
            }
        }

        function handleDeleteTransaction(transactionId) {
            showConfirmation('Apakah Anda yakin ingin menghapus transaksi ini? Tindakan ini tidak dapat dibatalkan.', async () => {
                const transactionsPath = `artifacts/${appId}/users/${userId}/transactions`;
                try {
                    await db.collection(transactionsPath).doc(transactionId).delete();
                    console.log("Transaction deleted successfully!");
                    showCustomMessage('Sukses', 'Transaksi berhasil dihapus.');
                } catch (error) {
                    console.error("Error deleting transaction:", error);
                    showCustomMessage('Error', 'Gagal menghapus transaksi. Coba lagi.');
                }
            });
        }

        async function handleAddMember(e) {
            e.preventDefault();
            const memberName = newMemberNameInput.value.trim();
            if (!memberName) return;

            setButtonLoadingState(addMemberButton, true, 'Tambah Anggota');

            const membersPath = `artifacts/${appId}/users/${userId}/members`;
            try {
                await db.collection(membersPath).add({ name: memberName });
                newMemberNameInput.value = '';
                console.log("Member added successfully!");
            } catch (error) {
                console.error("Error adding member:", error);
                showCustomMessage('Error', 'Gagal menambahkan anggota. Coba lagi.');
            } finally {
                setButtonLoadingState(addMemberButton, false, 'Tambah Anggota');
            }
        }

        function handleDeleteMember(memberId) {
             showConfirmation('Apakah Anda yakin ingin menghapus anggota ini? Ini tidak akan menghapus transaksi yang sudah ada.', async () => {
                 const membersPath = `artifacts/${appId}/users/${userId}/members`;
                 try {
                     await db.collection(membersPath).doc(memberId).delete();
                     console.log("Member deleted successfully!");
                 } catch (error) {
                     console.error("Error deleting member:", error);
                     showCustomMessage('Error', 'Gagal menghapus anggota. Coba lagi.');
                 }
             });
        }

        //----------------------------------------------------------------------
        // PDF Reports
        //----------------------------------------------------------------------

        function generateTransactionPdf() {
            const doc = new jspdf.jsPDF();
            const selectedMonth = pdfMonthFilter.value;
            const selectedYear = pdfYearFilter.value;

            const filteredTransactions = transactions.filter(t => {
                const date = new Date(t.date);
                return date.getFullYear().toString() === selectedYear && formatDateToMonth(t.date) === selectedMonth;
            }).sort((a, b) => new Date(a.date) - new Date(b.date));

            const tableData = filteredTransactions.map(t => {
                const whoText = t.who ? members.find(m => m.id === t.who)?.name || 'Anggota dihapus' : 'Tidak Diketahui';
                return [
                    formatDate(t.date),
                    t.description,
                    t.type === 'pemasukan' ? `Rp ${formatCurrency(t.amount)}` : '',
                    t.type === 'pengeluaran' ? `Rp ${formatCurrency(t.amount)}` : '',
                    whoText
                ];
            });

            doc.text(`Laporan Transaksi Kas - ${selectedMonth} ${selectedYear}`, 14, 20);
            doc.autoTable({
                head: [['Tanggal', 'Keterangan', 'Pemasukan', 'Pengeluaran', 'Penyetor / Pengambil']],
                body: tableData,
                startY: 30,
                styles: { fontSize: 8 },
                headStyles: { fillColor: [241, 245, 249] }, // slate-100
                theme: 'striped'
            });

            const totalIncome = filteredTransactions.filter(t => t.type === 'pemasukan').reduce((sum, t) => sum + t.amount, 0);
            const totalExpense = filteredTransactions.filter(t => t.type === 'pengeluaran').reduce((sum, t) => sum + t.amount, 0);
            const finalBalance = totalIncome - totalExpense;

            doc.autoTable({
                head: [['Ringkasan', 'Jumlah']],
                body: [
                    ['Total Pemasukan', `Rp ${formatCurrency(totalIncome)}`],
                    ['Total Pengeluaran', `Rp ${formatCurrency(totalExpense)}`],
                    ['Saldo Akhir', `Rp ${formatCurrency(finalBalance)}`]
                ],
                startY: doc.lastAutoTable.finalY + 10,
                theme: 'plain',
                styles: { fontSize: 8 },
                headStyles: { fillColor: [255, 255, 255], textColor: [0, 0, 0], fontStyle: 'bold' }
            });

            doc.save(`Laporan_Transaksi_${selectedMonth}_${selectedYear}.pdf`);
        }

        function generatePaymentStatusPdf() {
            const doc = new jspdf.jsPDF('landscape');
            const months = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];

            const selectedMonths = Array.from(document.querySelectorAll('#pdfMonthSelection input[type="checkbox"]:checked'))
                                      .map(checkbox => checkbox.value);

            if (selectedMonths.length === 0) {
                 showCustomMessage('Peringatan', 'Pilih setidaknya satu bulan untuk laporan pembayaran.');
                 return;
            }

            const header = ['Nama Anggota', ...selectedMonths];
            const tableData = members.map(member => {
                const row = [member.name];
                selectedMonths.forEach(month => {
                    const monthKey = `${month} ${new Date().getFullYear()}`;
                    const isPaid = transactions.some(t => {
                        const transactionMonth = formatDateToMonthYear(t.date);
                        return t.who === member.id && t.type === 'pemasukan' && transactionMonth === monthKey;
                    });
                    row.push(isPaid ? 'Lunas' : 'Belum');
                });
                return row;
            });

            doc.text('Laporan Status Pembayaran Anggota', 14, 20);
            doc.autoTable({
                head: [header],
                body: tableData,
                startY: 30,
                styles: { fontSize: 8, halign: 'center' },
                headStyles: { fillColor: [241, 245, 249], halign: 'center' },
                columnStyles: { 0: { halign: 'left' } },
                theme: 'striped'
            });

            doc.save(`Laporan_Pembayaran.pdf`);
        }

        function startAutoDownload(hour) {
            const savedStatus = localStorage.getItem('autoDownloadEnabled');
            const shouldStart = (savedStatus === 'true' || hour > 0);
            if (shouldStart) {
                autoDownloadStatus.textContent = `Aktif (setiap jam ${hour}:00)`;
                autoDownloadStatus.classList.remove('text-red-600');
                autoDownloadStatus.classList.add('text-emerald-600');
                localStorage.setItem('autoDownloadEnabled', 'true');
            } else {
                autoDownloadStatus.textContent = 'Nonaktif';
                autoDownloadStatus.classList.remove('text-emerald-600');
                autoDownloadStatus.classList.add('text-red-600');
                localStorage.setItem('autoDownloadEnabled', 'false');
            }
        }

        //----------------------------------------------------------------------
        // Other Tools
        //----------------------------------------------------------------------

        function handleSaveData() {
            const data = {
                transactions: transactions,
                members: members
            };
            const dataStr = JSON.stringify(data, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `uang-kas-data-${new Date().toISOString().slice(0, 10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function handleLoadData() {
            loadDataInput.click();
        }

        async function handleFileLoad(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (event) => {
                try {
                    const data = JSON.parse(event.target.result);
                    if (data.transactions && data.members) {
                        showConfirmation('Memuat data akan menimpa data yang ada. Lanjutkan?', async () => {
                            await clearFirestoreCollections();
                            await addDataToFirestore(data.transactions, data.members);
                            showCustomMessage('Sukses', 'Data berhasil dimuat.');
                        });
                    } else {
                        showCustomMessage('Error', 'Format file JSON tidak valid.');
                    }
                } catch (error) {
                    showCustomMessage('Error', 'Gagal memuat file: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        async function clearAllData() {
            showConfirmation('<strong>PERINGATAN:</strong> Ini akan menghapus SEMUA data transaksi dan anggota di database Anda. Tindakan ini tidak dapat diurungkan. Lanjutkan?', async () => {
                await clearFirestoreCollections();
                showCustomMessage('Sukses', 'Semua data telah dihapus.');
            });
        }

        async function clearFirestoreCollections() {
             const transactionDocs = await db.collection(`artifacts/${appId}/users/${userId}/transactions`).get();
             const memberDocs = await db.collection(`artifacts/${appId}/users/${userId}/members`).get();
             const batch = db.batch();

             transactionDocs.forEach(doc => batch.delete(doc.ref));
             memberDocs.forEach(doc => batch.delete(doc.ref));

             await batch.commit();
        }

        async function addDataToFirestore(newTransactions, newMembers) {
            const batch = db.batch();

            newMembers.forEach(m => {
                const newDocRef = db.collection(`artifacts/${appId}/users/${userId}/members`).doc();
                batch.set(newDocRef, m);
            });

            newTransactions.forEach(t => {
                const newDocRef = db.collection(`artifacts/${appId}/users/${userId}/transactions`).doc();
                batch.set(newDocRef, t);
            });

            await batch.commit();
        }

        //----------------------------------------------------------------------
        // Utility Functions
        //----------------------------------------------------------------------

        function formatCurrency(amount) {
            return new Intl.NumberFormat('id-ID').format(amount);
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            return date.toLocaleDateString('id-ID', options);
        }

        function formatDateToMonthYear(dateString) {
            const date = new Date(dateString);
            const options = { year: 'numeric', month: 'long' };
            return date.toLocaleDateString('id-ID', options);
        }
        function getMonthsBetween(startMonth, endMonth) {
            const months = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
            const startIdx = months.indexOf(startMonth);
            const endIdx = months.indexOf(endMonth);
            if (startIdx === -1 || endIdx === -1 || startIdx > endIdx) {
                return [];
            }
            return months.slice(startIdx, endIdx + 1);
        }

        // Show a custom confirmation modal
        function showConfirmation(message, onConfirm) {
            confirmationMessage.innerHTML = message;
            confirmationModal.style.display = 'flex';

            const handleConfirm = () => {
                onConfirm();
                confirmationModal.style.display = 'none';
                confirmButton.removeEventListener('click', handleConfirm);
            };

            const handleCancel = () => {
                confirmationModal.style.display = 'none';
                cancelButton.removeEventListener('click', handleCancel);
            };

            confirmButton.addEventListener('click', handleConfirm, { once: true });
            cancelButton.addEventListener('click', handleCancel, { once: true });
        }

        // Show a custom message modal
        function showCustomMessage(title, message, onClose) {
            document.querySelector('#messageModal h3').textContent = title;
            messageText.innerHTML = message;
            messageModal.style.display = 'flex';

            const closeHandler = () => {
                messageModal.style.display = 'none';
                if (onClose) onClose();
                closeMessageButton.removeEventListener('click', closeHandler);
                closeMessageModal.removeEventListener('click', closeHandler);
            };

            closeMessageButton.addEventListener('click', closeHandler, { once: true });
            closeMessageModal.addEventListener('click', closeHandler, { once: true });
        }

        function setButtonLoadingState(button, isLoading, originalText) {
            const spinner = button.querySelector('.loading-spinner');
            if (isLoading) {
                button.disabled = true;
                button.innerHTML = originalText + `<span class="loading-spinner ml-2"></span>`;
            } else {
                button.disabled = false;
                button.innerHTML = originalText;
            }
        }

        // Exponential backoff for API calls
        async function fetchWithExponentialBackoff(fetcher, retries = 3, delay = 1000) {
            try {
                const response = await fetcher();
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response;
            } catch (error) {
                if (retries > 0) {
                    console.warn(`Fetch failed, retrying in ${delay}ms...`);
                    await new Promise(res => setTimeout(res, delay));
                    return fetchWithExponentialBackoff(fetcher, retries - 1, delay * 2);
                } else {
                    throw error;
                }
            }
        }

        //----------------------------------------------------------------------
        // Event Listeners
        //----------------------------------------------------------------------
        document.addEventListener('DOMContentLoaded', () => {
            initializeFirebase();

            // Tab functionality
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabs.forEach(t => t.classList.remove('active'));
                    tabContents.forEach(content => content.classList.add('hidden'));

                    tab.classList.add('active');
                    document.getElementById(`content-${tab.id.split('-')[1]}`).classList.remove('hidden');
                });
            });

            // Handle transaction table actions (delete, edit)
            transactionTableBody.addEventListener('click', (e) => {
                if (e.target.classList.contains('delete-transaction-button')) {
                    const transactionId = e.target.getAttribute('data-id');
                    handleDeleteTransaction(transactionId);
                }
                if (e.target.classList.contains('edit-transaction-button')) {
                    const transactionId = e.target.getAttribute('data-id');
                    handleEditTransaction(transactionId);
                }
            });

            // Transaction search and filter
            transactionSearch.addEventListener('input', renderTransactionsTable);
            transactionFilterType.addEventListener('change', renderTransactionsTable);

            // Transaction Form Modal
            showNewTransactionModal.addEventListener('click', () => {
                transactionForm.reset();
                transactionIdInput.value = '';
                document.querySelector('#transactionForm button[type="submit"]').textContent = 'Tambah Transaksi';
                newTransactionModal.style.display = 'flex';
                // Set default month values
                const currentMonthName = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'][new Date().getMonth()];
                document.getElementById('paymentPeriodStartMonth').value = currentMonthName;
                document.getElementById('paymentPeriodEndMonth').value = currentMonthName;
            });
            closeNewTransactionModal.addEventListener('click', () => {
                newTransactionModal.style.display = 'none';
            });
            window.addEventListener('click', (e) => {
                if (e.target === newTransactionModal) {
                    newTransactionModal.style.display = 'none';
                }
            });
            transactionForm.addEventListener('submit', handleAddOrUpdateTransaction);

            // Member management actions
            addMemberButton.addEventListener('click', handleAddMember);
            memberTableBody.addEventListener('click', (e) => {
                if (e.target.classList.contains('delete-member-button')) {
                    const memberId = e.target.getAttribute('data-id');
                    handleDeleteMember(memberId);
                }
            });

            // PDF Reports
            generatePdfButton.addEventListener('click', generateTransactionPdf);
            generatePaymentPdfButton.addEventListener('click', generatePaymentStatusPdf);
            selectAllPdfMonthsButton.addEventListener('click', () => {
                document.querySelectorAll('#pdfMonthSelection input[type="checkbox"]').forEach(checkbox => {
                    checkbox.checked = true;
                });
            });
            clearAllPdfMonthsButton.addEventListener('click', () => {
                document.querySelectorAll('#pdfMonthSelection input[type="checkbox"]').forEach(checkbox => {
                    checkbox.checked = false;
                });
            });
            autoDownloadOnButton.addEventListener('click', () => startAutoDownload(17)); // Example at 5 PM
            autoDownloadOffButton.addEventListener('click', () => startAutoDownload(0));

            // Other Tools
            saveDataButton.addEventListener('click', handleSaveData);
            loadDataButton.addEventListener('click', handleLoadData);
            loadDataInput.addEventListener('change', handleFileLoad);
            clearAllDataButton.addEventListener('click', clearAllData);
            closeMessageModal.addEventListener('click', () => messageModal.style.display = 'none');
            closeMessageButton.addEventListener('click', () => messageModal.style.display = 'none');
        });
    </script>
</body>
</html>
