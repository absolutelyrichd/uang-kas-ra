<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Uang Kas RA Tarbiyatul Aulad</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/jspdf-autotable@3.5.25/dist/jspdf.plugin.autotable.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* slate-50 */
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            height: 350px;
            max-height: 400px;
        }
        @media (max-width: 768px) {
            .chart-container {
                height: 300px;
            }
        }
        .tab-button.active {
            border-color: #f59e0b; /* amber-500 */
            color: #f59e0b; /* amber-500 */
            font-weight: 600;
        }
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #f59e0b;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-left: 8px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            padding: 24px;
            border-radius: 8px;
            box-shadow: 0 10px 15px rgba(0,0,0,0.1);
            width: 90%;
            max-width: 600px;
            position: relative;
        }
        .close-button {
            position: absolute;
            top: 10px;
            right: 10px;
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
        }
    </style>
    <!-- Firebase SDKs - V9 Compatibility -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
</head>
<body class="text-slate-800">

    <div class="container mx-auto p-4 md:p-8">

        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-slate-900">Uang Kas RA Tarbiyatul Aulad</h1>
            <p class="text-slate-500 mt-2">Semangat!</p>
            <!-- Firebase Login/Logout UI -->
            <div class="mt-4 flex flex-col sm:flex-row justify-center items-center gap-4">
                <div id="authStatus" class="text-slate-600 font-medium">Memuat status autentikasi...</div>
                <button id="signInButton" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out hidden">
                    Login dengan Google
                </button>
                <button id="signOutButton" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out hidden">
                    Logout
                </button>
            </div>
        </header>

        <main id="appContent" class="hidden"> <!-- Hidden until user logs in -->
            <!-- Section: Key Metrics -->
            <section id="kpi" class="mb-8">
                 <div class="grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-6">
                    <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                        <h3 class="text-slate-500 font-medium mb-2">Saldo Saat Ini</h3>
                        <p id="currentBalance" class="text-3xl font-bold text-slate-900">Rp 0</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                        <h3 class="text-slate-500 font-medium mb-2">Total Pemasukan</h3>
                        <p id="totalIncome" class="text-3xl font-bold text-emerald-600">Rp 0</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                        <h3 class="text-slate-500 font-medium mb-2">Total Pengeluaran</h3>
                        <p id="totalExpense" class="text-3xl font-bold text-red-600">Rp 0</p>
                    </div>
                </div>
            </section>

            <!-- Section: Visualizations -->
            <section id="visualizations" class="mb-8 grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-white p-4 md:p-6 rounded-xl border border-slate-200 shadow-sm">
                    <h3 class="text-lg font-semibold mb-1 text-slate-900">Tren Arus Kas (Saldo)</h3>
                    <p class="text-sm text-slate-500 mb-4">Grafik ini menunjukkan perubahan saldo kas dari waktu ke waktu, memberikan gambaran tentang kesehatan finansial secara keseluruhan.</p>
                    <div class="chart-container">
                        <canvas id="cashflowChart"></canvas>
                    </div>
                </div>
                <div class="bg-white p-4 md:p-6 rounded-xl border border-slate-200 shadow-sm">
                    <h3 class="text-lg font-semibold mb-1 text-slate-900">Pemasukan vs Pengeluaran Bulanan</h3>
                     <p class="text-sm text-slate-500 mb-4">Bandingkan total pemasukan dan pengeluaran setiap bulan untuk melihat pola aktivitas keuangan.</p>
                    <div class="chart-container">
                        <canvas id="monthlyComparisonChart"></canvas>
                    </div>
                </div>
            </section>

            <!-- Section: Detailed Data -->
            <section id="details" class="mb-8">
                <div class="bg-white rounded-xl border border-slate-200 shadow-sm">
                    <div class="border-b border-slate-200">
                        <nav class="flex space-x-2 p-2" aria-label="Tabs">
                            <button id="tab-transactions" class="tab-button active px-4 py-2 text-sm font-medium text-slate-600 rounded-lg border-b-2 border-transparent hover:text-amber-600 focus:outline-none">
                                Riwayat Transaksi
                            </button>
                            <button id="tab-payments" class="tab-button px-4 py-2 text-sm font-medium text-slate-600 rounded-lg border-b-2 border-transparent hover:text-amber-600 focus:outline-none">
                                Status Pembayaran Anggota
                            </button>
                            <!-- Tab 'Input Transaksi Baru' removed from here -->
                            <button id="tab-member-management" class="tab-button px-4 py-2 text-sm font-medium text-slate-600 rounded-lg border-b-2 border-transparent hover:text-amber-600 focus:outline-none">
                                Kelola Anggota
                            </button>
                        </nav>
                    </div>

                    <div id="content-transactions" class="p-4 md:p-6">
                        <h3 class="text-lg font-semibold mb-1 text-slate-900">Detail Semua Transaksi</h3>
                        <p class="text-sm text-slate-500 mb-4">Gunakan kolom pencarian dan filter untuk menemukan dan mengelola transaksi.</p>
                        <!-- Add New Transaction Button and Filters -->
                        <div class="flex flex-col md:flex-row gap-4 mb-4 items-center">
                            <button id="openTransactionModal" class="bg-amber-500 hover:bg-amber-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out flex items-center justify-center">
                                <i class="fa-solid fa-plus-circle mr-2"></i> Tambah Transaksi Baru
                            </button>
                            <div class="flex gap-2">
                                <select id="transactionTypeFilter" class="p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-400 focus:border-amber-400">
                                    <option value="all">Semua Jenis</option>
                                    <option value="pemasukan">Pemasukan</option>
                                    <option value="pengeluaran">Pengeluaran</option>
                                </select>
                                <select id="transactionMonthFilter" class="p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-400 focus:border-amber-400">
                                    <option value="all">Semua Bulan</option>
                                    <!-- Options will be populated by JS -->
                                </select>
                                <select id="transactionYearFilter" class="p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-400 focus:border-amber-400">
                                    <option value="all">Semua Tahun</option>
                                    <!-- Options will be populated by JS -->
                                </select>
                            </div>
                            <input type="text" id="transactionSearch" placeholder="Cari transaksi..." class="w-full max-w-xs p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-400 focus:border-amber-400">
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-slate-200">
                                <thead class="bg-slate-50">
                                    <tr>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Tanggal</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Keterangan</th>
                                        <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-slate-500 uppercase tracking-wider">Pemasukan</th>
                                        <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-slate-500 uppercase tracking-wider">Pengeluaran</th>
                                        <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-slate-500 uppercase tracking-wider">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="transactionTableBody" class="bg-white divide-y divide-slate-200">
                                    <!-- Rows will be inserted by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div id="content-payments" class="hidden p-4 md:p-6">
                        <h3 class="text-lg font-semibold mb-1 text-slate-900">Status Pembayaran Iuran Kas</h3>
                        <p class="text-sm text-slate-500 mb-4">Berikut adalah status pembayaran iuran kas per bulan untuk setiap anggota.</p>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-slate-200">
                                <thead class="bg-slate-50">
                                    <tr id="paymentTableHeader">
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider sticky left-0 bg-slate-50 z-10">Nama Anggota</th>
                                        <!-- Month headers will be inserted by JavaScript -->
                                    </tr>
                                </thead>
                                <tbody id="paymentTableBody" class="bg-white divide-y divide-slate-200">
                                    <!-- Rows will be inserted by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div id="content-member-management" class="hidden p-4 md:p-6">
                        <h3 class="text-lg font-semibold mb-1 text-slate-900">Kelola Anggota</h3>
                        <p class="text-sm text-slate-500 mb-4">Tambahkan, edit, atau hapus anggota yang akan membayar uang kas.</p>
                        <div class="mb-4 flex flex-col sm:flex-row gap-2">
                            <input type="text" id="newMemberName" placeholder="Nama Anggota Baru" class="flex-grow p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-400 focus:border-amber-400">
                            <button id="addMemberButton" class="bg-emerald-500 hover:bg-emerald-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out flex items-center justify-center">
                                Tambah Anggota
                                <span id="addMemberSpinner" class="loading-spinner hidden"></span>
                            </button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-slate-200">
                                <thead class="bg-slate-50">
                                    <tr>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Nama Anggota</th>
                                        <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-slate-500 uppercase tracking-wider">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="memberTableBody" class="bg-white divide-y divide-slate-200">
                                    <!-- Rows will be inserted by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                </div>
            </section>
        </main>
    </div>

    <!-- The Modal for adding/editing transactions -->
    <div id="transactionModal" class="modal hidden">
        <div class="modal-content">
            <span id="closeTransactionModal" class="close-button">&times;</span>
            <h3 id="modalTitle" class="text-lg font-semibold mb-4 text-slate-900">Input Transaksi Baru</h3>
            <form id="transactionForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <input type="hidden" id="transactionId">
                <div>
                    <label for="transactionDate" class="block text-sm font-medium text-slate-700">Tanggal</label>
                    <input type="date" id="transactionDate" class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-amber-500 focus:border-amber-500" required>
                </div>
                <div>
                    <label for="transactionDesc" class="block text-sm font-medium text-slate-700">Keterangan</label>
                    <input type="text" id="transactionDesc" placeholder="Contoh: Pembelian buku kas" class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-amber-500 focus:border-amber-500" required>
                </div>
                <div>
                    <label for="transactionAmount" class="block text-sm font-medium text-slate-700">Nominal (Rp)</label>
                    <input type="number" id="transactionAmount" placeholder="Contoh: 50000" class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-amber-500 focus:border-amber-500" required min="0">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700">Jenis Transaksi</label>
                    <div class="mt-1 flex items-center space-x-4">
                        <label class="inline-flex items-center">
                            <input type="radio" name="transactionType" value="pemasukan" class="form-radio text-emerald-600" checked>
                            <span class="ml-2 text-slate-700">Pemasukan</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="radio" name="transactionType" value="pengeluaran" class="form-radio text-red-600">
                            <span class="ml-2 text-slate-700">Pengeluaran</span>
                        </label>
                    </div>
                </div>
                <div class="md:col-span-2">
                    <label for="transactionWho" class="block text-sm font-medium text-slate-700">Penyetor / Pengambil</label>
                    <select id="transactionWho" class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-amber-500 focus:border-amber-500">
                        <option value="">Pilih Anggota (Opsional)</option>
                        <!-- Options will be populated by JavaScript -->
                    </select>
                </div>
                <div class="md:col-span-2">
                    <label for="paymentPeriodStartMonth" class="block text-sm font-medium text-slate-700">Pembayaran Untuk Bulan (Mulai)</label>
                    <div class="flex gap-2">
                        <select id="paymentPeriodStartMonth" class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-amber-500 focus:border-amber-500">
                            <!-- Options will be populated by JavaScript -->
                        </select>
                        <select id="paymentPeriodStartYear" class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-amber-500 focus:border-amber-500">
                            <!-- Options will be populated by JavaScript -->
                        </select>
                    </div>
                </div>
                <div class="md:col-span-2">
                    <label for="paymentPeriodEndMonth" class="block text-sm font-medium text-slate-700">Pembayaran Untuk Bulan (Akhir)</label>
                    <div class="flex gap-2">
                        <select id="paymentPeriodEndMonth" class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-amber-500 focus:border-amber-500">
                            <!-- Options will be populated by JavaScript -->
                        </select>
                        <select id="paymentPeriodEndYear" class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-amber-500 focus:border-amber-500">
                            <!-- Options will be populated by JavaScript -->
                        </select>
                    </div>
                </div>
                <div class="md:col-span-2 flex justify-end">
                    <button type="submit" id="submitTransactionButton" class="bg-amber-500 hover:bg-amber-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out flex items-center">
                        Tambah Transaksi
                        <span id="addTransactionSpinner" class="loading-spinner hidden"></span>
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Custom Modal for user messages -->
    <div id="messageModal" class="modal hidden">
        <div class="modal-content">
            <h3 id="messageModalTitle" class="text-xl font-semibold mb-4 text-slate-900"></h3>
            <p id="messageModalText" class="text-slate-700 mb-6"></p>
            <div class="flex justify-center gap-4">
                <button id="confirmButton" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg">Konfirmasi</button>
                <button id="cancelButton" class="bg-slate-300 hover:bg-slate-400 text-slate-800 font-semibold py-2 px-4 rounded-lg">Batal</button>
            </div>
        </div>
    </div>

    <!-- Script Section -->
    <script>
        // Global variables for Firebase and data
        let db;
        let auth;
        let userId = 'anon'; // Default to anonymous
        let membersData = [];
        let transactionsData = [];
        let paymentStatusData = {};
        const months = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
        const monthsInIndonesian = [
            'Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni',
            'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'
        ];

        // Custom modal implementation
        const messageModal = document.getElementById('messageModal');
        const messageModalTitle = document.getElementById('messageModalTitle');
        const messageModalText = document.getElementById('messageModalText');
        const confirmButton = document.getElementById('confirmButton');
        const cancelButton = document.getElementById('cancelButton');

        function showCustomModal(title, message, onConfirm, onCancel) {
            messageModalTitle.innerText = title;
            messageModalText.innerText = message;
            messageModal.classList.remove('hidden');

            confirmButton.onclick = () => {
                onConfirm();
                messageModal.classList.add('hidden');
            };

            cancelButton.onclick = () => {
                if (onCancel) onCancel();
                messageModal.classList.add('hidden');
            };
        }


        document.addEventListener('DOMContentLoaded', () => {

            // Firebase Configuration from user request
            const firebaseConfig = {
                apiKey: "AIzaSyBuoxTcp7_C5LdOtU_vKlkvQNVLtdZK68Y",
                authDomain: "uang-kas-ra.firebaseapp.com",
                projectId: "uang-kas-ra",
                storageBucket: "uang-kas-ra.firebasestorage.app",
                messagingSenderId: "635210671608",
                appId: "1:635210671608:web:36dd4007f60a2ab434a20d",
                measurementId: "G-EJHTNTCHXJ"
            };

            // Initialize Firebase
            const app = firebase.initializeApp(firebaseConfig);
            db = app.firestore();
            auth = app.auth();

            // DOM elements
            const appContent = document.getElementById('appContent');
            const signInButton = document.getElementById('signInButton');
            const signOutButton = document.getElementById('signOutButton');
            const authStatus = document.getElementById('authStatus');

            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = {
                'tab-transactions': document.getElementById('content-transactions'),
                'tab-payments': document.getElementById('content-payments'),
                'tab-member-management': document.getElementById('content-member-management'),
            };

            const currentBalanceEl = document.getElementById('currentBalance');
            const totalIncomeEl = document.getElementById('totalIncome');
            const totalExpenseEl = document.getElementById('totalExpense');

            const transactionTableBody = document.getElementById('transactionTableBody');
            const transactionSearchInput = document.getElementById('transactionSearch');
            const transactionTypeFilter = document.getElementById('transactionTypeFilter');
            const transactionMonthFilter = document.getElementById('transactionMonthFilter');
            const transactionYearFilter = document.getElementById('transactionYearFilter');
            const openTransactionModalBtn = document.getElementById('openTransactionModal');

            const memberTableBody = document.getElementById('memberTableBody');
            const newMemberNameInput = document.getElementById('newMemberName');
            const addMemberButton = document.getElementById('addMemberButton');
            const addMemberSpinner = document.getElementById('addMemberSpinner');

            const paymentTableHeader = document.getElementById('paymentTableHeader');
            const paymentTableBody = document.getElementById('paymentTableBody');

            // Modal elements
            const transactionModal = document.getElementById('transactionModal');
            const closeTransactionModal = document.getElementById('closeTransactionModal');
            const transactionForm = document.getElementById('transactionForm');
            const modalTitle = document.getElementById('modalTitle');
            const transactionIdInput = document.getElementById('transactionId');
            const transactionDateInput = document.getElementById('transactionDate');
            const transactionDescInput = document.getElementById('transactionDesc');
            const transactionAmountInput = document.getElementById('transactionAmount');
            const transactionWhoSelect = document.getElementById('transactionWho');
            const paymentPeriodStartMonth = document.getElementById('paymentPeriodStartMonth');
            const paymentPeriodEndMonth = document.getElementById('paymentPeriodEndMonth');
            const paymentPeriodStartYear = document.getElementById('paymentPeriodStartYear');
            const paymentPeriodEndYear = document.getElementById('paymentPeriodEndYear');
            const submitTransactionButton = document.getElementById('submitTransactionButton');
            const addTransactionSpinner = document.getElementById('addTransactionSpinner');

            // Chart instances
            let cashflowChart;
            let monthlyComparisonChart;

            // --- Utility Functions ---
            const formatRupiah = (number) => {
                return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(number);
            };

            const getMonthName = (monthIndex) => {
                return monthsInIndonesian[monthIndex];
            };

            const getMonthIndex = (monthName) => {
                return monthsInIndonesian.indexOf(monthName);
            };
            
            // Function to populate month/year filters and selectors
            function populateMonthAndYearSelectors() {
                const currentYear = new Date().getFullYear();
                const currentMonth = new Date().getMonth();

                // Clear existing options
                transactionMonthFilter.innerHTML = '<option value="all">Semua Bulan</option>';
                transactionYearFilter.innerHTML = '<option value="all">Semua Tahun</option>';
                paymentPeriodStartMonth.innerHTML = '';
                paymentPeriodEndMonth.innerHTML = '';
                paymentPeriodStartYear.innerHTML = '';
                paymentPeriodEndYear.innerHTML = '';

                // Populate month filters
                monthsInIndonesian.forEach((month, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = month;
                    transactionMonthFilter.appendChild(option);
                });

                // Populate year filters
                for (let year = currentYear; year >= currentYear - 2; year--) {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    transactionYearFilter.appendChild(option);
                }

                // Populate payment period months
                monthsInIndonesian.forEach((month, index) => {
                    const optionStart = document.createElement('option');
                    optionStart.value = index;
                    optionStart.textContent = month;
                    paymentPeriodStartMonth.appendChild(optionStart);

                    const optionEnd = document.createElement('option');
                    optionEnd.value = index;
                    optionEnd.textContent = month;
                    paymentPeriodEndMonth.appendChild(optionEnd);
                });
                
                // Set default to current month
                paymentPeriodStartMonth.value = currentMonth;
                paymentPeriodEndMonth.value = currentMonth;
                
                // Populate payment period years (current and next year)
                for (let year = currentYear; year <= currentYear + 1; year++) {
                    const optionStart = document.createElement('option');
                    optionStart.value = year;
                    optionStart.textContent = year;
                    paymentPeriodStartYear.appendChild(optionStart);

                    const optionEnd = document.createElement('option');
                    optionEnd.value = year;
                    optionEnd.textContent = year;
                    paymentPeriodEndYear.appendChild(optionEnd);
                }

                // Set default to current year
                paymentPeriodStartYear.value = currentYear;
                paymentPeriodEndYear.value = currentYear;
            }

            // Call on initial load
            populateMonthAndYearSelectors();

            // --- Render Functions ---
            const renderKPIs = () => {
                const totalIncome = transactionsData.filter(t => t.type === 'pemasukan').reduce((sum, t) => sum + t.amount, 0);
                const totalExpense = transactionsData.filter(t => t.type === 'pengeluaran').reduce((sum, t) => sum + t.amount, 0);
                const currentBalance = totalIncome - totalExpense;

                currentBalanceEl.textContent = formatRupiah(currentBalance);
                totalIncomeEl.textContent = formatRupiah(totalIncome);
                totalExpenseEl.textContent = formatRupiah(totalExpense);
            };

            const renderCharts = () => {
                // Prepare data for charts
                const monthlyData = {};
                transactionsData.forEach(t => {
                    const date = new Date(t.date);
                    const monthYear = `${date.getFullYear()}-${date.getMonth()}`;
                    if (!monthlyData[monthYear]) {
                        monthlyData[monthYear] = { income: 0, expense: 0, balance: 0, date: date };
                    }
                    if (t.type === 'pemasukan') {
                        monthlyData[monthYear].income += t.amount;
                    } else {
                        monthlyData[monthYear].expense += t.amount;
                    }
                });

                const sortedMonths = Object.keys(monthlyData).sort((a, b) => new Date(monthlyData[a].date) - new Date(monthlyData[b].date));

                let cumulativeBalance = 0;
                const labels = sortedMonths.map(m => getMonthName(monthlyData[m].date.getMonth()) + ' ' + monthlyData[m].date.getFullYear());
                const income = sortedMonths.map(m => monthlyData[m].income);
                const expense = sortedMonths.map(m => monthlyData[m].expense);
                const balance = sortedMonths.map(m => {
                    cumulativeBalance += monthlyData[m].income - monthlyData[m].expense;
                    return cumulativeBalance;
                });

                // Cashflow Chart
                const cashflowCtx = document.getElementById('cashflowChart').getContext('2d');
                if (cashflowChart) cashflowChart.destroy();
                cashflowChart = new Chart(cashflowCtx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Saldo',
                            data: balance,
                            borderColor: '#f59e0b',
                            backgroundColor: 'rgba(245, 158, 11, 0.2)',
                            fill: true,
                            tension: 0.3
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });

                // Monthly Comparison Chart
                const monthlyComparisonCtx = document.getElementById('monthlyComparisonChart').getContext('2d');
                if (monthlyComparisonChart) monthlyComparisonChart.destroy();
                monthlyComparisonChart = new Chart(monthlyComparisonCtx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Pemasukan',
                                data: income,
                                backgroundColor: '#10b981', // emerald-500
                            },
                            {
                                label: 'Pengeluaran',
                                data: expense,
                                backgroundColor: '#ef4444', // red-500
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                stacked: true,
                            },
                            y: {
                                stacked: true,
                                beginAtZero: true
                            }
                        }
                    }
                });
            };

            const renderTransactions = () => {
                const searchTerm = transactionSearchInput.value.toLowerCase();
                const filterType = transactionTypeFilter.value;
                const filterMonth = transactionMonthFilter.value;
                const filterYear = transactionYearFilter.value;

                transactionTableBody.innerHTML = '';

                const filteredTransactions = transactionsData.filter(t => {
                    const transactionDate = new Date(t.date);
                    const matchesSearch = t.description.toLowerCase().includes(searchTerm) || (t.who && membersData.find(m => m.id === t.who)?.name.toLowerCase().includes(searchTerm));
                    const matchesType = filterType === 'all' || t.type === filterType;
                    const matchesMonth = filterMonth === 'all' || transactionDate.getMonth().toString() === filterMonth;
                    const matchesYear = filterYear === 'all' || transactionDate.getFullYear().toString() === filterYear;
                    return matchesSearch && matchesType && matchesMonth && matchesYear;
                });

                // Sort by date descending
                filteredTransactions.sort((a, b) => new Date(b.date) - new Date(a.date));

                filteredTransactions.forEach(t => {
                    const row = document.createElement('tr');
                    const isIncome = t.type === 'pemasukan';
                    const amount = formatRupiah(t.amount);
                    const payerName = t.who ? membersData.find(m => m.id === t.who)?.name || 'Anggota Dihapus' : '-';

                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${t.date}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-900">
                            ${t.description}
                            ${t.who ? `<span class="block text-xs text-slate-400">(${payerName})</span>` : ''}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-emerald-600 text-right">${isIncome ? amount : '-'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-red-600 text-right">${!isIncome ? amount : '-'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button data-id="${t.id}" class="edit-transaction-btn text-amber-600 hover:text-amber-900 mr-2"><i class="fa-solid fa-edit"></i></button>
                            <button data-id="${t.id}" class="delete-transaction-btn text-red-600 hover:text-red-900"><i class="fa-solid fa-trash"></i></button>
                        </td>
                    `;
                    transactionTableBody.appendChild(row);
                });
            };

            const renderPaymentStatus = () => {
                paymentTableHeader.innerHTML = `<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider sticky left-0 bg-slate-50 z-10">Nama Anggota</th>`;
                paymentTableBody.innerHTML = '';

                // Dynamically create month headers for the current year
                const now = new Date();
                const currentYear = now.getFullYear();
                const monthHeaders = months.map((month, index) => {
                    paymentTableHeader.innerHTML += `<th scope="col" class="px-6 py-3 text-center text-xs font-medium text-slate-500 uppercase tracking-wider">${month}</th>`;
                    return `${currentYear}-${index}`;
                });

                membersData.forEach(member => {
                    const row = document.createElement('tr');
                    row.innerHTML = `<td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-900 sticky left-0 bg-white z-10">${member.name}</td>`;
                    monthHeaders.forEach(monthKey => {
                        const status = paymentStatusData[member.id]?.[monthKey] || 'Belum Bayar';
                        let badgeColor = 'bg-red-100 text-red-800';
                        if (status === 'Sudah Bayar') {
                            badgeColor = 'bg-emerald-100 text-emerald-800';
                        }
                        row.innerHTML += `<td class="px-6 py-4 whitespace-nowrap text-sm text-center text-slate-500"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${badgeColor}">${status}</span></td>`;
                    });
                    paymentTableBody.appendChild(row);
                });
            };

            const renderMemberTable = () => {
                memberTableBody.innerHTML = '';
                membersData.forEach(member => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-900">${member.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button data-id="${member.id}" class="delete-member-btn text-red-600 hover:text-red-900"><i class="fa-solid fa-trash"></i> Hapus</button>
                        </td>
                    `;
                    memberTableBody.appendChild(row);
                });
            };

            const renderAllUI = () => {
                renderKPIs();
                renderCharts();
                renderTransactions();
                renderPaymentStatus();
                renderMemberTable();
                populateMemberSelect();
            };

            const populateMemberSelect = () => {
                transactionWhoSelect.innerHTML = '<option value="">Pilih Anggota (Opsional)</option>';
                membersData.forEach(member => {
                    const option = document.createElement('option');
                    option.value = member.id;
                    option.textContent = member.name;
                    transactionWhoSelect.appendChild(option);
                });
            };

            // --- Data Persistence (Firestore) ---
            const getDataCollection = (collectionName) => {
                return db.collection(`uang-kas-ra/data/${userId}/${collectionName}`);
            };

            const setupRealtimeListeners = () => {
                // Real-time listener for members data
                getDataCollection('members').onSnapshot(snapshot => {
                    membersData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderAllUI();
                }, error => console.error("Error fetching members: ", error));

                // Real-time listener for transactions data
                getDataCollection('transactions').onSnapshot(snapshot => {
                    transactionsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    // Recalculate payment status based on new transactions
                    calculatePaymentStatus();
                    renderAllUI();
                }, error => console.error("Error fetching transactions: ", error));
            };

            const calculatePaymentStatus = () => {
                paymentStatusData = {};
                const now = new Date();
                const currentYear = now.getFullYear();

                membersData.forEach(member => {
                    paymentStatusData[member.id] = {};
                    for (let i = 0; i < 12; i++) {
                        paymentStatusData[member.id][`${currentYear}-${i}`] = 'Belum Bayar';
                    }
                });

                transactionsData.filter(t => t.type === 'pemasukan' && t.who).forEach(t => {
                    const memberId = t.who;
                    const amount = t.amount;
                    const startMonth = t.paymentPeriodStartMonth;
                    const startYear = t.paymentPeriodStartYear;
                    const endMonth = t.paymentPeriodEndMonth;
                    const endYear = t.paymentPeriodEndYear;

                    // Assuming a flat rate of Rp 10.000 for kas, adjust if needed
                    const monthlyRate = 10000;
                    const totalMonths = (endYear - startYear) * 12 + (endMonth - startMonth) + 1;
                    const paidMonths = Math.floor(amount / monthlyRate);
                    
                    if (paidMonths >= totalMonths) {
                        for (let year = startYear; year <= endYear; year++) {
                            const startM = year === startYear ? startMonth : 0;
                            const endM = year === endYear ? endMonth : 11;
                            for (let i = startM; i <= endM; i++) {
                                paymentStatusData[memberId][`${year}-${i}`] = 'Sudah Bayar';
                            }
                        }
                    } else {
                         // Fallback logic for partial payments
                         // Mark months as paid until the amount is depleted
                        let remainingAmount = amount;
                        for (let year = startYear; year <= endYear; year++) {
                            const startM = year === startYear ? startMonth : 0;
                            const endM = year === endYear ? endMonth : 11;
                            for (let i = startM; i <= endM; i++) {
                                if (remainingAmount >= monthlyRate) {
                                    paymentStatusData[memberId][`${year}-${i}`] = 'Sudah Bayar';
                                    remainingAmount -= monthlyRate;
                                }
                            }
                        }
                    }
                });
            };

            const addTransaction = async (data) => {
                addTransactionSpinner.classList.remove('hidden');
                submitTransactionButton.disabled = true;
                try {
                    await getDataCollection('transactions').add(data);
                    // UI will be updated by the real-time listener
                } catch (error) {
                    console.error("Error adding document: ", error);
                } finally {
                    addTransactionSpinner.classList.add('hidden');
                    submitTransactionButton.disabled = false;
                    closeTransactionModal.click();
                }
            };
            
            const updateTransaction = async (id, data) => {
                addTransactionSpinner.classList.remove('hidden');
                submitTransactionButton.disabled = true;
                try {
                    await getDataCollection('transactions').doc(id).update(data);
                } catch (error) {
                    console.error("Error updating document: ", error);
                } finally {
                    addTransactionSpinner.classList.add('hidden');
                    submitTransactionButton.disabled = false;
                    closeTransactionModal.click();
                }
            };

            const deleteTransaction = async (id) => {
                try {
                    await getDataCollection('transactions').doc(id).delete();
                } catch (error) {
                    console.error("Error removing document: ", error);
                }
            };

            const addMember = async (name) => {
                addMemberSpinner.classList.remove('hidden');
                addMemberButton.disabled = true;
                try {
                    await getDataCollection('members').add({ name: name });
                    newMemberNameInput.value = '';
                } catch (error) {
                    console.error("Error adding member: ", error);
                } finally {
                    addMemberSpinner.classList.add('hidden');
                    addMemberButton.disabled = false;
                }
            };

            const deleteMember = async (id) => {
                try {
                    await getDataCollection('members').doc(id).delete();
                } catch (error) {
                    console.error("Error deleting member: ", error);
                }
            };

            // --- Event Listeners ---
            signInButton.addEventListener('click', async () => {
                const provider = new firebase.auth.GoogleAuthProvider();
                try {
                    await auth.signInWithPopup(provider);
                } catch (error) {
                    console.error("Error during sign-in:", error);
                }
            });

            signOutButton.addEventListener('click', () => {
                auth.signOut();
            });

            tabButtons.forEach(button => {
                button.addEventListener('click', (e) => {
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    e.currentTarget.classList.add('active');

                    Object.values(tabContents).forEach(content => content.classList.add('hidden'));
                    tabContents[e.currentTarget.id].classList.remove('hidden');
                });
            });

            transactionSearchInput.addEventListener('input', renderTransactions);
            transactionTypeFilter.addEventListener('change', renderTransactions);
            transactionMonthFilter.addEventListener('change', renderTransactions);
            transactionYearFilter.addEventListener('change', renderTransactions);
            
            // Event listener for opening the modal
            openTransactionModalBtn.addEventListener('click', () => {
                modalTitle.textContent = "Input Transaksi Baru";
                transactionForm.reset();
                transactionIdInput.value = '';
                // Set default month/year
                const now = new Date();
                paymentPeriodStartMonth.value = now.getMonth();
                paymentPeriodEndMonth.value = now.getMonth();
                paymentPeriodStartYear.value = now.getFullYear();
                paymentPeriodEndYear.value = now.getFullYear();
                transactionModal.classList.remove('hidden');
            });
            
            // Event listener for closing the modal
            closeTransactionModal.addEventListener('click', () => {
                transactionModal.classList.add('hidden');
            });
            
            // Close modal when clicking outside
            window.addEventListener('click', (event) => {
                if (event.target == transactionModal) {
                    transactionModal.classList.add('hidden');
                }
            });
            
            transactionForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const transactionId = transactionIdInput.value;
                const data = {
                    date: transactionDateInput.value,
                    description: transactionDescInput.value,
                    amount: parseFloat(transactionAmountInput.value),
                    type: document.querySelector('input[name="transactionType"]:checked').value,
                    who: transactionWhoSelect.value || null,
                    paymentPeriodStartMonth: parseInt(paymentPeriodStartMonth.value),
                    paymentPeriodEndMonth: parseInt(paymentPeriodEndMonth.value),
                    paymentPeriodStartYear: parseInt(paymentPeriodStartYear.value),
                    paymentPeriodEndYear: parseInt(paymentPeriodEndYear.value),
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                if (transactionId) {
                    await updateTransaction(transactionId, data);
                } else {
                    await addTransaction(data);
                }
                
                // Close modal
                transactionModal.classList.add('hidden');
            });

            document.getElementById('transactionTableBody').addEventListener('click', (e) => {
                const target = e.target.closest('button');
                if (!target) return;

                const transactionId = target.getAttribute('data-id');

                if (target.classList.contains('edit-transaction-btn')) {
                    const transaction = transactionsData.find(t => t.id === transactionId);
                    if (transaction) {
                        modalTitle.textContent = "Edit Transaksi";
                        transactionIdInput.value = transaction.id;
                        transactionDateInput.value = transaction.date;
                        transactionDescInput.value = transaction.description;
                        transactionAmountInput.value = transaction.amount;
                        document.querySelector(`input[name="transactionType"][value="${transaction.type}"]`).checked = true;
                        transactionWhoSelect.value = transaction.who || '';
                        paymentPeriodStartMonth.value = transaction.paymentPeriodStartMonth;
                        paymentPeriodEndMonth.value = transaction.paymentPeriodEndMonth;
                        paymentPeriodStartYear.value = transaction.paymentPeriodStartYear;
                        paymentPeriodEndYear.value = transaction.paymentPeriodEndYear;
                        transactionModal.classList.remove('hidden');
                    }
                }
                
                if (target.classList.contains('delete-transaction-btn')) {
                    showCustomModal(
                        "Konfirmasi Hapus",
                        "Apakah Anda yakin ingin menghapus transaksi ini? Aksi ini tidak dapat dibatalkan.",
                        () => deleteTransaction(transactionId)
                    );
                }
            });

            addMemberButton.addEventListener('click', () => {
                const newMemberName = newMemberNameInput.value.trim();
                if (newMemberName) {
                    addMember(newMemberName);
                }
            });

            document.getElementById('memberTableBody').addEventListener('click', (e) => {
                if (e.target.closest('.delete-member-btn')) {
                    const memberId = e.target.closest('.delete-member-btn').getAttribute('data-id');
                    showCustomModal(
                        "Konfirmasi Hapus Anggota",
                        "Apakah Anda yakin ingin menghapus anggota ini? Semua data transaksi yang terkait akan tetap ada, tetapi tidak akan tertaut ke nama anggota.",
                        () => deleteMember(memberId)
                    );
                }
            });


            // Main authentication state listener
            auth.onAuthStateChanged(user => {
                if (user) {
                    userId = user.uid;
                    authStatus.textContent = `Masuk sebagai: ${user.email}`;
                    signInButton.classList.add('hidden');
                    signOutButton.classList.remove('hidden');
                    appContent.classList.remove('hidden');
                    setupRealtimeListeners();
                } else {
                    userId = 'anon';
                    authStatus.textContent = 'Silakan masuk untuk mengelola data Anda.';
                    signInButton.classList.remove('hidden');
                    signOutButton.classList.add('hidden');
                    appContent.classList.add('hidden');
                    // Clear all data if user signs out
                    membersData = [];
                    transactionsData = [];
                    paymentStatusData = {};
                    renderAllUI();
                }
            });
        });
    </script>
</body>
</html>
