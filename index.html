<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Uang Kas RA Tarbiyatul Aulad</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/jspdf-autotable@3.5.25/dist/jspdf.plugin.autotable.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chosen Palette: Warm Neutrals (Slate, Stone, Amber, with Emerald/Red for status) -->
    <!-- Application Structure Plan: A dashboard-style layout is chosen for optimal usability. It starts with high-level Key Performance Indicators (KPIs) like current balance for a quick overview. This is followed by visual charts (cashflow trend, income vs. expense) to provide deeper context and show performance over time. Finally, a tabbed section offers detailed, granular data (transaction history and payment status) without cluttering the main view. A new section for AI-powered insights has1 been added, allowing users to generate spending analyses and payment reminder drafts using the Gemini API, further enhancing data utility and task automation. New sections for member management and detailed transaction input are added, along with global save/delete options, all powered by Firebase persistence with Google login. -->
    <!-- Visualization & Content Choices:
        - Report Info: Final Saldo -> Goal: Inform -> Viz: KPI Card -> Interaction: None -> Justification: Most critical metric, needs immediate visibility -> Library/Method: HTML/Tailwind.
        - Report Info: Saldo over time -> Goal: Change -> Viz: Line Chart -> Interaction: Hover for tooltip -> Justification: Clearly shows financial health trend -> Library/Method: Chart.js (Canvas).
        - Report Info: Monthly Pemasukan vs. Pengeluaran -> Goal: Compare -> Viz: Bar Chart -> Interaction: Hover for tooltip -> Justification: Easy comparison of monthly financial activity -> Library/Method: Chart.js (Canvas).
        - Report Info: Cashflow log -> Goal: Organize -> Viz: Table -> Interaction: Search, Delete Transaction -> Justification: Allows users to find and manage specific transactions easily -> Library/Method: HTML/Tailwind + JS.
        - Report Info: Member payment status -> Goal: Organize/Compare -> Viz: Table/Grid -> Interaction: Filter by month, Add/Delete Member, **Automatic Payment Status Update based on payer and income transaction** -> Justification: Quick visual check of who has paid, with color-coding for clarity, and full member management, now automated for accuracy with improved input and simplified payment logic -> Library/Method: HTML/Tailwind + JS.
        - Report Info: Spending patterns from cashflow -> Goal: Inform/Analyze -> Viz: AI-generated text summary -> Interaction: Button click with month selection -> Justification: Provides qualitative insights into spending habits beyond raw numbers -> Library/Method: Gemini API (LLM).
        - Report Info: Unpaid members -> Goal: Act/Communicate -> Viz: AI-generated text draft -> Interaction: Button click -> Justification: Automates the creation of polite payment reminders, saving time -> Library/Method: Gemini API (LLM).
        - Report Info: All data persistence -> Goal: Store/Retrieve -> Viz: None -> Interaction: Download JSON, Upload JSON, Clear In-memory Data -> Justification: Essential for long-term data management and portability, now primarily via Firebase. -> Library/Method: Firebase Firestore + File (JSON) via JS Blob/FileReader.
        - Report Info: Detailed Transaction Input -> Goal: Record -> Viz: Form -> Interaction: Input fields, radio buttons, submit button, Payer dropdown -> Justification: Allows granular entry of financial activities with standardized payer selection -> Library/Method: HTML/Tailwind + JS.
    -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* slate-50 */
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            height: 350px;
            max-height: 400px;
        }
        @media (max-width: 768px) {
            .chart-container {
                height: 300px;
            }
        }
        .tab-button.active {
            border-color: #f59e0b; /* amber-500 */
            color: #f59e0b; /* amber-500 */
            font-weight: 600;
        }
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #f59e0b;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-left: 8px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            width: 80%;
            max-width: 500px;
            text-align: center;
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
    </style>
    <!-- Firebase SDKs - V9 Compatibility (for easier integration with existing code structure) -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
</head>
<body class="text-slate-800">

    <div class="container mx-auto p-4 md:p-8">

        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-slate-900">Uang Kas RA Tarbiyatul Aulad</h1>
            <p class="text-slate-500 mt-2">Semangat!</p>
            <!-- Firebase Login/Logout UI -->
            <div class="mt-4 flex flex-col sm:flex-row justify-center items-center gap-4">
                <div id="authStatus" class="text-slate-600 font-medium">Memuat status autentikasi...</div>
                <button id="signInButton" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out hidden">
                    Login dengan Google
                </button>
                <button id="signOutButton" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out hidden">
                    Logout
                </button>
            </div>
        </header>

        <main id="appContent" class="hidden"> <!-- Hidden until user logs in -->
            <!-- Section: Key Metrics -->
            <section id="kpi" class="mb-8">
                 <div class="grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-6">
                    <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                        <h3 class="text-slate-500 font-medium mb-2">Saldo Saat Ini</h3>
                        <p id="currentBalance" class="text-3xl font-bold text-slate-900">Rp 0</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                        <h3 class="text-slate-500 font-medium mb-2">Total Pemasukan</h3>
                        <p id="totalIncome" class="text-3xl font-bold text-emerald-600">Rp 0</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                        <h3 class="text-slate-500 font-medium mb-2">Total Pengeluaran</h3>
                        <p id="totalExpense" class="text-3xl font-bold text-red-600">Rp 0</p>
                    </div>
                </div>
            </section>

            <!-- Section: Visualizations -->
            <section id="visualizations" class="mb-8 grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-white p-4 md:p-6 rounded-xl border border-slate-200 shadow-sm">
                    <h3 class="text-lg font-semibold mb-1 text-slate-900">Tren Arus Kas (Saldo)</h3>
                    <p class="text-sm text-slate-500 mb-4">Grafik ini menunjukkan perubahan saldo kas dari waktu ke waktu, memberikan gambaran tentang kesehatan finansial secara keseluruhan.</p>
                    <div class="chart-container">
                        <canvas id="cashflowChart"></canvas>
                    </div>
                </div>
                <div class="bg-white p-4 md:p-6 rounded-xl border border-slate-200 shadow-sm">
                    <h3 class="text-lg font-semibold mb-1 text-slate-900">Pemasukan vs Pengeluaran Bulanan</h3>
                     <p class="text-sm text-slate-500 mb-4">Bandingkan total pemasukan dan pengeluaran setiap bulan untuk melihat pola aktivitas keuangan.</p>
                    <div class="chart-container">
                        <canvas id="monthlyComparisonChart"></canvas>
                    </div>
                </div>
            </section>

            <!-- Section: Detailed Data -->
            <section id="details" class="mb-8">
                <div class="bg-white rounded-xl border border-slate-200 shadow-sm">
                    <div class="border-b border-slate-200">
                        <nav class="flex space-x-2 p-2" aria-label="Tabs">
                            <button id="tab-transactions" class="tab-button active px-4 py-2 text-sm font-medium text-slate-600 rounded-lg border-b-2 border-transparent hover:text-amber-600 focus:outline-none">
                                Riwayat Transaksi
                            </button>
                            <button id="tab-payments" class="tab-button px-4 py-2 text-sm font-medium text-slate-600 rounded-lg border-b-2 border-transparent hover:text-amber-600 focus:outline-none">
                                Status Pembayaran Anggota
                            </button>
                            <!-- Tab 'Input Transaksi Baru' has been removed and replaced with a button -->
                            <button id="tab-member-management" class="tab-button px-4 py-2 text-sm font-medium text-slate-600 rounded-lg border-b-2 border-transparent hover:text-amber-600 focus:outline-none">
                                Kelola Anggota
                            </button>
                        </nav>
                    </div>

                    <div id="content-transactions" class="p-4 md:p-6">
                        <div class="flex justify-between items-center mb-4">
                            <div class="flex flex-col sm:flex-row gap-2 items-center w-full">
                                <h3 class="text-lg font-semibold text-slate-900 mr-auto">Detail Semua Transaksi</h3>
                                <div class="flex-grow">
                                    <label for="transactionYearFilter" class="sr-only">Filter Tahun</label>
                                    <select id="transactionYearFilter" class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-400 focus:border-amber-400"></select>
                                </div>
                                <div class="flex-grow">
                                    <label for="transactionMonthFilter" class="sr-only">Filter Bulan</label>
                                    <select id="transactionMonthFilter" class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-400 focus:border-amber-400"></select>
                                </div>
                                <div class="flex-grow">
                                    <label for="transactionSearch" class="sr-only">Cari transaksi</label>
                                    <input type="text" id="transactionSearch" placeholder="Cari transaksi..." class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-400 focus:border-amber-400">
                                </div>
                                <button id="addTransactionButton" class="bg-amber-500 hover:bg-amber-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out flex-shrink-0">
                                    Tambah Transaksi Baru
                                </button>
                            </div>
                        </div>

                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-slate-200">
                                <thead class="bg-slate-50">
                                    <tr>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Tanggal</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Keterangan</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Anggota</th>
                                        <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-slate-500 uppercase tracking-wider">Pemasukan</th>
                                        <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-slate-500 uppercase tracking-wider">Pengeluaran</th>
                                        <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-slate-500 uppercase tracking-wider">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="transactionTableBody" class="bg-white divide-y divide-slate-200">
                                    <!-- Rows will be inserted by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div id="content-payments" class="hidden p-4 md:p-6">
                        <h3 class="text-lg font-semibold mb-1 text-slate-900">Status Pembayaran Iuran Kas</h3>
                        <p class="text-sm text-slate-500 mb-4">Berikut adalah status pembayaran iuran kas per bulan untuk setiap anggota.</p>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-slate-200">
                                <thead class="bg-slate-50">
                                    <tr id="paymentTableHeader">
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider sticky left-0 bg-slate-50 z-10">Nama Anggota</th>
                                        <!-- Month headers will be inserted by JavaScript -->
                                    </tr>
                                </thead>
                                <tbody id="paymentTableBody" class="bg-white divide-y divide-slate-200">
                                    <!-- Rows will be inserted by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- 'Input Transaksi Baru' tab content has been moved to a modal -->
                    <div id="content-member-management" class="hidden p-4 md:p-6">
                        <h3 class="text-lg font-semibold mb-1 text-slate-900">Kelola Anggota</h3>
                        <p class="text-sm text-slate-500 mb-4">Tambahkan, edit, atau hapus anggota yang akan membayar uang kas.</p>
                        <div class="mb-4 flex flex-col sm:flex-row gap-2">
                            <input type="text" id="newMemberName" placeholder="Nama Anggota Baru" class="flex-grow p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-400 focus:border-amber-400">
                            <button id="addMemberButton" class="bg-emerald-500 hover:bg-emerald-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out flex items-center justify-center">
                                Tambah Anggota
                                <span id="addMemberSpinner" class="loading-spinner hidden"></span>
                            </button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-slate-200">
                                <thead class="bg-slate-50">
                                    <tr>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Nama Anggota</th>
                                        <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-slate-500 uppercase tracking-wider">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="memberTableBody" class="bg-white divide-y divide-slate-200">
                                    <!-- Rows will be inserted by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Section: AI Insights & Assistance -->
            <section id="ai-insights" class="hidden">
                <!-- This section is hidden as requested -->
            </section>

            <!-- Modal for Transaction Input -->
            <div id="transactionModal" class="modal">
                <div class="modal-content">
                    <span class="close-button" id="closeTransactionModal">&times;</span>
                    <h3 id="modalTitle" class="text-2xl font-bold mb-4 text-slate-900">Input Transaksi Baru</h3>
                    <p class="text-sm text-slate-500 mb-4">Masukkan detail transaksi pemasukan atau pengeluaran baru.</p>
                    <form id="transactionForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input type="hidden" id="transactionId">
                        <div>
                            <label for="transactionDate" class="block text-sm font-medium text-slate-700 text-left">Tanggal</label>
                            <input type="date" id="transactionDate" class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-amber-500 focus:border-amber-500" required>
                        </div>
                        <div>
                            <label for="transactionDesc" class="block text-sm font-medium text-slate-700 text-left">Keterangan</label>
                            <input type="text" id="transactionDesc" placeholder="Contoh: Pembelian buku kas" class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-amber-500 focus:border-amber-500" required>
                        </div>
                        <div>
                            <label for="transactionAmount" class="block text-sm font-medium text-slate-700 text-left">Nominal (Rp)</label>
                            <input type="number" id="transactionAmount" placeholder="Contoh: 50000" class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-amber-500 focus:border-amber-500" required min="0">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 text-left">Jenis Transaksi</label>
                            <div class="mt-1 flex items-center space-x-4">
                                <label class="inline-flex items-center">
                                    <input type="radio" name="transactionType" value="pemasukan" class="form-radio text-emerald-600" checked>
                                    <span class="ml-2 text-slate-700">Pemasukan</span>
                                </label>
                                <label class="inline-flex items-center">
                                    <input type="radio" name="transactionType" value="pengeluaran" class="form-radio text-red-600">
                                    <span class="ml-2 text-slate-700">Pengeluaran</span>
                                </label>
                            </div>
                        </div>
                        <div class="md:col-span-2">
                            <label for="transactionWho" class="block text-sm font-medium text-slate-700 text-left">Penyetor / Pengambil</label>
                            <select id="transactionWho" class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-amber-500 focus:border-amber-500">
                                <option value="">Pilih Anggota (Opsional)</option>
                                <!-- Options will be populated by JavaScript -->
                            </select>
                        </div>
                        <!-- New fields for multi-month payment -->
                        <div class="md:col-span-2">
                            <label for="paymentPeriodStartMonth" class="block text-sm font-medium text-slate-700 text-left">Pembayaran Untuk Bulan (Mulai)</label>
                            <select id="paymentPeriodStartMonth" class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-amber-500 focus:border-amber-500">
                                <option value="">Pilih Bulan (Opsional)</option>
                                <!-- Options will be populated by JavaScript -->
                            </select>
                        </div>
                        <div class="md:col-span-2">
                            <label for="paymentPeriodEndMonth" class="block text-sm font-medium text-slate-700 text-left">Pembayaran Untuk Bulan (Akhir)</label>
                            <select id="paymentPeriodEndMonth" class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-amber-500 focus:border-amber-500">
                                <option value="">Pilih Bulan (Opsional)</option>
                                <!-- Options will be populated by JavaScript -->
                            </select>
                        </div>
                        <!-- End new fields -->
                        <div class="md:col-span-2 flex justify-end">
                            <button type="submit" id="submitTransactionButton" class="bg-amber-500 hover:bg-amber-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out flex items-center">
                                Tambah Transaksi
                                <span id="addTransactionSpinner" class="loading-spinner hidden"></span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>

        </main>
    </div>

    <!-- The Javascript is located here to ensure the DOM is loaded before execution -->
    <script>
        // Global variables for Firebase and App data
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Firebase-related variables
        let app, db, auth;
        let userId;

        // App State Variables
        let members = [];
        let transactions = [];
        let payments = {};
        let monthlyChartInstance, cashflowChartInstance;
        const months = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];

        // DOM elements
        const appContent = document.getElementById('appContent');
        const authStatus = document.getElementById('authStatus');
        const signInButton = document.getElementById('signInButton');
        const signOutButton = document.getElementById('signOutButton');
        const currentBalanceEl = document.getElementById('currentBalance');
        const totalIncomeEl = document.getElementById('totalIncome');
        const totalExpenseEl = document.getElementById('totalExpense');
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('[id^="content-"]');
        const transactionTableBody = document.getElementById('transactionTableBody');
        const paymentTableBody = document.getElementById('paymentTableBody');
        const paymentTableHeader = document.getElementById('paymentTableHeader');
        const memberTableBody = document.getElementById('memberTableBody');
        const newMemberNameInput = document.getElementById('newMemberName');
        const addMemberButton = document.getElementById('addMemberButton');
        const addMemberSpinner = document.getElementById('addMemberSpinner');
        const transactionModal = document.getElementById('transactionModal');
        const addTransactionButton = document.getElementById('addTransactionButton');
        const closeTransactionModal = document.getElementById('closeTransactionModal');
        const transactionForm = document.getElementById('transactionForm');
        const submitTransactionButton = document.getElementById('submitTransactionButton');
        const addTransactionSpinner = document.getElementById('addTransactionSpinner');
        const transactionIdInput = document.getElementById('transactionId');
        const modalTitle = document.getElementById('modalTitle');
        const transactionSearchInput = document.getElementById('transactionSearch');
        const transactionMonthFilter = document.getElementById('transactionMonthFilter');
        const transactionYearFilter = document.getElementById('transactionYearFilter');
        const transactionDateInput = document.getElementById('transactionDate');
        const transactionDescInput = document.getElementById('transactionDesc');
        const transactionAmountInput = document.getElementById('transactionAmount');
        const transactionTypeInputs = document.querySelectorAll('input[name="transactionType"]');
        const transactionWhoSelect = document.getElementById('transactionWho');
        const paymentPeriodStartMonth = document.getElementById('paymentPeriodStartMonth');
        const paymentPeriodEndMonth = document.getElementById('paymentPeriodEndMonth');
        const insightSection = document.getElementById('ai-insights');


        // Initialization of Firebase and Auth
        async function initializeFirebase() {
            try {
                if (firebase.apps.length === 0) {
                    app = firebase.initializeApp(firebaseConfig);
                } else {
                    app = firebase.app();
                }
                auth = app.auth();
                db = app.firestore();

                await new Promise((resolve) => {
                    const unsubscribe = auth.onAuthStateChanged(async (user) => {
                        if (user) {
                            userId = user.uid;
                            console.log("Authenticated with user ID:", userId);
                            authStatus.textContent = `Masuk sebagai: ${user.displayName || user.email}`;
                            signInButton.classList.add('hidden');
                            signOutButton.classList.remove('hidden');
                            appContent.classList.remove('hidden');
                            // Start listening to Firestore data
                            startFirestoreListeners();
                        } else {
                            userId = null;
                            authStatus.textContent = `Anda belum login.`;
                            signInButton.classList.remove('hidden');
                            signOutButton.classList.add('hidden');
                            appContent.classList.add('hidden');
                            console.log("Not authenticated.");
                        }
                        unsubscribe(); // Unsubscribe after the first call
                        resolve();
                    });
                });

                if (initialAuthToken) {
                    await auth.signInWithCustomToken(initialAuthToken);
                } else {
                    await auth.signInAnonymously();
                }
            } catch (error) {
                console.error("Error during Firebase initialization or sign-in:", error);
            }
        }

        // Firestore Listeners
        function startFirestoreListeners() {
            // Member listener
            db.collection(`artifacts/${appId}/users/${userId}/members`).onSnapshot(snapshot => {
                members = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderMemberTable();
                populateMemberDropdowns();
                renderPaymentTable(); // Re-render payment table when members change
            }, err => {
                console.error("Error fetching members:", err);
            });

            // Transaction listener
            db.collection(`artifacts/${appId}/users/${userId}/transactions`).onSnapshot(snapshot => {
                transactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                // Sort transactions by date descending
                transactions.sort((a, b) => new Date(b.date) - new Date(a.date));
                calculateAndRenderKPIs();
                updatePaymentStatus(); // Update payments based on new transactions
                renderAllUI();
            }, err => {
                console.error("Error fetching transactions:", err);
            });
        }

        // UI Rendering Functions
        function renderAllUI() {
            renderTransactionTable();
            renderCharts();
            renderPaymentTable();
        }

        function calculateAndRenderKPIs() {
            let totalIncome = 0;
            let totalExpense = 0;
            transactions.forEach(t => {
                if (t.type === 'pemasukan') {
                    totalIncome += t.amount;
                } else {
                    totalExpense += t.amount;
                }
            });
            const currentBalance = totalIncome - totalExpense;

            currentBalanceEl.textContent = `Rp ${currentBalance.toLocaleString('id-ID')}`;
            totalIncomeEl.textContent = `Rp ${totalIncome.toLocaleString('id-ID')}`;
            totalExpenseEl.textContent = `Rp ${totalExpense.toLocaleString('id-ID')}`;
        }

        function renderTransactionTable() {
            const searchText = transactionSearchInput.value.toLowerCase();
            const selectedMonthIndex = transactionMonthFilter.value;
            const selectedYear = transactionYearFilter.value;

            // Filter transactions
            const filteredTransactions = transactions.filter(t => {
                const transactionDate = new Date(t.date);
                const transactionYear = transactionDate.getFullYear().toString();
                const transactionMonth = transactionDate.getMonth().toString();

                const monthMatch = selectedMonthIndex === "" || transactionMonth === selectedMonthIndex;
                const yearMatch = selectedYear === "" || transactionYear === selectedYear;
                const searchMatch = t.description.toLowerCase().includes(searchText);

                return monthMatch && yearMatch && searchMatch;
            });

            transactionTableBody.innerHTML = '';
            if (filteredTransactions.length === 0) {
                 transactionTableBody.innerHTML = `<tr><td colspan="6" class="p-4 text-center text-slate-500">Tidak ada transaksi ditemukan.</td></tr>`;
                 return;
            }

            filteredTransactions.forEach(t => {
                const memberName = members.find(m => m.id === t.who)?.name || 'Anonim';
                const row = document.createElement('tr');
                row.className = 'hover:bg-slate-50 transition duration-150 ease-in-out';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-900">${t.date}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${t.description}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${memberName}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-right text-emerald-600">${t.type === 'pemasukan' ? `Rp ${t.amount.toLocaleString('id-ID')}` : '-'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-right text-red-600">${t.type === 'pengeluaran' ? `Rp ${t.amount.toLocaleString('id-ID')}` : '-'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button onclick="openEditModal('${t.id}')" class="text-amber-600 hover:text-amber-900 mr-2">Edit</button>
                        <button onclick="deleteTransaction('${t.id}')" class="text-red-600 hover:text-red-900">Hapus</button>
                    </td>
                `;
                transactionTableBody.appendChild(row);
            });
        }

        function updatePaymentStatus() {
            // Reset payments object
            payments = {};

            // Initialize payments object for all members
            members.forEach(member => {
                payments[member.id] = {};
            });

            transactions.forEach(t => {
                if (t.type === 'pemasukan' && t.who && payments[t.who]) {
                    const start = t.paymentPeriodStartMonth ? parseInt(t.paymentPeriodStartMonth) : null;
                    const end = t.paymentPeriodEndMonth ? parseInt(t.paymentPeriodEndMonth) : start;

                    if (start !== null) {
                        for (let i = start; i <= end; i++) {
                            const year = new Date(t.date).getFullYear();
                            const monthKey = `${year}-${i}`;
                            payments[t.who][monthKey] = true;
                        }
                    }
                }
            });

            renderPaymentTable();
        }

        function renderPaymentTable() {
            // Clear existing headers and body
            paymentTableHeader.innerHTML = `<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider sticky left-0 bg-slate-50 z-10">Nama Anggota</th>`;
            paymentTableBody.innerHTML = '';

            const currentYear = new Date().getFullYear();
            const currentMonth = new Date().getMonth();

            // Generate month headers for the current year
            for (let i = 0; i <= currentMonth; i++) {
                const monthName = months[i];
                const th = document.createElement('th');
                th.scope = 'col';
                th.className = 'px-6 py-3 text-center text-xs font-medium text-slate-500 uppercase tracking-wider';
                th.textContent = monthName;
                paymentTableHeader.appendChild(th);
            }

            members.forEach(member => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-slate-50 transition duration-150 ease-in-out';
                row.innerHTML = `<td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-900 sticky left-0 bg-white z-10">${member.name}</td>`;
                
                for (let i = 0; i <= currentMonth; i++) {
                    const monthKey = `${currentYear}-${i}`;
                    const isPaid = payments[member.id] && payments[member.id][monthKey];
                    const cell = document.createElement('td');
                    cell.className = 'px-6 py-4 whitespace-nowrap text-center text-sm';
                    cell.innerHTML = isPaid
                        ? `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-emerald-100 text-emerald-800">Lunas</span>`
                        : `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">Belum</span>`;
                    row.appendChild(cell);
                }
                paymentTableBody.appendChild(row);
            });
        }


        function renderMemberTable() {
            memberTableBody.innerHTML = '';
            members.forEach(m => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-slate-50 transition duration-150 ease-in-out';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-900">${m.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button onclick="deleteMember('${m.id}')" class="text-red-600 hover:text-red-900">Hapus</button>
                    </td>
                `;
                memberTableBody.appendChild(row);
            });
        }

        function populateMemberDropdowns() {
            transactionWhoSelect.innerHTML = '<option value="">Pilih Anggota (Opsional)</option>';
            members.forEach(member => {
                const option = document.createElement('option');
                option.value = member.id;
                option.textContent = member.name;
                transactionWhoSelect.appendChild(option);
            });
        }

        function populateMonthYearFilters() {
            const currentYear = new Date().getFullYear();
            const currentMonth = new Date().getMonth();

            // Populate Year filter
            transactionYearFilter.innerHTML = '<option value="">Semua Tahun</option>';
            for (let i = currentYear; i >= currentYear - 5; i--) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i;
                transactionYearFilter.appendChild(option);
            }
            transactionYearFilter.value = currentYear;

            // Populate Month filter
            transactionMonthFilter.innerHTML = '<option value="">Semua Bulan</option>';
            months.forEach((month, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = month;
                transactionMonthFilter.appendChild(option);
            });
            transactionMonthFilter.value = currentMonth;
        }

        function populatePaymentMonthOptions() {
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            const nextYear = currentYear + 1;

            const monthsWithYears = [];
            for (let i = 0; i < months.length; i++) {
                monthsWithYears.push({ value: `${currentYear}-${i}`, text: `${months[i]} ${currentYear}` });
            }
            for (let i = 0; i < months.length; i++) {
                 monthsWithYears.push({ value: `${nextYear}-${i}`, text: `${months[i]} ${nextYear}` });
            }

            // Populate start month select
            paymentPeriodStartMonth.innerHTML = '<option value="">Pilih Bulan (Opsional)</option>';
            monthsWithYears.forEach(m => {
                const option = document.createElement('option');
                option.value = m.value;
                option.textContent = m.text;
                paymentPeriodStartMonth.appendChild(option);
            });
            paymentPeriodStartMonth.value = `${currentYear}-${currentMonth}`; // Set default

            // Populate end month select
            paymentPeriodEndMonth.innerHTML = '<option value="">Pilih Bulan (Opsional)</option>';
            monthsWithYears.forEach(m => {
                const option = document.createElement('option');
                option.value = m.value;
                option.textContent = m.text;
                paymentPeriodEndMonth.appendChild(option);
            });
            paymentPeriodEndMonth.value = `${currentYear}-${currentMonth}`; // Set default
        }


        function renderCharts() {
            if (monthlyChartInstance) monthlyChartInstance.destroy();
            if (cashflowChartInstance) cashflowChartInstance.destroy();

            const monthlyData = {};
            const monthlyCashflow = {};
            transactions.forEach(t => {
                const date = new Date(t.date);
                const monthYear = `${date.getFullYear()}-${date.getMonth()}`;
                if (!monthlyData[monthYear]) {
                    monthlyData[monthYear] = { income: 0, expense: 0 };
                }
                if (t.type === 'pemasukan') {
                    monthlyData[monthYear].income += t.amount;
                } else {
                    monthlyData[monthYear].expense += t.amount;
                }
            });

            let currentBalance = 0;
            transactions.sort((a, b) => new Date(a.date) - new Date(b.date));
            transactions.forEach(t => {
                if (t.type === 'pemasukan') {
                    currentBalance += t.amount;
                } else {
                    currentBalance -= t.amount;
                }
                const date = t.date;
                monthlyCashflow[date] = currentBalance;
            });


            const chartLabels = Object.keys(monthlyData).sort();
            const incomeData = chartLabels.map(key => monthlyData[key].income);
            const expenseData = chartLabels.map(key => monthlyData[key].expense);
            const chartLabelsFormatted = chartLabels.map(key => {
                const [year, month] = key.split('-');
                return `${months[parseInt(month)]} ${year}`;
            });

            const cashflowLabels = Object.keys(monthlyCashflow).sort();
            const cashflowData = cashflowLabels.map(key => monthlyCashflow[key]);


            // Monthly Comparison Chart
            const ctxMonthly = document.getElementById('monthlyComparisonChart').getContext('2d');
            monthlyChartInstance = new Chart(ctxMonthly, {
                type: 'bar',
                data: {
                    labels: chartLabelsFormatted,
                    datasets: [
                        {
                            label: 'Pemasukan',
                            data: incomeData,
                            backgroundColor: '#10b981', // emerald-500
                            borderRadius: 6,
                        },
                        {
                            label: 'Pengeluaran',
                            data: expenseData,
                            backgroundColor: '#ef4444', // red-500
                            borderRadius: 6,
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });

            // Cashflow Chart
            const ctxCashflow = document.getElementById('cashflowChart').getContext('2d');
            cashflowChartInstance = new Chart(ctxCashflow, {
                type: 'line',
                data: {
                    labels: cashflowLabels,
                    datasets: [{
                        label: 'Saldo',
                        data: cashflowData,
                        borderColor: '#f59e0b', // amber-500
                        tension: 0.1,
                        fill: false,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }


        // CRUD Operations
        async function addMember(name) {
            if (!name.trim()) return;
            addMemberButton.disabled = true;
            addMemberSpinner.classList.remove('hidden');
            try {
                await db.collection(`artifacts/${appId}/users/${userId}/members`).add({ name: name });
                newMemberNameInput.value = '';
            } catch (e) {
                console.error("Error adding member: ", e);
            } finally {
                addMemberButton.disabled = false;
                addMemberSpinner.classList.add('hidden');
            }
        }

        async function deleteMember(id) {
            // In a real app, you'd confirm this action.
            if (!confirm('Apakah Anda yakin ingin menghapus anggota ini? Ini akan menghapus semua data terkait.')) {
                return;
            }
            try {
                // Delete member
                await db.collection(`artifacts/${appId}/users/${userId}/members`).doc(id).delete();
                // Find and delete all related transactions
                const q = db.collection(`artifacts/${appId}/users/${userId}/transactions`).where('who', '==', id);
                const querySnapshot = await q.get();
                const batch = db.batch();
                querySnapshot.forEach((doc) => {
                    batch.delete(doc.ref);
                });
                await batch.commit();
            } catch (e) {
                console.error("Error deleting member and related transactions: ", e);
            }
        }

        async function addOrUpdateTransaction(transactionData, transactionId = null) {
            submitTransactionButton.disabled = true;
            addTransactionSpinner.classList.remove('hidden');

            try {
                if (transactionId) {
                    // Update existing transaction
                    await db.collection(`artifacts/${appId}/users/${userId}/transactions`).doc(transactionId).update(transactionData);
                } else {
                    // Add new transaction
                    await db.collection(`artifacts/${appId}/users/${userId}/transactions`).add(transactionData);
                }
                closeModal('transactionModal');
            } catch (e) {
                console.error("Error adding/updating document: ", e);
            } finally {
                submitTransactionButton.disabled = false;
                addTransactionSpinner.classList.add('hidden');
            }
        }

        async function deleteTransaction(id) {
            // In a real app, you'd confirm this action.
            if (!confirm('Apakah Anda yakin ingin menghapus transaksi ini?')) {
                return;
            }
            try {
                await db.collection(`artifacts/${appId}/users/${userId}/transactions`).doc(id).delete();
            } catch (e) {
                console.error("Error deleting document: ", e);
            }
        }

        // Modal functions
        function showModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function openAddModal() {
            modalTitle.textContent = 'Input Transaksi Baru';
            transactionIdInput.value = '';
            transactionForm.reset();
            // Set default values
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            transactionDateInput.value = `${yyyy}-${mm}-${dd}`;
            
            // Populate month/year options with defaults
            populatePaymentMonthOptions();

            submitTransactionButton.textContent = 'Tambah Transaksi';
            showModal('transactionModal');
        }

        function openEditModal(transactionId) {
            const transaction = transactions.find(t => t.id === transactionId);
            if (!transaction) return;

            modalTitle.textContent = 'Edit Transaksi';
            transactionIdInput.value = transaction.id;
            transactionDateInput.value = transaction.date;
            transactionDescInput.value = transaction.description;
            transactionAmountInput.value = transaction.amount;
            document.querySelector(`input[name="transactionType"][value="${transaction.type}"]`).checked = true;
            transactionWhoSelect.value = transaction.who || '';
            
            // Set payment period fields
            populatePaymentMonthOptions();
            if (transaction.paymentPeriodStartMonth !== undefined) {
                const year = new Date(transaction.date).getFullYear();
                paymentPeriodStartMonth.value = `${year}-${transaction.paymentPeriodStartMonth}`;
            } else {
                 paymentPeriodStartMonth.value = '';
            }
            if (transaction.paymentPeriodEndMonth !== undefined) {
                const year = new Date(transaction.date).getFullYear();
                paymentPeriodEndMonth.value = `${year}-${transaction.paymentPeriodEndMonth}`;
            } else {
                 paymentPeriodEndMonth.value = '';
            }


            submitTransactionButton.textContent = 'Simpan Perubahan';
            showModal('transactionModal');
        }

        // Event Listeners
        window.addEventListener('load', () => {
            initializeFirebase();
            populateMonthYearFilters();
        });

        // Tab switching
        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                tabButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                tabContents.forEach(content => content.classList.add('hidden'));
                document.getElementById(button.id.replace('tab-', 'content-')).classList.remove('hidden');
            });
        });

        // Add/update transaction form submission
        transactionForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const transactionId = transactionIdInput.value;
            const transactionData = {
                date: transactionDateInput.value,
                description: transactionDescInput.value,
                amount: parseFloat(transactionAmountInput.value),
                type: document.querySelector('input[name="transactionType"]:checked').value,
                who: transactionWhoSelect.value || null,
            };

            const startMonthValue = paymentPeriodStartMonth.value;
            const endMonthValue = paymentPeriodEndMonth.value;

            if (startMonthValue) {
                transactionData.paymentPeriodStartMonth = parseInt(startMonthValue.split('-')[1]);
            }
            if (endMonthValue) {
                transactionData.paymentPeriodEndMonth = parseInt(endMonthValue.split('-')[1]);
            }

            await addOrUpdateTransaction(transactionData, transactionId);
        });

        // Add member
        addMemberButton.addEventListener('click', () => {
            addMember(newMemberNameInput.value);
        });

        // Modal open/close
        addTransactionButton.addEventListener('click', openAddModal);
        closeTransactionModal.addEventListener('click', () => closeModal('transactionModal'));
        window.addEventListener('click', (event) => {
            if (event.target === transactionModal) {
                closeModal('transactionModal');
            }
        });

        // Filter and Search event listeners
        transactionMonthFilter.addEventListener('change', renderTransactionTable);
        transactionYearFilter.addEventListener('change', renderTransactionTable);
        transactionSearchInput.addEventListener('keyup', renderTransactionTable);

        // Firebase Auth Listeners
        signInButton.addEventListener('click', async () => {
            const provider = new firebase.auth.GoogleAuthProvider();
            try {
                await firebase.auth().signInWithPopup(provider);
            } catch (error) {
                console.error("Error during Google sign-in:", error);
            }
        });

        signOutButton.addEventListener('click', async () => {
            try {
                await firebase.auth().signOut();
            } catch (error) {
                console.error("Error during sign-out:", error);
            }
        });

    </script>
</body>
</html>
